<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlla - Sistema de Controle de Comparecimento</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚛</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#013A63">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #013A63;
            --secondary-color: #2ECC71;
            --warning-color: #F1C40F;
            --danger-color: #E74C3C;
            --light-bg: #F4F4F4;
            --dark-text: #333333;
            --light-text: #FFFFFF;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--light-text);
            font-family: 'Inter', sans-serif;
            text-transform: lowercase;
        }
        .logo-text::first-letter {
            text-transform: uppercase;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: var(--light-text);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }
        
        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        main {
            padding: 30px 0;
            min-height: calc(100vh - 140px);
        }
        
        .section {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .section.active {
            display: block;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="text"], input[type="file"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text);
        }
        
        .btn-primary:hover {
            background-color: #012a4a;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: var(--light-text);
        }
        
        .btn-success:hover {
            background-color: #25a25a;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-text);
        }
        
        .btn-warning:hover {
            background-color: #d4ac0d;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--light-text);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-outline {
            background-color: white;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .driver-info {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 400;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #ddd;
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: white;
        }
        
        .step-icon.completed {
            background-color: var(--secondary-color);
        }
        
        .step-icon.current {
            background-color: var(--warning-color);
        }
        
        .step-label {
            text-align: center;
            font-size: 0.9rem;
        }
        
        .step-actions {
            margin-top: 10px;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 15px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        
        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: rgba(46, 204, 113, 0.2);
            border-left: 4px solid var(--secondary-color);
        }
        
        .alert-warning {
            background-color: rgba(241, 196, 15, 0.2);
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-danger {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid var(--danger-color);
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(1, 58, 99, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .database-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        footer {
            background-color: var(--primary-color);
            color: var(--light-text);
            text-align: center;
            padding: 15px 0;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .column-filter {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .column-filter:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(1, 58, 99, 0.2);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-controls {
                flex-direction: column;
            }
            
            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline {
                flex-direction: column;
                gap: 20px;
            }
            
            .timeline::before {
                display: none;
            }
            
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th, .data-table td {
                padding: 6px 8px;
            }
        }

        /* ========== FILTROS MODERNOS ========== */
        .filtros-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(1, 58, 99, 0.08);
            border: 1px solid #e2e8f0;
            margin: 20px 0;
            flex-wrap: nowrap;
            overflow-x: auto;
            min-height: 90px;
        }

        .filtro-grupo {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-width: 0;
        }

        .filtro-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filtro-input {
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #334155;
            font-family: 'Inter', sans-serif;
        }

        .filtro-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(1, 58, 99, 0.1);
            background: #fafbfc;
        }

        .filtro-input::placeholder {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .filtro-input:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        /* LARGURAS INDIVIDUAIS */
        .filtro-senha { width: 140px; }
        .filtro-motorista { width: 160px; }
        .filtro-fornecedor { width: 170px; }
        .filtro-status { width: 150px; }
        .filtro-placa { width: 140px; }
        .filtro-chegada { width: 160px; }

        /* RESPONSIVIDADE */
        @media (max-width: 1400px) {
            .filtros-container { gap: 10px; padding: 16px; }
            .filtro-senha { width: 130px; }
            .filtro-motorista { width: 150px; }
            .filtro-fornecedor { width: 160px; }
            .filtro-status { width: 140px; }
            .filtro-placa { width: 130px; }
            .filtro-chegada { width: 150px; }
        }

        @media (max-width: 1200px) {
            .filtros-container { flex-wrap: wrap; gap: 12px; }
            .filtro-grupo { flex: 1; min-width: 180px; }
            .filtro-senha, .filtro-motorista, .filtro-fornecedor,
            .filtro-status, .filtro-placa, .filtro-chegada { width: auto !important; }
        }

        .filtros-container::-webkit-scrollbar {
            height: 6px;
        }

        .filtros-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .filtros-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .filtros-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ========== SEÇÃO RELATÓRIO ========== */
        .report-section {
            padding: 20px;
        }

        .report-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .report-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #d4edda 100%);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .report-info h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .report-stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }

        .report-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .report-table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .report-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .report-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .report-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }

        .report-table tr.completed {
            background-color: rgba(46, 204, 113, 0.1);
        }

        .report-table tr.in-progress {
            background-color: rgba(241, 196, 15, 0.1);
        }

        .report-table tr.pending {
            background-color: rgba(231, 76, 60, 0.05);
        }

        .status-online {
            background-color: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 10px;
        }

        .status-offline {
            background-color: var(--warning-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="https://i.ibb.co/Y4H1km0F/Imagem-Controlla-Sistema-removebg-preview.png" alt="Controlla Logo">
                    </div>
                    <div class="logo-text">Cｏｎｔｒｏｌｌａ <span id="connection-status" class="status-online">Online</span></div>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-target="search-section">🔍 Buscar</a></li>
                        <li><a href="#" class="nav-link" data-target="process-section">📋 Processo</a></li>
                        <li><a href="#" class="nav-link" data-target="encosta-section">🚛 Encosta</a></li>
                        <li><a href="#" class="nav-link" data-target="report-section">📊 Relatório</a></li>
                        <li><a href="#" class="nav-link" data-target="database-section">💾 Base de Dados</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <!-- Seção de Busca -->
            <section id="search-section" class="section active">
                <h1>Buscar Senha do Motorista</h1>
                <form class="search-form" id="search-form">
                    <input type="text" id="ticket-input" placeholder="Digite a senha do motorista (ex: 038685599)" required>
                    <button type="submit" class="btn btn-primary">Buscar Senha</button>
                </form>
                
                <div id="driver-result" style="display: none;">
                    <div class="alert alert-success">Senha localizada com sucesso!</div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="basic-info">Informações Básicas</div>
                        <div class="tab" data-tab="vehicle-info">Veículo e Carga</div>
                        <div class="tab" data-tab="process-info">Processo e Tempos</div>
                    </div>
                    
                    <div class="tab-content active" id="basic-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Senha</span>
                                    <span class="info-value" id="driver-ticket">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Motorista</span>
                                    <span class="info-value" id="driver-name">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fornecedor</span>
                                    <span class="info-value" id="driver-supplier">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">CD</span>
                                    <span class="info-value" id="driver-cd">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data/Hora Agenda</span>
                                    <span class="info-value" id="driver-schedule">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data/Hora Chegada</span>
                                    <span class="info-value" id="driver-arrival">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status</span>
                                    <span class="info-value" id="driver-status">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Acionado</span>
                                    <span class="info-value" id="driver-called">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="vehicle-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Placa Cavalo</span>
                                    <span class="info-value" id="driver-truck-plate">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Placa Carreta</span>
                                    <span class="info-value" id="driver-trailer-plate">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tipo Equipamento</span>
                                    <span class="info-value" id="driver-equipment-type">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Quantidade Equipamentos</span>
                                    <span class="info-value" id="driver-equipment-qty">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Número NF</span>
                                    <span class="info-value" id="driver-nf">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Emissão NF</span>
                                    <span class="info-value" id="driver-nf-emission">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Valor NF</span>
                                    <span class="info-value" id="driver-nf-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Carga</span>
                                    <span class="info-value" id="driver-load">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="process-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Início Conferência</span>
                                    <span class="info-value" id="driver-conf-start">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fim Conferência</span>
                                    <span class="info-value" id="driver-conf-end">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Início Crítica</span>
                                    <span class="info-value" id="driver-crit-start">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fim Crítica</span>
                                    <span class="info-value" id="driver-crit-end">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tempo Crítica</span>
                                    <span class="info-value" id="driver-crit-time">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Hora Liberação</span>
                                    <span class="info-value" id="driver-release">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Galpão CD</span>
                                    <span class="info-value" id="driver-warehouse">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status Processo</span>
                                    <span class="info-value" id="driver-process-status">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="go-to-process">Acompanhar Etapas</button>
                </div>
                
                <div id="driver-not-found" style="display: none;">
                    <div class="alert alert-danger">Senha não encontrada. Verifique o número e tente novamente.</div>
                </div>
            </section>
            
            <!-- Seção de Etapas do Processo -->
            <section id="process-section" class="section">
                <h1>Etapas do Processo</h1>
                <div id="process-content">
                    <div class="alert alert-warning">Selecione uma senha na seção de busca para visualizar as etapas.</div>
                </div>
            </section>
            
            <!-- Seção de Encosta -->
            <section id="encosta-section" class="section">
                <h1>Encosta - Ranking por Horário de Chegada</h1>
                
                <div class="alert alert-info">
                    <strong>Ranking baseado no horário de chegada (coluna G):</strong> Veículos são ordenados pelos que chegaram mais cedo.
                </div>
                
                <div id="encosta-content">
                    <div class="empty-state">
                        <i>🚛</i>
                        <p>Carregando lista de veículos para encosta...</p>
                    </div>
                </div>
            </section>
            
            <!-- Seção de Relatório -->
            <section id="report-section" class="section">
                <h1>📊 Relatório de Processos</h1>
                
                <div class="report-info">
                    <h3>📊 Relatório Completo das Etapas do Processo</h3>
                    <p>Exporte para Excel todos os registros das etapas: Contato Feito, Liberação Entregue e Encostou em Doca.</p>
                </div>
                
                <div class="report-controls">
                    <div class="control-group">
                        <label for="report-start-date">Data Inicial:</label>
                        <input type="date" id="report-start-date" class="filtro-input">
                    </div>
                    <div class="control-group">
                        <label for="report-end-date">Data Final:</label>
                        <input type="date" id="report-end-date" class="filtro-input">
                    </div>
                    <button class="btn btn-primary" id="report-generate">Gerar Relatório</button>
                    <button class="btn btn-success" id="report-export-excel">📥 Exportar para Excel</button>
                    <button class="btn btn-warning" id="report-clear-filters">🔄 Limpar Filtros</button>
                </div>
                
                <div class="report-stats" id="report-stats">
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="total-processes">0</div>
                        <div class="report-stat-label">Total de Processos</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="completed-processes">0</div>
                        <div class="report-stat-label">Processos Concluídos</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="in-progress-processes">0</div>
                        <div class="report-stat-label">Em Andamento</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="pending-processes">0</div>
                        <div class="report-stat-label">Pendentes</div>
                    </div>
                </div>
                
                <div class="report-table-container">
                    <table class="report-table" id="report-table">
                        <thead>
                            <tr>
                                <th>Senha</th>
                                <th>Motorista</th>
                                <th>Fornecedor</th>
                                <th>Contato Feito</th>
                                <th>Liberação Entregue</th>
                                <th>Encostou em Doca</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <i>📋</i>
                                        <p>Clique em "Gerar Relatório" para visualizar os dados</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Seção de Base de Dados -->
            <section id="database-section" class="section">
                <h1>Gerenciamento da Base de Dados</h1>
                
                <div class="database-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-drivers">0</div>
                        <div class="stat-label">Motoristas Cadastrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-suppliers">0</div>
                        <div class="stat-label">Fornecedores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-processes">0</div>
                        <div class="stat-label">Processos Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completed-today">0</div>
                        <div class="stat-label">Finalizados Hoje</div>
                    </div>
                </div>
                
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">📤</div>
                    <h3>Upload da Base de Dados</h3>
                    <p>Arraste um arquivo Excel ou CSV aqui ou clique para selecionar</p>
                    <p class="file-info">Formatos suportados: .xlsx, .xls, .csv</p>
                    <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="btn btn-primary" id="upload-btn">Selecionar Arquivo</button>
                </div>
                
                <div class="alert alert-warning" id="upload-instructions">
                    <strong>Estrutura esperada do arquivo:</strong><br>
                    - Coluna A: SENHA | B: DATA/HORA AGENDA | C: CD | D: FORNECEDOR | E: CARGA<br>
                    - Coluna F: STATUS | G: DATA/HORA CHEG | H: MOTORISTA | I: ACIONADO | J: NF<br>
                    - Coluna K: EMISSÃO | L: VALOR NF | M: PLACA CARRETA | N: PLACA CAVALO<br>
                    - Coluna O: INICIO CONF | P: FIM CONF | Q: INICIO CRIT | R: FIM CRIT<br>
                    - Coluna S: TEMPO CRIT | T: INI DIV COM | U: FIM DIV COM | V: TEMPO DIV COM<br>
                    - Coluna W: INI DIV TRIB | X: FIM DIV TRIB | Y: TEMPO DIV TRIB | Z: QTD EQUIP<br>
                    - Coluna AA: TIPO EQUIP | AB: HORA LIBERAÇÃO | AC: GALPÃO - CD 915<br>
                    - Coluna AD: TIPO RECUSA | AE: SETOR RECUSA | AF: MOTIVO RECUSA<br>
                    - Coluna AG: DETALHE RECUSA | AH: NF PALETES | AI: PEDIDOS NF<br>
                    - Coluna AJ: PEDIDOS C5 | AK: DIVERGÊNCIA DOS PEDIDOS
                </div>
                
                <div id="file-preview" style="display: none;">
                    <h2>Pré-visualização dos Dados</h2>
                    <div class="alert alert-success" id="upload-success"></div>
                    <div id="preview-table-container" style="overflow-x: auto;">
                        <table class="data-table" id="preview-table">
                            <thead>
                                <tr>
                                    <th><input type="text" placeholder="Filtrar Senha" class="column-filter" data-column="0"></th>
                                    <th><input type="text" placeholder="Filtrar Motorista" class="column-filter" data-column="1"></th>
                                    <th><input type="text" placeholder="Filtrar Fornecedor" class="column-filter" data-column="2"></th>
                                    <th><input type="text" placeholder="Filtrar CD" class="column-filter" data-column="3"></th>
                                    <th><input type="text" placeholder="Filtrar Placa" class="column-filter" data-column="4"></th>
                                    <th><input type="text" placeholder="Filtrar Status" class="column-filter" data-column="5"></th>
                                    <th><input type="text" placeholder="Filtrar Chegada" class="column-filter" data-column="6"></th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="preview-table-body">
                                <!-- Dados serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" id="confirm-upload">Confirmar e Salvar no Sistema</button>
                        <button class="btn btn-danger" id="cancel-upload">Cancelar</button>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h2>Motoristas no Sistema</h2>
                    
                    <!-- Botões de controle -->
                    <div class="dashboard-controls">
                        <button class="btn btn-warning" id="reset-drivers-btn">Limpar Todos os Filtros</button>
                        <button class="btn btn-danger" id="clear-database-btn">Limpar Base de Dados</button>
                        <button class="btn btn-outline" id="backup-process-btn">💾 Backup Processos</button>
                        <button class="btn btn-success" id="sync-supabase-btn">🔄 Sincronizar Supabase</button>
                    </div>
                    
                    <!-- Container de Filtros Modernos -->
                    <div class="filtros-container">
                        <div class="filtro-grupo filtro-senha">
                            <label class="filtro-label" for="filter-ticket">Filtrar Senha</label>
                            <input type="text" id="filter-ticket" class="filtro-input" placeholder="Digite a senha...">
                        </div>
                        
                        <div class="filtro-grupo filtro-motorista">
                            <label class="filtro-label" for="filter-driver">Filtrar Motorista</label>
                            <input type="text" id="filter-driver" class="filtro-input" placeholder="Digite o nome...">
                        </div>
                        
                        <div class="filtro-grupo filtro-fornecedor">
                            <label class="filtro-label" for="filter-supplier">Filtrar Fornecedor</label>
                            <input type="text" id="filter-supplier" class="filtro-input" placeholder="Digite o fornecedor...">
                        </div>
                        
                        <div class="filtro-grupo filtro-status">
                            <label class="filtro-label" for="filter-status">Filtrar Status</label>
                            <input type="text" id="filter-status" class="filtro-input" placeholder="Digite o status...">
                        </div>
                        
                        <div class="filtro-grupo filtro-placa">
                            <label class="filtro-label" for="filter-plate">Filtrar Placa</label>
                            <input type="text" id="filter-plate" class="filtro-input" placeholder="Digite a placa...">
                        </div>
                        
                        <div class="filtro-grupo filtro-chegada">
                            <label class="filtro-label" for="filter-arrival">Filtrar Chegada</label>
                            <input type="text" id="filter-arrival" class="filtro-input" placeholder="Digite a data/hora...">
                        </div>
                    </div>
                    
                    <!-- Informações dos resultados -->
                    <div class="results-info" id="results-info" style="
                        margin: 15px 0;
                        padding: 10px 15px;
                        background-color: #e8f4fd;
                        border-radius: var(--border-radius);
                        font-size: 0.9rem;
                        color: var(--primary-color);
                    ">
                        Mostrando todos os registros
                    </div>
                    
                    <!-- Tabela de motoristas -->
                    <div id="drivers-table-container" style="overflow-x: scroll; overflow-y: auto; max-height: 600px; white-space: nowrap;">
                        <table class="data-table" id="drivers-table" style="min-width: 100%;">
                            <thead>
                                <tr>
                                    <th>Senha</th>
                                    <th>Motorista</th>
                                    <th>Fornecedor</th>
                                    <th>CD</th>
                                    <th>Placa</th>
                                    <th>Status</th>
                                    <th>Chegada</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="drivers-table-body">
                                <!-- Dados serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>Cｏｎｔｒｏｌｌａ - Sistema de Controle de Comparecimento &copy; 2025</p>
        </div>
    </footer>

    <script>
        // ========== CONFIGURAÇÃO SUPABASE ========== //
        // ESTAS CONFIGURAÇÕES SERÃO ATUALIZADAS DEPOIS DO DEPLOY
        const SUPABASE_URL = 'https://seu-projeto.supabase.co'; // VOCÊ VAI ATUALIZAR ISSO
        const SUPABASE_ANON_KEY = 'sua-chave-anon-aqui'; // VOCÊ VAI ATUALIZAR ISSO

        // Inicializar Supabase (funciona mesmo sem credenciais válidas)
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : {
            from: () => ({
                select: () => Promise.resolve({ data: null, error: new Error('Supabase não configurado') }),
                upsert: () => Promise.resolve({ data: null, error: new Error('Supabase não configurado') })
            })
        };

        // Estado da aplicação
        let currentDriver = null;
        let driversData = [];
        let suppliersList = [];
        let cdList = [];
        let isOnline = true;
        
        // Mapeamento de colunas
        const columnMapping = {
            'SENHA': 'ticket',
            'DATA/HORA AGENDA': 'scheduleDateTime',
            'CD': 'cd',
            'FORNECEDOR': 'supplier',
            'CARGA': 'load',
            'STATUS': 'status',
            'DATA/HORA CHEG': 'arrivalDateTime',
            'MOTORISTA': 'driverName',
            'ACIONADO': 'called',
            'NF': 'nfNumber',
            'EMISSÃO': 'nfEmission',
            'VALOR NF': 'nfValue',
            'PLACA CARRETA': 'trailerPlate',
            'PLACA CAVALO': 'truckPlate',
            'INICIO CONF': 'confStart',
            'FIM CONF': 'confEnd',
            'INICIO CRIT': 'critStart',
            'FIM CRIT': 'critEnd',
            'TEMPO CRIT': 'critTime',
            'INI DIV COM': 'divComStart',
            'FIM DIV COM': 'divComEnd',
            'TEMPO DIV COM': 'divComTime',
            'INI DIV TRIB': 'divTribStart',
            'FIM DIV TRIB': 'divTribEnd',
            'TEMPO DIV TRIB': 'divTribTime',
            'QTD EQUIP': 'equipmentQty',
            'TIPO EQUIP': 'equipmentType',
            'HORA LIBERAÇÃO': 'releaseTime',
            'GALPÃO - CD 915': 'warehouse',
            'TIPO RECUSA': 'refusalType',
            'SETOR RECUSA': 'refusalSector',
            'MOTIVO RECUSA': 'refusalReason',
            'DETALHE RECUSA': 'refusalDetail',
            'NF PALETES': 'nfPallets',
            'PEDIDOS NF': 'nfOrders',
            'PEDIDOS C5': 'c5Orders',
            'DIVERGÊNCIA DOS PEDIDOS': 'orderDivergence'
        };

        // ========== SISTEMA DE PRESERVAÇÃO DE DADOS ========== //

        // Função para salvar dados de processo separadamente
        function saveProcessData() {
            const processData = {};
            
            driversData.forEach(driver => {
                if (driver.ticket && (
                    driver.contatoFeito !== '-' || 
                    driver.liberacaoEntregue !== '-' || 
                    driver.encostouDoca !== '-'
                )) {
                    processData[driver.ticket] = {
                        contatoFeito: driver.contatoFeito,
                        liberacaoEntregue: driver.liberacaoEntregue,
                        encostouDoca: driver.encostouDoca,
                        lastUpdated: new Date().toISOString()
                    };
                }
            });
            
            localStorage.setItem('processData', JSON.stringify(processData));
            console.log('💾 Dados de processo salvos:', Object.keys(processData).length, 'registros');
        }

        // Função para carregar dados de processo
        function loadProcessData() {
            const savedProcessData = localStorage.getItem('processData');
            if (savedProcessData) {
                try {
                    const processData = JSON.parse(savedProcessData);
                    console.log('📂 Dados de processo carregados:', Object.keys(processData).length, 'registros');
                    return processData;
                } catch (e) {
                    console.error('Erro ao carregar dados de processo:', e);
                    return {};
                }
            }
            return {};
        }

        // ========== SISTEMA SUPABASE (COM FALLBACK) ========== //

        // Função para salvar dados (tenta Supabase, fallback para localStorage)
        async function saveData() {
            console.log('💾 Salvando dados...');
            
            // Sempre salva no localStorage primeiro (mais rápido)
            saveToLocalStorage();
            
            // Tenta salvar no Supabase se estiver configurado
            if (SUPABASE_URL && SUPABASE_URL !== 'https://seu-projeto.supabase.co') {
                try {
                    await saveToSupabase();
                    updateConnectionStatus(true);
                } catch (error) {
                    console.log('📴 Fallback para localStorage');
                    updateConnectionStatus(false);
                }
            }
        }

        // Função para carregar dados (tenta Supabase, fallback para localStorage)
        async function loadData() {
            console.log('📂 Carregando dados...');
            
            // Tenta carregar do Supabase primeiro se estiver configurado
            if (SUPABASE_URL && SUPABASE_URL !== 'https://seu-projeto.supabase.co') {
                try {
                    const success = await loadFromSupabase();
                    if (success) {
                        updateConnectionStatus(true);
                        return true;
                    }
                } catch (error) {
                    console.log('📴 Erro ao carregar do Supabase, usando localStorage');
                }
            }
            
            // Fallback para localStorage
            updateConnectionStatus(false);
            return loadFromLocalStorage();
        }

        // Funções específicas do Supabase
        async function saveToSupabase() {
            if (!SUPABASE_URL || SUPABASE_URL === 'https://seu-projeto.supabase.co') {
                throw new Error('Supabase não configurado');
            }

            for (const driver of driversData) {
                const { error } = await supabase
                    .from('drivers')
                    .upsert({
                        ticket: driver.ticket,
                        driver_name: driver.driverName,
                        supplier: driver.supplier,
                        cd: driver.cd,
                        status: driver.status,
                        arrival_date_time: driver.arrivalDateTime,
                        schedule_date_time: driver.scheduleDateTime,
                        truck_plate: driver.truckPlate,
                        trailer_plate: driver.trailerPlate,
                        contato_feito: driver.contatoFeito !== '-' ? driver.contatoFeito : null,
                        liberacao_entregue: driver.liberacaoEntregue !== '-' ? driver.liberacaoEntregue : null,
                        encostou_doca: driver.encostouDoca !== '-' ? driver.encostouDoca : null,
                        updated_at: new Date().toISOString()
                    }, { 
                        onConflict: 'ticket',
                        ignoreDuplicates: false 
                    });
                
                if (error) {
                    console.error('Erro ao salvar no Supabase:', error);
                    throw error;
                }
            }
            console.log('✅ Dados salvos no Supabase');
            return true;
        }

        async function loadFromSupabase() {
            if (!SUPABASE_URL || SUPABASE_URL === 'https://seu-projeto.supabase.co') {
                throw new Error('Supabase não configurado');
            }

            const { data, error } = await supabase
                .from('drivers')
                .select('*')
                .order('updated_at', { ascending: false });

            if (error) throw error;

            if (data && data.length > 0) {
                driversData = data.map(item => ({
                    ticket: item.ticket,
                    driverName: item.driver_name,
                    supplier: item.supplier,
                    cd: item.cd,
                    status: item.status,
                    arrivalDateTime: item.arrival_date_time,
                    scheduleDateTime: item.schedule_date_time,
                    truckPlate: item.truck_plate,
                    trailerPlate: item.trailer_plate,
                    contatoFeito: item.contato_feito || '-',
                    liberacaoEntregue: item.liberacao_entregue || '-',
                    encostouDoca: item.encostou_doca || '-'
                }));

                console.log('📂 Dados carregados do Supabase:', driversData.length, 'registros');
                return true;
            }
            return false;
        }

        // Funções de fallback (localStorage)
        function saveToLocalStorage() {
            localStorage.setItem('driversData', JSON.stringify(driversData));
            localStorage.setItem('suppliersList', JSON.stringify(suppliersList));
            localStorage.setItem('cdList', JSON.stringify(cdList));
            console.log('💾 Dados salvos no localStorage');
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('driversData');
            if (savedData) {
                driversData = JSON.parse(savedData);
                console.log('📂 Dados carregados do localStorage:', driversData.length, 'registros');
                return true;
            }
            return false;
        }

        // Atualizar status da conexão
        function updateConnectionStatus(online) {
            isOnline = online;
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                statusElement.textContent = online ? 'Online' : 'Offline';
                statusElement.className = online ? 'status-online' : 'status-offline';
            }
        }

        // ========== FUNÇÃO initializeData ATUALIZADA ========== //
        async function initializeData() {
            console.log('=== INICIANDO SISTEMA CONTROLLA ===');
            
            // Tentar carregar dados
            const hasData = await loadData();
            
            // Se não há dados em nenhum lugar, criar exemplos
            if (!hasData || driversData.length === 0) {
                console.log('Criando dados de exemplo...');
                createSampleData();
                await saveData();
            }

            // Carregar e aplicar dados de processo
            const processData = loadProcessData();
            let restoredCount = 0;

            driversData.forEach(driver => {
                if (driver.ticket && processData[driver.ticket]) {
                    const savedProcess = processData[driver.ticket];
                    driver.contatoFeito = savedProcess.contatoFeito;
                    driver.liberacaoEntregue = savedProcess.liberacaoEntregue;
                    driver.encostouDoca = savedProcess.encostouDoca;
                    restoredCount++;
                }
            });

            console.log('🔄 Dados de processo aplicados:', restoredCount, 'registros');
            
            updateDatabaseStats();
            renderDriversTable();
            setupEventListeners();
            
            console.log('✅ Sistema inicializado com sucesso!');
        }

        // ========== CONFIGURAÇÃO DE EVENT LISTENERS ========== //
        function setupEventListeners() {
            // Navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    showSection(target);
                });
            });
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            // Busca de senha
            document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const ticket = document.getElementById('ticket-input').value.trim();
                if (ticket) searchDriver(ticket);
            });
            
            // Botão para ir para etapas
            document.getElementById('go-to-process').addEventListener('click', function() {
                showSection('process-section');
                renderProcessTimeline();
            });
            
            // Relatório
            document.getElementById('report-generate').addEventListener('click', generateReport);
            document.getElementById('report-export-excel').addEventListener('click', exportReportToExcel);
            document.getElementById('report-clear-filters').addEventListener('click', clearReportFilters);
            
            // Upload de arquivo
            document.getElementById('upload-btn').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            
            // Backup e sincronização
            document.getElementById('backup-process-btn').addEventListener('click', backupProcessData);
            document.getElementById('sync-supabase-btn').addEventListener('click', async function() {
                this.disabled = true;
                this.innerHTML = '⏳ Sincronizando...';
                try {
                    await saveData();
                    alert('✅ Sincronização concluída!');
                } catch (error) {
                    alert('❌ Erro na sincronização: ' + error.message);
                } finally {
                    this.disabled = false;
                    this.innerHTML = '🔄 Sincronizar Supabase';
                }
            });
            
            // Drag and drop
            const uploadArea = document.getElementById('upload-area');
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) handleFile(files[0]);
            });
            
            // Confirmação de upload
            document.getElementById('confirm-upload').addEventListener('click', confirmUpload);
            document.getElementById('cancel-upload').addEventListener('click', cancelUpload);
            
            // Filtros
            document.getElementById('reset-drivers-btn').addEventListener('click', function() {
                document.querySelectorAll('.filtro-input').forEach(input => input.value = '');
                renderDriversTable();
            });
            
            document.getElementById('clear-database-btn').addEventListener('click', clearDatabase);
            setupColumnFilters();
            setupFilterListeners();
        }

        // ========== FUNÇÃO registerProcessStep ATUALIZADA ========== //
        async function registerProcessStep(ticket, stepField) {
            console.log('=== REGISTRAR ETAPA ===');
            
            if (!currentDriver) {
                currentDriver = driversData.find(d => d.ticket === ticket);
            }
            
            if (!currentDriver) {
                currentDriver = {
                    ticket: ticket,
                    driverName: 'Motorista Não Cadastrado',
                    contatoFeito: '-',
                    liberacaoEntregue: '-',
                    encostouDoca: '-'
                };
            }
            
            // Garantir propriedades
            if (!currentDriver.hasOwnProperty('contatoFeito')) currentDriver.contatoFeito = '-';
            if (!currentDriver.hasOwnProperty('liberacaoEntregue')) currentDriver.liberacaoEntregue = '-';
            if (!currentDriver.hasOwnProperty('encostouDoca')) currentDriver.encostouDoca = '-';
            
            // Registrar data/hora
            const now = new Date();
            const formattedDateTime = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // Registrar etapa
            currentDriver[stepField] = formattedDateTime;
            
            // Adicionar à base se necessário
            if (!driversData.find(d => d.ticket === currentDriver.ticket)) {
                driversData.push(currentDriver);
            }
            
            // SALVAR DADOS (localStorage + Supabase)
            saveProcessData();
            await saveData();
            
            // Atualizar interface
            displayDriverInfo(currentDriver);
            renderProcessTimeline();
            
            // Mensagem
            const stepName = getStepName(stepField);
            alert(`✅ ${stepName} registrado com sucesso!\nData: ${formattedDateTime}\n\n📋 Registro preservado em nuvem.`);
        }

        // ========== FUNÇÃO confirmUpload ATUALIZADA ========== //
        async function confirmUpload() {
            if (!window.uploadData) return;
            
            const { headers, rows } = window.uploadData;
            const newDrivers = [];
            const newSuppliers = new Set();
            const newCDs = new Set();
            
            // Carregar dados de processo existentes
            const processData = loadProcessData();
            
            rows.forEach((row) => {
                const driver = {};
                
                // Mapear colunas
                headers.forEach((header, colIndex) => {
                    if (header && columnMapping[header]) {
                        driver[columnMapping[header]] = row[colIndex];
                    }
                });
                
                if (driver.ticket) {
                    // Preservar dados de processo
                    if (processData[driver.ticket]) {
                        const savedProcess = processData[driver.ticket];
                        driver.contatoFeito = savedProcess.contatoFeito;
                        driver.liberacaoEntregue = savedProcess.liberacaoEntregue;
                        driver.encostouDoca = savedProcess.encostouDoca;
                    } else {
                        // Inicializar campos
                        if (!driver.hasOwnProperty('contatoFeito')) driver.contatoFeito = '-';
                        if (!driver.hasOwnProperty('liberacaoEntregue')) driver.liberacaoEntregue = '-';
                        if (!driver.hasOwnProperty('encostouDoca')) driver.encostouDoca = '-';
                    }
                    
                    newDrivers.push(driver);
                    if (driver.supplier) newSuppliers.add(driver.supplier);
                    if (driver.cd) newCDs.add(driver.cd);
                }
            });
            
            driversData = newDrivers;
            suppliersList = Array.from(newSuppliers);
            cdList = Array.from(newCDs);
            
            // SALVAR NOVOS DADOS
            saveProcessData();
            await saveData();
            
            updateDatabaseStats();
            renderDriversTable();
            cancelUpload();
            
            alert(`✅ Upload concluído! \n${newDrivers.length} registros carregados\n${Object.keys(processData).length} processos preservados`);
        }

        // ========== FUNÇÕES RESTANTES (MANTIDAS) ========== //
        // [Todas as outras funções permanecem EXATAMENTE como estavam]
        // searchDriver, displayDriverInfo, renderProcessTimeline, getStepName,
        // generateReport, exportReportToExcel, clearReportFilters, updateDatabaseStats,
        // renderDriversTable, deleteDriver, clearDatabase, handleFileUpload, handleFile,
        // previewData, cancelUpload, formatDateTime, formatDateTimeWithExtraMinute,
        // formatDateTimeWithExtraMinuteForCalled, calculateWaitTime, renderEncostaList,
        // createSampleData, etc...

        // Função para backup de dados de processo
        function backupProcessData() {
            const processData = loadProcessData();
            const dataStr = JSON.stringify(processData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_processos_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert(`📦 Backup exportado!\n${Object.keys(processData).length} registros.`);
        }

        // Função auxiliar para obter o nome da etapa
        function getStepName(stepField) {
            const stepNames = {
                'contatoFeito': 'Contato Feito',
                'liberacaoEntregue': 'Liberação Entregue',
                'encostouDoca': 'Encostou em Doca'
            };
            return stepNames[stepField] || stepField;
        }

        // Mostrar seção
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`[data-target="${sectionId}"]`).classList.add('active');
            
            if (sectionId === 'report-section') generateReport();
            else if (sectionId === 'encosta-section') renderEncostaList();
        }

        // Mostrar tab
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Buscar motorista
        function searchDriver(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (driver) {
                currentDriver = driver;
                displayDriverInfo(driver);
                document.getElementById('driver-result').style.display = 'block';
                document.getElementById('driver-not-found').style.display = 'none';
            } else {
                document.getElementById('driver-result').style.display = 'none';
                document.getElementById('driver-not-found').style.display = 'block';
            }
        }

        // Exibir informações do motorista
        function displayDriverInfo(driver) {
            // Informações básicas
            document.getElementById('driver-ticket').textContent = driver.ticket || '-';
            document.getElementById('driver-name').textContent = driver.driverName || '-';
            document.getElementById('driver-supplier').textContent = driver.supplier || '-';
            document.getElementById('driver-cd').textContent = driver.cd || '-';
            document.getElementById('driver-schedule').textContent = formatDateTimeWithExtraMinute(driver.scheduleDateTime) || '-';
            document.getElementById('driver-arrival').textContent = formatDateTime(driver.arrivalDateTime) || '-';
            document.getElementById('driver-status').textContent = driver.status || '-';
            document.getElementById('driver-called').textContent = formatDateTimeWithExtraMinuteForCalled(driver.called) || '-';
            
            // Veículo e carga
            document.getElementById('driver-truck-plate').textContent = driver.truckPlate || '-';
            document.getElementById('driver-trailer-plate').textContent = driver.trailerPlate || '-';
            document.getElementById('driver-equipment-type').textContent = driver.equipmentType || '-';
            document.getElementById('driver-equipment-qty').textContent = driver.equipmentQty || '-';
            document.getElementById('driver-nf').textContent = driver.nfNumber || '-';
            document.getElementById('driver-nf-emission').textContent = formatDateTime(driver.nfEmission) || '-';
            document.getElementById('driver-nf-value').textContent = driver.nfValue || '-';
            document.getElementById('driver-load').textContent = driver.load || '-';
            
            // Processo e tempos
            document.getElementById('driver-conf-start').textContent = formatDateTime(driver.confStart) || '-';
            document.getElementById('driver-conf-end').textContent = formatDateTime(driver.confEnd) || '-';
            document.getElementById('driver-crit-start').textContent = formatDateTime(driver.critStart) || '-';
            document.getElementById('driver-crit-end').textContent = formatDateTime(driver.critEnd) || '-';
            document.getElementById('driver-crit-time').textContent = driver.critTime || '-';
            document.getElementById('driver-release').textContent = formatDateTime(driver.releaseTime) || '-';
            document.getElementById('driver-warehouse').textContent = driver.warehouse || '-';
            document.getElementById('driver-process-status').textContent = getProcessStatus(driver) || '-';
        }

        // Obter status do processo
        function getProcessStatus(driver) {
            if (driver.encostouDoca && driver.encostouDoca !== '-') return 'Encostou em Doca';
            if (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') return 'Liberação Entregue';
            if (driver.contatoFeito && driver.contatoFeito !== '-') return 'Contato Feito';
            return 'Aguardando Contato';
        }

        // Renderizar timeline do processo
        function renderProcessTimeline() {
            if (!currentDriver) return;
            
            const processContent = document.getElementById('process-content');
            const steps = [
                { 
                    id: 'contato', 
                    label: 'Contato Feito', 
                    time: currentDriver.contatoFeito || '-', 
                    completed: !!currentDriver.contatoFeito && currentDriver.contatoFeito !== '-',
                    field: 'contatoFeito',
                    buttonText: 'Registrar Contato Feito'
                },
                { 
                    id: 'liberacao', 
                    label: 'Liberação Entregue', 
                    time: currentDriver.liberacaoEntregue || '-', 
                    completed: !!currentDriver.liberacaoEntregue && currentDriver.liberacaoEntregue !== '-',
                    field: 'liberacaoEntregue',
                    buttonText: 'Registrar Liberação Entregue'
                },
                { 
                    id: 'doca', 
                    label: 'Encostou em Doca', 
                    time: currentDriver.encostouDoca || '-', 
                    completed: !!currentDriver.encostouDoca && currentDriver.encostouDoca !== '-',
                    field: 'encostouDoca',
                    buttonText: 'Registrar Encostou em Doca'
                }
            ];
            
            let nextStepIndex = steps.findIndex(step => !step.completed);
            if (nextStepIndex === -1) nextStepIndex = steps.length;
            
            let timelineHTML = `
                <div class="driver-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Senha</span>
                            <span class="info-value">${currentDriver.ticket}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Motorista</span>
                            <span class="info-value">${currentDriver.driverName}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status Atual</span>
                            <span class="info-value">${getProcessStatus(currentDriver)}</span>
                        </div>
                    </div>
                </div>
                <div class="timeline">
            `;
            
            steps.forEach((step, index) => {
                let stepClass = step.completed ? 'completed' : (index === nextStepIndex ? 'current' : '');
                
                timelineHTML += `
                    <div class="timeline-step">
                        <div class="step-icon ${stepClass}">${index + 1}</div>
                        <div class="step-label">${step.label}</div>
                        <div class="step-time">${step.time}</div>
                        <div class="step-actions">
                `;
                
                if (index === nextStepIndex) {
                    timelineHTML += `
                            <button class="btn btn-success btn-small register-step" 
                                    data-step="${step.field}" 
                                    data-ticket="${currentDriver.ticket}">
                                ${step.buttonText}
                            </button>
                    `;
                }
                
                timelineHTML += `</div></div>`;
            });
            
            timelineHTML += `</div>`;
            
            if (nextStepIndex === steps.length) {
                timelineHTML += `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <strong>✅ Processo Concluído!</strong> Todas as etapas foram registradas.
                    </div>
                `;
            }
            
            processContent.innerHTML = timelineHTML;
            
            document.querySelectorAll('.register-step').forEach(btn => {
                btn.addEventListener('click', function() {
                    const stepField = this.getAttribute('data-step');
                    if (currentDriver && currentDriver.ticket) {
                        registerProcessStep(currentDriver.ticket, stepField);
                    } else {
                        const ticket = this.getAttribute('data-ticket');
                        registerProcessStep(ticket, stepField);
                    }
                });
            });
        }

        // [CONTINUA... Todas as outras funções do sistema]
        // Por questão de espaço, mantive apenas as funções principais atualizadas
        // As demais funções (generateReport, renderDriversTable, etc) permanecem IGUAIS

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
        });

    </script>
</body>
</html>