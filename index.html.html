<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlla - Sistema de Controle de Comparecimento</title>
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta name="theme-color" content="#013A63">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #013A63;
            --secondary-color: #2ECC71;
            --warning-color: #F1C40F;
            --danger-color: #E74C3C;
            --light-bg: #F4F4F4;
            --dark-text: #333333;
            --light-text: #FFFFFF;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--light-text);
            font-family: 'Inter', sans-serif;
            text-transform: lowercase;
        }
        .logo-text::first-letter {
            text-transform: uppercase;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: var(--light-text);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }
        
        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        main {
            padding: 30px 0;
            min-height: calc(100vh - 140px);
        }
        
        .section {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .section.active {
            display: block;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="text"], input[type="file"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text);
        }
        
        .btn-primary:hover {
            background-color: #012a4a;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: var(--light-text);
        }
        
        .btn-success:hover {
            background-color: #25a25a;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-text);
        }
        
        .btn-warning:hover {
            background-color: #d4ac0d;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--light-text);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-outline {
            background-color: white;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .driver-info {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 400;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #ddd;
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: white;
        }
        
        .step-icon.completed {
            background-color: var(--secondary-color);
        }
        
        .step-icon.current {
            background-color: var(--warning-color);
        }
        
        .step-label {
            text-align: center;
            font-size: 0.9rem;
        }
        
        .step-actions {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 15px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        
        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: rgba(46, 204, 113, 0.2);
            border-left: 4px solid var(--secondary-color);
        }
        
        .alert-warning {
            background-color: rgba(241, 196, 15, 0.2);
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-danger {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid var(--danger-color);
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(1, 58, 99, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .database-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        footer {
            background-color: var(--primary-color);
            color: var(--light-text);
            text-align: center;
            padding: 15px 0;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .column-filter {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .column-filter:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(1, 58, 99, 0.2);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-controls {
                flex-direction: column;
            }
            
            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline {
                flex-direction: column;
                gap: 20px;
            }
            
            .timeline::before {
                display: none;
            }
            
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th, .data-table td {
                padding: 6px 8px;
            }
        }

        /* ========== FILTROS MODERNOS ========== */
        .filtros-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(1, 58, 99, 0.08);
            border: 1px solid #e2e8f0;
            margin: 20px 0;
            flex-wrap: nowrap;
            overflow-x: auto;
            min-height: 90px;
        }

        .filtro-grupo {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-width: 0;
        }

        .filtro-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filtro-input {
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #334155;
            font-family: 'Inter', sans-serif;
        }

        .filtro-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(1, 58, 99, 0.1);
            background: #fafbfc;
        }

        .filtro-input::placeholder {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .filtro-input:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        /* LARGURAS INDIVIDUAIS */
        .filtro-senha { width: 140px; }
        .filtro-motorista { width: 160px; }
        .filtro-fornecedor { width: 170px; }
        .filtro-status { width: 150px; }
        .filtro-placa { width: 140px; }
        .filtro-chegada { width: 160px; }

        /* RESPONSIVIDADE */
        @media (max-width: 1400px) {
            .filtros-container { gap: 10px; padding: 16px; }
            .filtro-senha { width: 130px; }
            .filtro-motorista { width: 150px; }
            .filtro-fornecedor { width: 160px; }
            .filtro-status { width: 140px; }
            .filtro-placa { width: 130px; }
            .filtro-chegada { width: 150px; }
        }

        @media (max-width: 1200px) {
            .filtros-container { flex-wrap: wrap; gap: 12px; }
            .filtro-grupo { flex: 1; min-width: 180px; }
            .filtro-senha, .filtro-motorista, .filtro-fornecedor,
            .filtro-status, .filtro-placa, .filtro-chegada { width: auto !important; }
        }

        .filtros-container::-webkit-scrollbar {
            height: 6px;
        }

        .filtros-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .filtros-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .filtros-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ========== SEÇÃO RELATÓRIO ========== */
        .report-section {
            padding: 20px;
        }

        .report-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .report-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #d4edda 100%);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .report-info h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .report-stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }

        .report-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .report-table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .report-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .report-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .report-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }

        .report-table tr.completed {
            background-color: rgba(46, 204, 113, 0.1);
        }

        .report-table tr.in-progress {
            background-color: rgba(241, 196, 15, 0.1);
        }

        .report-table tr.pending {
            background-color: rgba(231, 76, 60, 0.05);
        }

        .status-online {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 10px;
        }

        /* ========== NOVOS ESTILOS PARA STATUS DE CARGA ========== */
        .status-gerada {
            background-color: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-pendente {
            background-color: var(--warning-color);
            color: var(--dark-text);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .carga-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .carga-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%);
            border-left: 4px solid var(--primary-color);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* ========== ESTILOS PARA BOTÕES DA ENCOSTA ========== */
        .processo-encosta {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .processo-encosta:hover {
            background-color: #012a4a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ========== NOVO ESTILO PARA STATUS DO PROCESSO ========== */
        .status-processo {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            min-width: 120px;
        }

        .status-aguardando {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .status-contato {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-liberacao {
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .status-doca {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* ========== ANIMAÇÕES PARA ATUALIZAÇÃO AUTOMÁTICA ========== */
        @keyframes highlightUpdate {
            0% { background-color: rgba(46, 204, 113, 0.1); }
            100% { background-color: transparent; }
        }

        .updated-row {
            animation: highlightUpdate 1.5s ease-in-out;
        }

        /* ========== ESTILOS OCULTOS ========== */
        .hidden-controls {
            display: none !important;
        }

        /* ========== NOVOS ESTILOS PARA SISTEMA DE PERSISTÊNCIA ========== */
        .auto-save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .auto-save-status.saving {
            background-color: var(--warning-color);
            color: var(--dark-text);
        }

        .auto-save-status.saved {
            background-color: var(--secondary-color);
            color: white;
        }

        .auto-save-status.error {
            background-color: var(--danger-color);
            color: white;
        }

        /* ========== NOVOS ESTILOS PARA NOTIFICAÇÃO MINIMALISTA ========== */
        .notification-minimal {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.4;
            border-left: 4px solid;
            background: white;
        }

        .notification-minimal.success {
            border-left-color: var(--secondary-color);
            color: #155724;
            background: #f8fff9;
        }

        .notification-minimal.error {
            border-left-color: var(--danger-color);
            color: #721c24;
            background: #fdf3f4;
        }

        .notification-minimal.info {
            border-left-color: var(--primary-color);
            color: #004085;
            background: #f0f8ff;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="https://i.ibb.co/Y4H1km0F/Imagem-Controlla-Sistema-removebg-preview.png" alt="Controlla Logo">
                    </div>
                    <div class="logo-text">Cｏｎｔｒｏｌｌａ</div>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-target="search-section">🔍 Buscar</a></li>
                        <li><a href="#" class="nav-link" data-target="process-section">📋 Processo</a></li>
                        <li><a href="#" class="nav-link" data-target="encosta-section">🚛 Encosta</a></li>
                        <li><a href="#" class="nav-link" data-target="report-section">📊 Relatório</a></li>
                        <li><a href="#" class="nav-link" data-target="database-section">💾 Base de Dados</a></li>
                    </ul>
                </nav>
                <div id="sync-status" class="hidden-controls">
                    <span>🟢 Online</span>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <!-- Seção de Busca -->
            <section id="search-section" class="section active">
                <h1>Buscar Senha do Motorista</h1>
                <form class="search-form" id="search-form">
                    <input type="text" id="ticket-input" placeholder="Digite a senha do motorista (ex: 038685599)" required>
                    <button type="submit" class="btn btn-primary">Buscar Senha</button>
                </form>
                
                <div id="driver-result" style="display: none;">
                    <div class="alert alert-success">Senha localizada com sucesso!</div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="basic-info">Informações Básicas</div>
                        <div class="tab" data-tab="vehicle-info">Veículo e Carga</div>
                        <div class="tab" data-tab="process-info">Processo e Tempos</div>
                    </div>
                    
                    <div class="tab-content active" id="basic-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Senha</span>
                                    <span class="info-value" id="driver-ticket">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Motorista</span>
                                    <span class="info-value" id="driver-name">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fornecedor</span>
                                    <span class="info-value" id="driver-supplier">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">CD</span>
                                    <span class="info-value" id="driver-cd">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data/Hora Agenda</span>
                                    <span class="info-value" id="driver-schedule">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data/Hora Chegada</span>
                                    <span class="info-value" id="driver-arrival">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status</span>
                                    <span class="info-value" id="driver-status">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Acionado</span>
                                    <span class="info-value" id="driver-called">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="vehicle-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Placa Cavalo</span>
                                    <span class="info-value" id="driver-truck-plate">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Placa Carreta</span>
                                    <span class="info-value" id="driver-trailer-plate">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tipo Equipamento</span>
                                    <span class="info-value" id="driver-equipment-type">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Quantidade Equipamentos</span>
                                    <span class="info-value" id="driver-equipment-qty">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Número NF</span>
                                    <span class="info-value" id="driver-nf">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Emissão NF</span>
                                    <span class="info-value" id="driver-nf-emission">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Valor NF</span>
                                    <span class="info-value" id="driver-nf-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Carga</span>
                                    <span class="info-value" id="driver-load">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="process-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Início Conferência</span>
                                    <span class="info-value" id="driver-conf-start">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fim Conferência</span>
                                    <span class="info-value" id="driver-conf-end">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Início Crítica</span>
                                    <span class="info-value" id="driver-crit-start">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fim Crítica</span>
                                    <span class="info-value" id="driver-crit-end">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tempo Crítica</span>
                                    <span class="info-value" id="driver-crit-time">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Hora Liberação</span>
                                    <span class="info-value" id="driver-release">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Galpão CD</span>
                                    <span class="info-value" id="driver-warehouse">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status Processo</span>
                                    <span class="info-value" id="driver-process-status">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="go-to-process">Acompanhar Etapas</button>
                </div>
                
                <div id="driver-not-found" style="display: none;">
                    <div class="alert alert-danger">Senha não encontrada. Verifique o número e tente novamente.</div>
                </div>
            </section>
            
            <!-- Seção de Etapas do Processo -->
            <section id="process-section" class="section">
                <h1>Etapas do Processo</h1>
                <div id="process-content">
                    <div class="alert alert-warning">Selecione uma senha na seção de busca para visualizar as etapas.</div>
                </div>
            </section>
            
            <!-- Seção de Encosta -->
            <section id="encosta-section" class="section">
                <h1>Encosta - Ranking por Horário de Chegada</h1>
                
                <div class="carga-info">
                    <strong>📋 Status de Carga:</strong> O sistema verifica automaticamente se a carga está gerada no arquivo TXT.
                    <br><strong>🔄 Atualização:</strong> Carregue um novo arquivo TXT para atualizar os status.
                </div>
                
                <div class="carga-controls">
                    <input type="file" id="carga-file-input" class="file-input" accept=".txt" style="display: none;">
                    <button class="btn btn-primary" id="upload-carga-btn">📁 Carregar Arquivo de Carga (TXT)</button>
                    <button class="btn btn-success" id="refresh-carga-btn">🔄 Atualizar Status</button>
                    <button class="btn btn-warning" id="debug-carga-btn">🐛 Debug Carga</button>
                    <span id="carga-file-info" style="font-size: 0.9rem; color: #666; margin-left: 10px;">
                        Nenhum arquivo carregado
                    </span>
                </div>
                
                <div class="alert alert-info">
                    <strong>Ranking baseado no horário de chegada (coluna G):</strong> Veículos são ordenados pelos que chegaram mais cedo.
                </div>
                
                <div id="encosta-content">
                    <div class="empty-state">
                        <div>🚛</div>
                        <p>Carregando lista de veículos para encosta...</p>
                    </div>
                </div>
            </section>
            
            <!-- Seção de Relatório -->
            <section id="report-section" class="section">
                <h1>📊 Relatório de Processos</h1>
                
                <div class="report-info">
                    <h3>📊 Relatório Completo das Etapas do Processo</h3>
                    <p>Exporte para Excel todos os registros das etapas: Contato Feito, Liberação Entregue e Encostou em Doca.</p>
                </div>
                
                <div class="report-controls">
                    <div class="control-group">
                        <label for="report-start-date">Data Inicial:</label>
                        <input type="date" id="report-start-date" class="filtro-input">
                    </div>
                    <div class="control-group">
                        <label for="report-end-date">Data Final:</label>
                        <input type="date" id="report-end-date" class="filtro-input">
                    </div>
                    <button class="btn btn-primary" id="report-generate">Gerar Relatório</button>
                    <button class="btn btn-success" id="report-export-excel">📥 Exportar para Excel</button>
                    <button class="btn btn-warning" id="report-clear-filters">🔄 Limpar Filtros</button>
                </div>
                
                <div class="report-stats" id="report-stats">
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="total-processes">0</div>
                        <div class="report-stat-label">Total de Processos</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="completed-processes">0</div>
                        <div class="report-stat-label">Processos Concluídos</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="in-progress-processes">0</div>
                        <div class="report-stat-label">Em Andamento</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="pending-processes">0</div>
                        <div class="report-stat-label">Pendentes</div>
                    </div>
                </div>
                
                <div class="report-table-container">
                    <table class="report-table" id="report-table">
                        <thead>
                            <tr>
                                <th>Senha</th>
                                <th>Motorista</th>
                                <th>Fornecedor</th>
                                <th>Contato Feito</th>
                                <th>Liberação Entregue</th>
                                <th>Encostou em Doca</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <div>📋</div>
                                        <p>Clique em "Gerar Relatório" para visualizar os dados</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Seção de Base de Dados -->
            <section id="database-section" class="section">
                <h1>Gerenciamento da Base de Dados</h1>
                
                <div class="database-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-drivers">0</div>
                        <div class="stat-label">Motoristas Cadastrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-suppliers">0</div>
                        <div class="stat-label">Fornecedores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-processes">0</div>
                        <div class="stat-label">Processos Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completed-today">0</div>
                        <div class="stat-label">Finalizados Hoje</div>
                    </div>
                </div>
                
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">📤</div>
                    <h3>Upload da Base de Dados</h3>
                    <p>Arraste um arquivo Excel ou CSV aqui ou clique para selecionar</p>
                    <p class="file-info">Formatos suportados: .xlsx, .xls, .csv</p>
                    <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="btn btn-primary" id="upload-btn">Selecionar Arquivo</button>
                </div>
                
                <div class="alert alert-warning" id="upload-instructions">
                    <strong>Estrutura esperada do arquivo:</strong><br>
                    - Coluna A: SENHA | B: DATA/HORA AGENDA | C: CD | D: FORNECEDOR | E: CARGA<br>
                    - Coluna F: STATUS | G: DATA/HORA CHEG | H: MOTORISTA | I: ACIONADO | J: NF<br>
                    - Coluna K: EMISSÃO | L: VALOR NF | M: PLACA CARRETA | N: PLACA CAVALO<br>
                    - Coluna O: INICIO CONF | P: FIM CONF | Q: INICIO CRIT | R: FIM CRIT<br>
                    - Coluna S: TEMPO CRIT | T: INI DIV COM | U: FIM DIV COM | V: TEMPO DIV COM<br>
                    - Coluna W: INI DIV TRIB | X: FIM DIV TRIB | Y: TEMPO DIV TRIB | Z: QTD EQUIP<br>
                    - Coluna AA: TIPO EQUIP | AB: HORA LIBERAÇÃO | AC: GALPÃO - CD 915<br>
                    - Coluna AD: TIPO RECUSA | AE: SETOR RECUSA | AF: MOTIVO RECUSA<br>
                    - Coluna AG: DETALHE RECUSA | AH: NF PALETES | AI: PEDIDOS NF<br>
                    - Coluna AJ: PEDIDOS C5 | AK: DIVERGÊNCIA DOS PEDIDOS
                </div>
                
                <div style="margin-top: 30px;">
                    <h2>Motoristas no Sistema</h2>
                    
                    <!-- Botões de controle -->
                    <div class="dashboard-controls">
                        <button class="btn btn-warning" id="reset-drivers-btn">Limpar Todos os Filtros</button>
                        <button class="btn btn-danger" id="clear-database-btn">Limpar Base de Dados</button>
                        <button class="btn btn-success hidden-controls" id="sync-supabase-btn">🔄 Sincronizar Supabase</button>
                        <button class="btn btn-primary hidden-controls" id="force-refresh-btn">🔄 Atualizar Interface</button>
                    </div>
                    
                    <!-- Container de Filtros Modernos -->
                    <div class="filtros-container">
                        <div class="filtro-grupo filtro-senha">
                            <label class="filtro-label" for="filter-ticket">Filtrar Senha</label>
                            <input type="text" id="filter-ticket" class="filtro-input" placeholder="Digite a senha...">
                        </div>
                        
                        <div class="filtro-grupo filtro-motorista">
                            <label class="filtro-label" for="filter-driver">Filtrar Motorista</label>
                            <input type="text" id="filter-driver" class="filtro-input" placeholder="Digite o nome...">
                        </div>
                        
                        <div class="filtro-grupo filtro-fornecedor">
                            <label class="filtro-label" for="filter-supplier">Filtrar Fornecedor</label>
                            <input type="text" id="filter-supplier" class="filtro-input" placeholder="Digite o fornecedor...">
                        </div>
                        
                        <div class="filtro-grupo filtro-status">
                            <label class="filtro-label" for="filter-status">Filtrar Status</label>
                            <input type="text" id="filter-status" class="filtro-input" placeholder="Digite o status...">
                        </div>
                        
                        <div class="filtro-grupo filtro-placa">
                            <label class="filtro-label" for="filter-plate">Filtrar Placa</label>
                            <input type="text" id="filter-plate" class="filtro-input" placeholder="Digite a placa...">
                        </div>
                        
                        <div class="filtro-grupo filtro-chegada">
                            <label class="filtro-label" for="filter-arrival">Filtrar Chegada</label>
                            <input type="text" id="filter-arrival" class="filtro-input" placeholder="Digite a data/hora...">
                        </div>
                    </div>
                    
                    <!-- Informações dos resultados -->
                    <div class="results-info" id="results-info" style="
                        margin: 15px 0;
                        padding: 10px 15px;
                        background-color: #e8f4fd;
                        border-radius: var(--border-radius);
                        font-size: 0.9rem;
                        color: var(--primary-color);
                    ">
                        Mostrando todos os registros
                    </div>
                    
                    <!-- Tabela de motoristas -->
                    <div id="drivers-table-container" style="overflow-x: scroll; overflow-y: auto; max-height: 600px; white-space: nowrap;">
                        <table class="data-table" id="drivers-table" style="min-width: 100%;">
                            <thead>
                                <tr>
                                    <th>Senha</th>
                                    <th>Motorista</th>
                                    <th>Fornecedor</th>
                                    <th>CD</th>
                                    <th>Placa</th>
                                    <th>Status</th>
                                    <th>Chegada</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="drivers-table-body">
                                <!-- Dados serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>Cｏｎｔｒｏｌｌａ - Sistema de Controle de Comparecimento &copy; 2025</p>
        </div>
    </footer>

    <!-- Indicador de salvamento automático -->
    <div id="auto-save-status" class="auto-save-status saved" style="display: none;">
        ✅ Dados salvos automaticamente
    </div>

    <script>
        // ========== CONFIGURAÇÃO SUPABASE ========== //
        const SUPABASE_URL = 'https://nuebpjbozdcawkkgnqfe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZWJwamJvemRjYXdra2ducWZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODczOTYsImV4cCI6MjA3NzE2MzM5Nn0.2hpn6WyYJovBeoY50EeRcx3_qcgCgI6QKGKkkNi3AlI';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Estado da aplicação
        let currentDriver = null;
        let driversData = [];
        let suppliersList = [];
        let cdList = [];
        let isOnline = true;
        let supabaseSubscription = null;
        let lastUpdateTime = null;
        
        // ========== SISTEMA DE PERSISTÊNCIA AUTOMÁTICA ========== //
        let autoSaveInterval;
        let dataChangeDetected = false;

        // ========== SISTEMA DE BACKUP AUTOMÁTICO DE PROCESSOS ========== //
        let processBackupData = {};
        
        // ========== SISTEMA DE CARGA ========== //
        let cargaData = new Set();
        let currentCargaFile = null;

        // Mapeamento de colunas
        const columnMapping = {
            'SENHA': 'ticket',
            'DATA/HORA AGENDA': 'scheduleDateTime',
            'CD': 'cd',
            'FORNECEDOR': 'supplier',
            'CARGA': 'load',
            'STATUS': 'status',
            'DATA/HORA CHEG': 'arrivalDateTime',
            'MOTORISTA': 'driverName',
            'ACIONADO': 'called',
            'NF': 'nfNumber',
            'EMISSÃO': 'nfEmission',
            'VALOR NF': 'nfValue',
            'PLACA CARRETA': 'trailerPlate',
            'PLACA CAVALO': 'truckPlate',
            'INICIO CONF': 'confStart',
            'FIM CONF': 'confEnd',
            'INICIO CRIT': 'critStart',
            'FIM CRIT': 'critEnd',
            'TEMPO CRIT': 'critTime',
            'INI DIV COM': 'divComStart',
            'FIM DIV COM': 'divComEnd',
            'TEMPO DIV COM': 'divComTime',
            'INI DIV TRIB': 'divTribStart',
            'FIM DIV TRIB': 'divTribEnd',
            'TEMPO DIV TRIB': 'divTribTime',
            'QTD EQUIP': 'equipmentQty',
            'TIPO EQUIP': 'equipmentType',
            'HORA LIBERAÇÃO': 'releaseTime',
            'GALPÃO - CD 915': 'warehouse',
            'TIPO RECUSA': 'refusalType',
            'SETOR RECUSA': 'refusalSector',
            'MOTIVO RECUSA': 'refusalReason',
            'DETALHE RECUSA': 'refusalDetail',
            'NF PALETES': 'nfPallets',
            'PEDIDOS NF': 'nfOrders',
            'PEDIDOS C5': 'c5Orders',
            'DIVERGÊNCIA DOS PEDIDOS': 'orderDivergence'
        };

        // ========== FUNÇÃO PARA TESTAR CONEXÃO SUPABASE ========== //
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .limit(1);
                    
                if (error) {
                    console.error('❌ Erro na conexão Supabase:', error);
                    return false;
                }
                
                console.log('✅ Conexão Supabase estabelecida com sucesso!');
                return true;
            } catch (error) {
                console.error('❌ Erro ao conectar com Supabase:', error);
                return false;
            }
        }

        // ========== SISTEMA DE BACKUP INTELIGENTE ========== //

        // 1. CARREGAR BACKUP DE PROCESSOS
        function loadProcessBackup() {
            try {
                const savedBackup = localStorage.getItem('processBackupData');
                if (savedBackup) {
                    processBackupData = JSON.parse(savedBackup);
                    console.log('✅ Backup de processos carregado:', Object.keys(processBackupData).length, 'processos');
                    return true;
                }
            } catch (error) {
                console.error('❌ Erro ao carregar backup de processos:', error);
            }
            return false;
        }

        // 2. SALVAR BACKUP DE PROCESSOS (INTELIGENTE)
        function saveProcessBackup() {
            try {
                // Criar um novo backup vazio
                const newBackup = {};
                
                // Preencher apenas com drivers que têm dados de processo
                driversData.forEach(driver => {
                    if (driver.ticket) {
                        const ticketKey = driver.ticket.toString().trim();
                        const hasProcessData = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                             (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                             (driver.encostouDoca && driver.encostouDoca !== '-');
                        
                        if (hasProcessData) {
                            newBackup[ticketKey] = {
                                contatoFeito: driver.contatoFeito || '-',
                                liberacaoEntregue: driver.liberacaoEntregue || '-',
                                encostouDoca: driver.encostouDoca || '-',
                                lastUpdated: new Date().toISOString()
                            };
                        }
                    }
                });
                
                processBackupData = newBackup;
                localStorage.setItem('processBackupData', JSON.stringify(processBackupData));
                console.log('✅ Backup inteligente salvo:', Object.keys(processBackupData).length, 'processos');
                return true;
            } catch (error) {
                console.error('❌ Erro ao salvar backup de processos:', error);
                return false;
            }
        }

        // 3. RESTAURAR PROCESSOS DO BACKUP (APENAS SE NECESSÁRIO)
        function restoreProcessBackup() {
            try {
                let restoredCount = 0;
                let skippedCount = 0;
                
                driversData.forEach(driver => {
                    if (driver.ticket) {
                        const ticketKey = driver.ticket.toString().trim();
                        const backup = processBackupData[ticketKey];
                        
                        if (backup) {
                            // Verificar se o driver atual já tem dados de processo
                            const currentHasProcessData = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                                        (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                                        (driver.encostouDoca && driver.encostouDoca !== '-');
                            
                            // Só restaurar se o driver atual NÃO tem dados de processo
                            if (!currentHasProcessData) {
                                // Restaurar processos do backup
                                if (backup.contatoFeito !== '-') {
                                    driver.contatoFeito = backup.contatoFeito;
                                    restoredCount++;
                                }
                                
                                if (backup.liberacaoEntregue !== '-') {
                                    driver.liberacaoEntregue = backup.liberacaoEntregue;
                                    restoredCount++;
                                }
                                
                                if (backup.encostouDoca !== '-') {
                                    driver.encostouDoca = backup.encostouDoca;
                                    restoredCount++;
                                }
                            } else {
                                skippedCount++;
                            }
                        }
                    }
                });
                
                if (restoredCount > 0) {
                    console.log(`✅ ${restoredCount} processos restaurados do backup (${skippedCount} pulados - já possuíam dados)`);
                }
                
                return restoredCount;
            } catch (error) {
                console.error('❌ Erro ao restaurar backup de processos:', error);
                return 0;
            }
        }

        // ========== SISTEMA DE PERSISTÊNCIA AUTOMÁTICA ========== //

        // 1. INICIALIZAR SISTEMA DE PERSISTÊNCIA
        function initializePersistenceSystem() {
            console.log('🔄 Iniciando sistema de persistência automática...');
            
            // Configurar salvamento automático a cada 5 segundos
            autoSaveInterval = setInterval(() => {
                if (dataChangeDetected) {
                    autoSaveData();
                }
            }, 5000);
            
            // Monitorar mudanças nos dados
            setupDataChangeMonitoring();
        }

        // 2. MONITORAR MUDANÇAS NOS DADOS
        function setupDataChangeMonitoring() {
            let lastDataState = JSON.stringify(driversData);
            
            setInterval(() => {
                const currentDataState = JSON.stringify(driversData);
                if (currentDataState !== lastDataState) {
                    dataChangeDetected = true;
                    lastDataState = currentDataState;
                    showAutoSaveStatus('saving');
                }
            }, 1000);
        }

        // 3. SALVAMENTO AUTOMÁTICO
        async function autoSaveData() {
            if (!dataChangeDetected) return;
            
            try {
                showAutoSaveStatus('saving');
                
                // Salvar no Supabase (se online) APENAS PROCESSOS
                if (isOnline) {
                    const success = await saveProcessesToSupabase();
                    if (success) {
                        console.log('✅ Processos salvos automaticamente no Supabase');
                    }
                }
                
                // Sempre salvar no localStorage como backup
                saveToLocalStorage();
                
                // Salvar backup de processos (INTELIGENTE)
                saveProcessBackup();
                
                dataChangeDetected = false;
                showAutoSaveStatus('saved');
                
                // ATUALIZAR RELATÓRIO AUTOMATICAMENTE
                if (document.getElementById('report-section').classList.contains('active')) {
                    generateReport();
                }
                
            } catch (error) {
                console.error('❌ Erro no salvamento automático:', error);
                showAutoSaveStatus('error');
                // Em caso de erro, ainda salva no localStorage
                saveToLocalStorage();
                saveProcessBackup();
            }
        }

        // 4. INDICADOR VISUAL DE SALVAMENTO
        function showAutoSaveStatus(status) {
            const statusElement = document.getElementById('auto-save-status');
            if (!statusElement) return;
            
            statusElement.style.display = 'block';
            statusElement.className = 'auto-save-status ' + status;
            
            switch(status) {
                case 'saving':
                    statusElement.textContent = '🔄 Salvando dados...';
                    break;
                case 'saved':
                    statusElement.textContent = '✅ Dados salvos automaticamente';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                    break;
                case 'error':
                    statusElement.textContent = '❌ Erro ao salvar';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 5000);
                    break;
            }
        }

        // ========== FUNÇÕES DO PROCESSO - CORRIGIDAS ========== //
        async function registerProcessStep(ticket, stepField) {
            console.log(`Registrando etapa ${stepField} para senha ${ticket}`);
            
            // Buscar o motorista na base de dados
            let driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            
            if (!driver) {
                showNotification(`❌ Senha ${ticket} não encontrada na base de dados`, 'error');
                return;
            }
            
            // Garantir que os campos de processo existam
            if (!driver.hasOwnProperty('contatoFeito')) driver.contatoFeito = '-';
            if (!driver.hasOwnProperty('liberacaoEntregue')) driver.liberacaoEntregue = '-';
            if (!driver.hasOwnProperty('encostouDoca')) driver.encostouDoca = '-';
            
            // Registrar o horário atual
            const now = new Date();
            const formattedDateTime = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            // Atualizar a etapa específica
            driver[stepField] = formattedDateTime;
            
            // ✅ SALVAR APENAS O PROCESSO NO SUPABASE
            await saveProcessToSupabase(driver);
            
            // Atualizar currentDriver se for o mesmo ticket
            if (currentDriver && currentDriver.ticket === ticket) {
                currentDriver = driver;
            }
            
            // Marcar mudança nos dados para salvamento automático
            dataChangeDetected = true;
            
            // Atualizar a interface
            updateInterface();
            
            // Mostrar confirmação
            const stepName = getStepName(stepField);
            showNotification(`✅ ${stepName} registrado para senha ${ticket}`, 'success');
            
            console.log('Etapa registrada com sucesso:', driver);
        }

        async function undoProcessStep(ticket, stepField) {
            console.log(`Desfazendo etapa ${stepField} para senha ${ticket}`);
            
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            
            if (!driver) {
                showNotification('❌ Motorista não encontrado', 'error');
                return;
            }
            
            const stepName = getStepName(stepField);
            const currentValue = driver[stepField];
            
            if (!currentValue || currentValue === '-') {
                showNotification(`ℹ️ A etapa "${stepName}" já está vazia`, 'info');
                return;
            }
            
            if (confirm(`Tem certeza que deseja desfazer a etapa "${stepName}" para a senha ${ticket}?\n\nHorário registrado: ${currentValue}`)) {
                // Limpar o campo da etapa
                driver[stepField] = '-';
                
                // ✅ VERIFICAR SE TODAS AS ETAPAS ESTÃO VAZIAS PARA REMOVER DO SUPABASE
                const allStepsEmpty = 
                    (driver.contatoFeito === '-' || !driver.contatoFeito) &&
                    (driver.liberacaoEntregue === '-' || !driver.liberacaoEntregue) && 
                    (driver.encostouDoca === '-' || !driver.encostouDoca);
                
                if (allStepsEmpty) {
                    // ✅ REMOVER DO SUPABASE SE NÃO TEM MAIS PROCESSOS
                    await removeFromSupabase(ticket);
                } else {
                    // ✅ ATUALIZAR NO SUPABASE COM OS DADOS ATUAIS
                    await saveProcessToSupabase(driver);
                }
                
                // Atualizar currentDriver se for o mesmo ticket
                if (currentDriver && currentDriver.ticket === ticket) {
                    currentDriver = driver;
                }
                
                // Marcar mudança nos dados
                dataChangeDetected = true;
                
                // Atualizar a interface
                updateInterface();
                
                // Mostrar confirmação
                showNotification(`↩️ ${stepName} desfeito para senha ${ticket}`, 'warning');
                
                console.log('Etapa desfeita com sucesso:', driver);
            }
        }

        // ✅ NOVA FUNÇÃO PARA REMOVER DO SUPABASE
        async function removeFromSupabase(ticket) {
            try {
                const { error } = await supabase
                    .from('drivers')
                    .delete()
                    .eq('ticket', ticket);

                if (error) throw error;
                
                console.log(`✅ Registro ${ticket} removido do Supabase`);
                return true;
            } catch (error) {
                console.error('❌ Erro ao remover do Supabase:', error);
                return false;
            }
        }

        // ✅ NOVA FUNÇÃO PARA SALVAR APENAS PROCESSO NO SUPABASE
        async function saveProcessToSupabase(driver) {
            try {
                const driverToSave = {
                    ticket: driver.ticket,
                    driver_name: driver.driverName,
                    supplier: driver.supplier,
                    cd: driver.cd,
                    status: driver.status,
                    contato_feito: driver.contatoFeito !== '-' ? driver.contatoFeito : null,
                    liberacao_entregue: driver.liberacaoEntregue !== '-' ? driver.liberacaoEntregue : null,
                    encostou_doca: driver.encostouDoca !== '-' ? driver.encostouDoca : null,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('drivers')
                    .upsert([driverToSave], {
                        onConflict: 'ticket'
                    });

                if (error) throw error;
                
                return true;
            } catch (error) {
                console.error('❌ Erro ao salvar processo no Supabase:', error);
                return false;
            }
        }

        // ✅ FUNÇÃO PARA SALVAR APENAS PROCESSOS NO SUPABASE
        async function saveProcessesToSupabase() {
            // ✅ SALVAR APENAS DRIVERS QUE TENHAM PROCESSOS
            const driversWithProcesses = driversData.filter(driver => 
                (driver.contatoFeito && driver.contatoFeito !== '-') || 
                (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                (driver.encostouDoca && driver.encostouDoca !== '-')
            );

            if (driversWithProcesses.length === 0) {
                return true;
            }

            const driversToSave = driversWithProcesses.map(driver => ({
                ticket: driver.ticket,
                driver_name: driver.driverName,
                supplier: driver.supplier,
                cd: driver.cd,
                status: driver.status,
                contato_feito: driver.contatoFeito !== '-' ? driver.contatoFeito : null,
                liberacao_entregue: driver.liberacaoEntregue !== '-' ? driver.liberacaoEntregue : null,
                encostou_doca: driver.encostouDoca !== '-' ? driver.encostouDoca : null,
                updated_at: new Date().toISOString()
            }));
            
            const { data, error } = await supabase
                .from('drivers')
                .upsert(driversToSave, {
                    onConflict: 'ticket',
                    ignoreDuplicates: false
                });

            if (error) {
                throw error;
            }
            
            return true;
        }

        // ========== FUNÇÕES PRINCIPAIS ========== //
        function createSampleData() {
            const sampleDrivers = [
                {
                    ticket: '1001',
                    driverName: 'João Silva',
                    supplier: 'Transportes ABC',
                    cd: 'CD001',
                    truckPlate: 'ABC1234',
                    status: 'AGENDADO',
                    scheduleDateTime: '15/10/2023 08:30:00',
                    arrivalDateTime: '15/10/2023 08:35:00',
                    load: '26568216',
                    contatoFeito: '-',
                    liberacaoEntregue: '-',
                    encostouDoca: '-'
                },
                {
                    ticket: '1002', 
                    driverName: 'Maria Santos',
                    supplier: 'Logística XYZ',
                    cd: 'CD002',
                    truckPlate: 'XYZ5678',
                    status: 'AGENDADO',
                    scheduleDateTime: '15/10/2023 09:00:00',
                    arrivalDateTime: '15/10/2023 09:05:00',
                    load: '26555322',
                    contatoFeito: '-',
                    liberacaoEntregue: '-',
                    encostouDoca: '-'
                }
            ];
            
            driversData = sampleDrivers;
            suppliersList = ['Transportes ABC', 'Logística XYZ'];
            cdList = ['CD001', 'CD002'];
        }

        function updateDatabaseStats() {
            try {
                const totalDrivers = driversData.length;
                
                const suppliers = driversData
                    .map(d => d.supplier)
                    .filter(supplier => supplier && supplier !== '-' && supplier !== '');
                const totalSuppliers = [...new Set(suppliers)].length;
                
                const activeProcesses = driversData.filter(d => {
                    const status = d.status ? d.status.toString().trim().toUpperCase() : '';
                    const statusAtivos = ['AGENDADO', 'CONFERENCIA', 'PARA AGENDAR'];
                    return statusAtivos.includes(status);
                }).length;
                
                const completedToday = driversData.filter(d => {
                    try {
                        const status = d.status ? d.status.toString().trim().toUpperCase() : '';
                        if (status !== 'FINALIZADO') return false;
                        if (!d.arrivalDateTime || d.arrivalDateTime === '-' || d.arrivalDateTime === '') return false;
                        const arrivalStr = String(d.arrivalDateTime);
                        const today = new Date();
                        const todayDay = today.getDate().toString().padStart(2, '0');
                        const todayMonth = (today.getMonth() + 1).toString().padStart(2, '0');
                        const todayYear = today.getFullYear();
                        const todayFormatted = `${todayDay}/${todayMonth}/${todayYear}`;
                        return arrivalStr.includes(todayFormatted);
                    } catch (error) {
                        return false;
                    }
                }).length;
                
                document.getElementById('total-drivers').textContent = totalDrivers;
                document.getElementById('total-suppliers').textContent = totalSuppliers;
                document.getElementById('active-processes').textContent = activeProcesses;
                document.getElementById('completed-today').textContent = completedToday;
                
            } catch (error) {
                document.getElementById('total-drivers').textContent = driversData.length || '0';
                document.getElementById('total-suppliers').textContent = '0';
                document.getElementById('active-processes').textContent = '0';
                document.getElementById('completed-today').textContent = '0';
            }
        }

        // ========== FUNÇÕES DE NAVEGAÇÃO ========== //
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`[data-target="${sectionId}"]`).classList.add('active');
            
            if (sectionId === 'report-section') generateReport();
            else if (sectionId === 'encosta-section') renderEncostaList();
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function goToProcessFromEncosta(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            
            if (driver) {
                currentDriver = driver;
                document.getElementById('ticket-input').value = ticket;
                displayDriverInfo(driver);
                document.getElementById('driver-result').style.display = 'block';
                document.getElementById('driver-not-found').style.display = 'none';
                showSection('process-section');
                renderProcessTimeline();
            } else {
                alert(`❌ Senha ${ticket} não encontrada na base de dados`);
            }
        }

        // ========== FUNÇÕES DE BUSCA ========== //
        function searchDriver(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (driver) {
                currentDriver = driver;
                displayDriverInfo(driver);
                document.getElementById('driver-result').style.display = 'block';
                document.getElementById('driver-not-found').style.display = 'none';
            } else {
                document.getElementById('driver-result').style.display = 'none';
                document.getElementById('driver-not-found').style.display = 'block';
            }
        }

        function displayDriverInfo(driver) {
            document.getElementById('driver-ticket').textContent = driver.ticket || '-';
            document.getElementById('driver-name').textContent = driver.driverName || '-';
            document.getElementById('driver-supplier').textContent = driver.supplier || '-';
            document.getElementById('driver-cd').textContent = driver.cd || '-';
            document.getElementById('driver-schedule').textContent = driver.scheduleDateTime || '-';
            document.getElementById('driver-arrival').textContent = driver.arrivalDateTime || '-';
            document.getElementById('driver-status').textContent = driver.status || '-';
            document.getElementById('driver-called').textContent = driver.called || '-';
            
            document.getElementById('driver-truck-plate').textContent = driver.truckPlate || '-';
            document.getElementById('driver-trailer-plate').textContent = driver.trailerPlate || '-';
            document.getElementById('driver-equipment-type').textContent = driver.equipmentType || '-';
            document.getElementById('driver-equipment-qty').textContent = driver.equipmentQty || '-';
            document.getElementById('driver-nf').textContent = driver.nfNumber || '-';
            document.getElementById('driver-nf-emission').textContent = driver.nfEmission || '-';
            document.getElementById('driver-nf-value').textContent = driver.nfValue || '-';
            document.getElementById('driver-load').textContent = driver.load || '-';
            
            document.getElementById('driver-conf-start').textContent = driver.confStart || '-';
            document.getElementById('driver-conf-end').textContent = driver.confEnd || '-';
            document.getElementById('driver-crit-start').textContent = driver.critStart || '-';
            document.getElementById('driver-crit-end').textContent = driver.critEnd || '-';
            document.getElementById('driver-crit-time').textContent = driver.critTime || '-';
            document.getElementById('driver-release').textContent = driver.releaseTime || '-';
            document.getElementById('driver-warehouse').textContent = driver.warehouse || '-';
            document.getElementById('driver-process-status').textContent = getProcessStatus(driver) || '-';
        }

        function getProcessStatus(driver) {
            if (!driver) return 'Não definido';
            
            // Garantir que os campos existam
            if (!driver.hasOwnProperty('contatoFeito')) driver.contatoFeito = '-';
            if (!driver.hasOwnProperty('liberacaoEntregue')) driver.liberacaoEntregue = '-';
            if (!driver.hasOwnProperty('encostouDoca')) driver.encostouDoca = '-';
            
            if (driver.encostouDoca && driver.encostouDoca !== '-') {
                return 'Encostou em Doca';
            }
            if (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') {
                return 'Liberação Entregue';
            }
            if (driver.contatoFeito && driver.contatoFeito !== '-') {
                return 'Contato Feito';
            }
            return 'Aguardando Contato';
        }

        function getStepName(stepField) {
            const stepNames = {
                'contatoFeito': 'Contato Feito',
                'liberacaoEntregue': 'Liberação Entregue', 
                'encostouDoca': 'Encostou em Doca'
            };
            return stepNames[stepField] || stepField;
        }

        // ========== FUNÇÕES DO PROCESSO ========== //
        function renderProcessTimeline() {
            if (!currentDriver) {
                const processContent = document.getElementById('process-content');
                processContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>⚠️ Nenhum motorista selecionado</strong><br>
                        Volte à seção de busca e selecione uma senha para visualizar as etapas do processo.
                    </div>
                    <button class="btn btn-primary" onclick="showSection('search-section')">
                        🔍 Voltar para Busca
                    </button>
                `;
                return;
            }
            
            const processContent = document.getElementById('process-content');
            const steps = [
                { 
                    id: 'contato', 
                    label: 'Contato Feito', 
                    time: currentDriver.contatoFeito || '-', 
                    completed: !!currentDriver.contatoFeito && currentDriver.contatoFeito !== '-',
                    field: 'contatoFeito',
                    buttonText: '✅ Registrar Contato Feito'
                },
                { 
                    id: 'liberacao', 
                    label: 'Liberação Entregue', 
                    time: currentDriver.liberacaoEntregue || '-', 
                    completed: !!currentDriver.liberacaoEntregue && currentDriver.liberacaoEntregue !== '-',
                    field: 'liberacaoEntregue',
                    buttonText: '📄 Registrar Liberação Entregue'
                },
                { 
                    id: 'doca', 
                    label: 'Encostou em Doca', 
                    time: currentDriver.encostouDoca || '-', 
                    completed: !!currentDriver.encostouDoca && currentDriver.encostouDoca !== '-',
                    field: 'encostouDoca',
                    buttonText: '🚛 Registrar Encostou em Doca'
                }
            ];
            
            let nextStepIndex = steps.findIndex(step => !step.completed);
            if (nextStepIndex === -1) nextStepIndex = steps.length;
            
            let timelineHTML = `
                <div class="driver-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Senha</span>
                            <span class="info-value">${currentDriver.ticket || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Motorista</span>
                            <span class="info-value">${currentDriver.driverName || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fornecedor</span>
                            <span class="info-value">${currentDriver.supplier || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status Atual</span>
                            <span class="info-value">${getProcessStatus(currentDriver)}</span>
                        </div>
                    </div>
                </div>
                
                <h3>📋 Etapas do Processo</h3>
                <div class="timeline">
            `;
            
            steps.forEach((step, index) => {
                let stepClass = step.completed ? 'completed' : (index === nextStepIndex ? 'current' : '');
                let stepIcon = step.completed ? '✅' : (index === nextStepIndex ? '🟡' : '⚪');
                
                timelineHTML += `
                    <div class="timeline-step">
                        <div class="step-icon ${stepClass}">${stepIcon}</div>
                        <div class="step-label"><strong>${step.label}</strong></div>
                        <div class="step-time">${step.time !== '-' ? step.time : 'Não registrado'}</div>
                        <div class="step-actions">
                `;
                
                if (index === nextStepIndex) {
                    timelineHTML += `
                            <button class="btn btn-success btn-small register-step" 
                                    data-step="${step.field}" 
                                    data-ticket="${currentDriver.ticket}">
                                ${step.buttonText}
                            </button>
                    `;
                }
                
                if (step.completed) {
                    timelineHTML += `
                            <button class="btn btn-outline btn-small undo-step" 
                                    data-step="${step.field}" 
                                    data-ticket="${currentDriver.ticket}">
                                ↩️ Desfazer
                            </button>
                    `;
                }
                
                timelineHTML += `</div></div>`;
            });
            
            timelineHTML += `</div>`;
            
            // Adicionar estatísticas do processo
            const completedSteps = steps.filter(step => step.completed).length;
            const totalSteps = steps.length;
            
            timelineHTML += `
                <div class="database-stats" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${completedSteps}/${totalSteps}</div>
                        <div class="stat-label">Etapas Concluídas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${getProcessStatus(currentDriver)}</div>
                        <div class="stat-label">Status do Processo</div>
                    </div>
                </div>
            `;
            
            if (nextStepIndex === steps.length) {
                timelineHTML += `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <strong>🎉 Processo Concluído!</strong> Todas as etapas foram registradas com sucesso.
                    </div>
                `;
            }
            
            processContent.innerHTML = timelineHTML;
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.register-step').forEach(btn => {
                btn.addEventListener('click', function() {
                    const stepField = this.getAttribute('data-step');
                    const ticket = this.getAttribute('data-ticket');
                    registerProcessStep(ticket, stepField);
                });
            });
            
            document.querySelectorAll('.undo-step').forEach(btn => {
                btn.addEventListener('click', function() {
                    const stepField = this.getAttribute('data-step');
                    const ticket = this.getAttribute('data-ticket');
                    undoProcessStep(ticket, stepField);
                });
            });
        }

        // ========== FUNÇÕES DA ENCOSTA ========== //
        function renderEncostaList() {
            const encostaContent = document.getElementById('encosta-content');
            
            // ✅ CORREÇÃO: Filtrar apenas veículos com status AGENDADO
            let filteredDrivers = driversData.filter(driver => {
                if (!driver.status) return false;
                
                const status = driver.status.toString().trim().toUpperCase();
                // Manter apenas veículos com status AGENDADO na encosta
                return status === 'AGENDADO';
            });
            
            // Ordenar por horário de chegada (mais tempo esperando primeiro)
filteredDrivers.sort((a, b) => {
    const timeA = calculateWaitTimeValue(a.arrivalDateTime);
    const timeB = calculateWaitTimeValue(b.arrivalDateTime);
    return timeB - timeA; // Ordem decrescente (mais tempo esperando primeiro)
});

            const cargasGeradasCount = filteredDrivers.filter(driver => 
                checkCargaStatus(driver.ticket)
            ).length;
            
            if (filteredDrivers.length === 0) {
                encostaContent.innerHTML = `
                    <div class="empty-state">
                        <div>📋</div>
                        <p>Nenhum veículo com status AGENDADO encontrado para exibir na encosta.</p>
                        <small>Total de veículos na base: ${driversData.length}</small>
                    </div>
                `;
                return;
            }
            
            let encostaHTML = `
                <div class="database-stats">
                    <div class="stat-card">
                        <div class="stat-value">${filteredDrivers.length}</div>
                        <div class="stat-label">Veículos na Fila</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${cargasGeradasCount}</div>
                        <div class="stat-label">Cargas Geradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${filteredDrivers.length - cargasGeradasCount}</div>
                        <div class="stat-label">Cargas Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${driversData.length}</div>
                        <div class="stat-label">Total na Base</div>
                    </div>
                </div>
                
                <h3>Ranking de Chamada - Ordem de Espera (Mais Tempo Esperando Primeiro)</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Posição</th>
                                <th>Senha</th>
                                <th>Motorista</th>
                                <th>Fornecedor</th>
                                <th>Placa Cavalo</th>
                                <th>Carga</th>
                                <th>Horário Chegada</th>
                                <th>Status</th>
                                <th>Tempo de Espera</th>
                                <th>Status Carga</th>
                                <th>Status Processo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredDrivers.forEach((driver, index) => {
                const waitTime = calculateWaitTime(driver.arrivalDateTime);
                const cargaStatus = getCargaStatus(driver.ticket);
                const processoStatus = getProcessStatus(driver);
                
                let statusClass = 'status-processo ';
                let statusText = processoStatus;
                
                switch(processoStatus) {
                    case 'Aguardando Contato':
                        statusClass += 'status-aguardando';
                        break;
                    case 'Contato Feito':
                        statusClass += 'status-contato';
                        break;
                    case 'Liberação Entregue':
                        statusClass += 'status-liberacao';
                        break;
                    case 'Encostou em Doca':
                        statusClass += 'status-doca';
                        break;
                    default:
                        statusClass += 'status-aguardando';
                }
                
                encostaHTML += `
                    <tr>
                        <td><strong>${index + 1}º</strong></td>
                        <td>${driver.ticket || '-'}</td>
                        <td>${driver.driverName || '-'}</td>
                        <td>${driver.supplier || '-'}</td>
                        <td>${driver.truckPlate || '-'}</td>
                        <td>${driver.load || '-'}</td>
                        <td>${driver.arrivalDateTime || '-'}</td>
                        <td>${driver.status || '-'}</td>	
                        <td>${waitTime}</td>
                        <td><span class="${cargaStatus.class}">${cargaStatus.status}</span></td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-primary btn-small processo-encosta" data-ticket="${driver.ticket}">Processo</button>
                        </td>
                    </tr>
                `;
            });
            
            encostaHTML += `</tbody></table></div>`;
            encostaContent.innerHTML = encostaHTML;
            
            document.querySelectorAll('.processo-encosta').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticket = this.getAttribute('data-ticket');
                    goToProcessFromEncosta(ticket);
                });
            });
        }

        // ========== FUNÇÕES DO RELATÓRIO ========== //
        function generateReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let filteredData = driversData.filter(driver => {
                // Só incluir no relatório se tiver pelo menos UM campo de processo preenchido
                const hasProcessData = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                     (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                     (driver.encostouDoca && driver.encostouDoca !== '-');
                
                if (!hasProcessData) return false;
                if (!startDate && !endDate) return true;
                
                let driverDate = null;
                
                // Tentar encontrar a data mais recente do processo
                if (driver.encostouDoca !== '-') {
                    driverDate = extractDateFromProcessDateTime(driver.encostouDoca);
                } else if (driver.liberacaoEntregue !== '-') {
                    driverDate = extractDateFromProcessDateTime(driver.liberacaoEntregue);
                } else if (driver.contatoFeito !== '-') {
                    driverDate = extractDateFromProcessDateTime(driver.contatoFeito);
                }
                
                if (!driverDate) return false;
                if (startDate && driverDate < startDate) return false;
                if (endDate && driverDate > endDate) return false;
                
                return true;
            });
            
            updateReportStats(filteredData);
            renderReportTable(filteredData);
        }

        function extractDateFromProcessDateTime(dateTimeStr) {
            if (!dateTimeStr || dateTimeStr === '-' || dateTimeStr === '') return null;
            
            try {
                const parts = dateTimeStr.split(' ');
                if (parts.length < 2) return null;
                const datePart = parts[0];
                const [day, month, year] = datePart.split('/');
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            } catch (e) {
                return null;
            }
        }

        function updateReportStats(data) {
            const totalProcesses = data.length;
            const completedProcesses = data.filter(d => d.encostouDoca && d.encostouDoca !== '-').length;
            const inProgressProcesses = data.filter(d => 
                (d.contatoFeito !== '-' && d.liberacaoEntregue !== '-' && d.encostouDoca === '-') ||
                (d.contatoFeito !== '-' && d.liberacaoEntregue === '-' && d.encostouDoca === '-')
            ).length;
            const pendingProcesses = data.filter(d => 
                d.contatoFeito === '-' && d.liberacaoEntregue === '-' && d.encostouDoca === '-'
            ).length;

            document.getElementById('total-processes').textContent = totalProcesses;
            document.getElementById('completed-processes').textContent = completedProcesses;
            document.getElementById('in-progress-processes').textContent = inProgressProcesses;
            document.getElementById('pending-processes').textContent = pendingProcesses;
        }

        function renderReportTable(data) {
            const tableBody = document.getElementById('report-table-body');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <div>📋</div>
                                <p>Nenhum dado de processo encontrado</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            
            data.forEach(driver => {
                const status = getProcessStatus(driver);
                let rowClass = '';
                
                if (status === 'Encostou em Doca') rowClass = 'completed';
                else if (status === 'Liberação Entregue' || status === 'Contato Feito') rowClass = 'in-progress';
                else rowClass = 'pending';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${driver.ticket || '-'}</td>
                        <td>${driver.driverName || '-'}</td>
                        <td>${driver.supplier || '-'}</td>
                        <td>${driver.contatoFeito || '-'}</td>
                        <td>${driver.liberacaoEntregue || '-'}</td>
                        <td>${driver.encostouDoca || '-'}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        function exportReportToExcel() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let filteredData = driversData.filter(driver => {
                const hasProcessData = driver.contatoFeito !== '-' || 
                                     driver.liberacaoEntregue !== '-' || 
                                     driver.encostouDoca !== '-';
                if (!hasProcessData) return false;
                if (!startDate && !endDate) return true;
                
                let driverDate = null;
                if (driver.contatoFeito !== '-') driverDate = extractDateFromProcessDateTime(driver.contatoFeito);
                else if (driver.liberacaoEntregue !== '-') driverDate = extractDateFromProcessDateTime(driver.liberacaoEntregue);
                else if (driver.encostouDoca !== '-') driverDate = extractDateFromProcessDateTime(driver.encostouDoca);
                
                if (!driverDate) return false;
                if (startDate && driverDate < startDate) return false;
                if (endDate && driverDate > endDate) return false;
                return true;
            });
            
            if (filteredData.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }
            
            const excelData = filteredData.map(driver => ({
                'Senha': driver.ticket || '',
                'Contato Feito': driver.contatoFeito || '',
                'Liberação Entregue': driver.liberacaoEntregue || '',
                'Encostou em Doca': driver.encostouDoca || '',
                'Motorista': driver.driverName || '',
                'Fornecedor': driver.supplier || '',
                'Status': getProcessStatus(driver) || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatorio_Processos');
            
            const today = new Date().toISOString().split('T')[0];
            const fileName = `relatorio_processos_${today}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }

        function clearReportFilters() {
            document.getElementById('report-start-date').value = '';
            document.getElementById('report-end-date').value = '';
            generateReport();
        }

        // ========== FUNÇÕES DA BASE DE DADOS ========== //
        function renderDriversTable(filteredData = null) {
            const dataToShow = filteredData || driversData;
            const tableBody = document.getElementById('drivers-table-body');
            
            tableBody.innerHTML = '';
            
            if (dataToShow.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8" style="text-align: center;">Nenhum motorista encontrado</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            const displayData = dataToShow.slice(0, 1000);
            
            displayData.forEach(driver => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${driver.ticket || '-'}</td>
                    <td>${driver.driverName || '-'}</td>
                    <td>${driver.supplier || '-'}</td>
                    <td>${driver.cd || '-'}</td>
                    <td>${driver.truckPlate || '-'}</td>
                    <td>${driver.status || '-'}</td>
                    <td>${driver.arrivalDateTime || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small view-driver" data-ticket="${driver.ticket}">Ver</button>
                        <button class="btn btn-danger btn-small delete-driver" data-ticket="${driver.ticket}">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.view-driver').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticket = this.getAttribute('data-ticket');
                    searchDriver(ticket);
                    showSection('search-section');
                });
            });
            
            document.querySelectorAll('.delete-driver').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ticket = this.getAttribute('data-ticket');
                    deleteDriver(ticket);
                });
            });
            
            setupColumnFilters();
        }

        function setupColumnFilters() {
            let filterTimeout;
            
            document.querySelectorAll('.column-filter').forEach(input => {
                input.addEventListener('input', function() {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => {
                        filterTableByColumns();
                    }, 300);
                });
            });
        }

        function filterTableByColumns() {
            if (driversData.length === 0) {
                renderDriversTable([]);
                return;
            }
            
            const filters = [];
            let hasActiveFilter = false;
            
            document.querySelectorAll('.column-filter').forEach((input, index) => {
                filters[index] = input.value.trim().toLowerCase();
                if (filters[index]) hasActiveFilter = true;
            });
            
            if (!hasActiveFilter) {
                renderDriversTable();
                return;
            }
            
            const filteredData = driversData.filter(driver => {
                if (filters[0] && (!driver.ticket || !driver.ticket.toString().toLowerCase().includes(filters[0]))) return false;
                if (filters[1] && (!driver.driverName || !driver.driverName.toString().toLowerCase().includes(filters[1]))) return false;
                if (filters[2] && (!driver.supplier || !driver.supplier.toString().toLowerCase().includes(filters[2]))) return false;
                if (filters[3] && (!driver.cd || !driver.cd.toString().toLowerCase().includes(filters[3]))) return false;
                if (filters[4] && (!driver.truckPlate || !driver.truckPlate.toString().toLowerCase().includes(filters[4]))) return false;
                if (filters[5] && (!driver.status || !driver.status.toString().toLowerCase().includes(filters[5]))) return false;
                if (filters[6]) {
                    const arrivalFormatted = driver.arrivalDateTime;
                    if (!arrivalFormatted || !arrivalFormatted.toString().toLowerCase().includes(filters[6])) return false;
                }
                
                return true;
            });
            
            renderDriversTable(filteredData);
        }

        let activeFilters = {
            ticket: '',
            driver: '',
            supplier: '',
            status: '',
            plate: '',
            arrival: ''
        };

        function setupFilterListeners() {
            document.getElementById('filter-ticket').addEventListener('input', function() {
                activeFilters.ticket = this.value.trim().toLowerCase();
                applyFilters();
            });
            
            document.getElementById('filter-driver').addEventListener('input', function() {
                activeFilters.driver = this.value.trim().toLowerCase();
                applyFilters();
            });
            
            document.getElementById('filter-supplier').addEventListener('input', function() {
                activeFilters.supplier = this.value.trim().toLowerCase();
                applyFilters();
            });
            
            document.getElementById('filter-status').addEventListener('input', function() {
                activeFilters.status = this.value.trim().toLowerCase();
                applyFilters();
            });
            
            document.getElementById('filter-plate').addEventListener('input', function() {
                activeFilters.plate = this.value.trim().toLowerCase();
                applyFilters();
            });
            
            document.getElementById('filter-arrival').addEventListener('input', function() {
                activeFilters.arrival = this.value.trim().toLowerCase();
                applyFilters();
            });
        }

        function applyFilters() {
            let filteredData = driversData.filter(driver => {
                if (activeFilters.ticket && (!driver.ticket || !driver.ticket.toString().toLowerCase().includes(activeFilters.ticket))) {
                    return false;
                }
                
                if (activeFilters.driver && (!driver.driverName || !driver.driverName.toString().toLowerCase().includes(activeFilters.driver))) {
                    return false;
                }
                
                if (activeFilters.supplier && (!driver.supplier || !driver.supplier.toString().toLowerCase().includes(activeFilters.supplier))) {
                    return false;
                }
                
                if (activeFilters.status && (!driver.status || !driver.status.toString().toLowerCase().includes(activeFilters.status))) {
                    return false;
                }
                
                if (activeFilters.plate && (!driver.truckPlate || !driver.truckPlate.toString().toLowerCase().includes(activeFilters.plate))) {
                    return false;
                }
                
                if (activeFilters.arrival) {
                    const arrivalFormatted = driver.arrivalDateTime;
                    if (!arrivalFormatted || !arrivalFormatted.toString().toLowerCase().includes(activeFilters.arrival)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderDriversTable(filteredData);
        }

        function deleteDriver(ticket) {
            if (confirm(`Tem certeza que deseja excluir a senha ${ticket}?`)) {
                driversData = driversData.filter(d => d.ticket !== ticket);
                saveToLocalStorage();
                renderDriversTable();
                updateDatabaseStats();
                
                if (currentDriver && currentDriver.ticket === ticket) {
                    currentDriver = null;
                    document.getElementById('driver-result').style.display = 'none';
                }
            }
        }

        // ========== FUNÇÃO LIMPAR BASE DE DADOS - MODIFICADA ========== //
        function clearDatabase() {
            if (confirm('⚠️ ATENÇÃO: Tem certeza que deseja limpar a base de dados?\n\n📋 Isso irá remover TODOS os dados, MAS:\n• Todos os registros de processo (Contato Feito, Liberação Entregue, Encostou em Doca) serão PRESERVADOS\n• Os processos continuarão aparecendo no relatório\n\nPara remover processos do relatório, use a função "Desfazer" no menu Processo.\n\nEsta ação não pode ser desfeita.')) {
                
                // SALVAR TODOS OS REGISTROS DE PROCESSO ANTES DE LIMPAR
                const processosPreservados = [];
                
                driversData.forEach(driver => {
                    if (driver.ticket && (
                        (driver.contatoFeito && driver.contatoFeito !== '-') ||
                        (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                        (driver.encostouDoca && driver.encostouDoca !== '-')
                    )) {
                        processosPreservados.push({
                            ticket: driver.ticket,
                            contatoFeito: driver.contatoFeito || '-',
                            liberacaoEntregue: driver.liberacaoEntregue || '-',
                            encostouDoca: driver.encostouDoca || '-',
                            driverName: driver.driverName || 'Motorista Não Cadastrado',
                            supplier: driver.supplier || '-'
                        });
                    }
                });
                
                // LIMPAR BASE COMPLETA
                driversData = [];
                suppliersList = [];
                cdList = [];
                
                // RESTAURAR OS PROCESSOS PRESERVADOS
                processosPreservados.forEach(processo => {
                    const driverExistente = driversData.find(d => d.ticket === processo.ticket);
                    if (!driverExistente) {
                        driversData.push({
                            ticket: processo.ticket,
                            driverName: processo.driverName,
                            supplier: processo.supplier,
                            cd: '-',
                            status: 'AGENDADO',
                            arrivalDateTime: '-',
                            scheduleDateTime: '-',
                            contatoFeito: processo.contatoFeito,
                            liberacaoEntregue: processo.liberacaoEntregue,
                            encostouDoca: processo.encostouDoca,
                            load: '-',
                            truckPlate: '-'
                        });
                    }
                });
                
                saveToLocalStorage();
                renderDriversTable();
                updateDatabaseStats();
                
                if (currentDriver) {
                    currentDriver = null;
                    document.getElementById('driver-result').style.display = 'none';
                }
                
                showNotification(`🗑️ Base limpa! ${processosPreservados.length} processos preservados no relatório.`, 'warning', 5000);
            }
        }

        // ========== FUNÇÕES DE UPLOAD - ATUALIZADAS ========== //
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) processFileImmediately(file);
        }

        function processFileImmediately(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length > 0) processAndSaveData(jsonData);
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ========== FUNÇÃO PARA CONVERTER DATAS - CORRIGIDA ========== //
        function convertToDisplayFormat(dateTimeValue, columnHeader = '') {
            if (!dateTimeValue || dateTimeValue === '-' || dateTimeValue === '' || dateTimeValue === ' ') return '-';
            
            try {
                // Se já está no formato dd/mm/aaaa, retorna como está
                if (typeof dateTimeValue === 'string' && dateTimeValue.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/)) {
                    return dateTimeValue;
                }
                
                let date;
                
                if (typeof dateTimeValue === 'number') {
                    // CORREÇÃO: Converter número serial do Excel para data SEM subtrair 1 dia
            // e ADICIONAR 6 minutos
            const excelEpoch = new Date(1899, 11, 30);
            date = new Date(excelEpoch.getTime() + dateTimeValue * 86400 * 1000);
            
            // ADICIONAR 6 minutos (6 * 60 * 1000 milissegundos)
            date = new Date(date.getTime() - (6 * 60 * 1000));
            
            // ADICIONAR 50 milissegundos APENAS para DATA/HORA AGENDA
            if (columnHeader === 'DATA/HORA AGENDA') {
                date = new Date(date.getTime() + 50);
            }
        } else if (dateTimeValue instanceof Date) {
            date = dateTimeValue;
            
            // ADICIONAR 50 milissegundos APENAS para DATA/HORA AGENDA
            if (columnHeader === 'DATA/HORA AGENDA') {
                date = new Date(date.getTime() + 50);
            }
        } else {
                    // Tentar parse como string
                    const parts = dateTimeValue.toString().split(' ');
                    const datePart = parts[0];
                    const timePart = parts[1] || '00:00';
                    
                    // Verificar se está no formato brasileiro dd/mm/aaaa
                    if (datePart && datePart.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        const [day, month, year] = datePart.split('/');
                        const [hours, minutes] = timePart.split(':');
                        
                        date = new Date(
                            parseInt(year),
                            parseInt(month) - 1,
                            parseInt(day),
                            parseInt(hours) || 0,
                            parseInt(minutes) || 0
                        );
                    } else {
                        // Tentar parse padrão
                        date = new Date(dateTimeValue);
                    }
                }
                
                if (date && !isNaN(date.getTime())) {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }
            } catch (error) {
                console.log('Erro na conversão de data:', error, dateTimeValue);
            }
            
            // Se não conseguiu converter, retorna o valor original
            return dateTimeValue;
        }

        function processAndSaveData(data) {
            const headers = data[0];
            const rows = data.slice(1);
            
            const newDrivers = [];
            const newSuppliers = new Set();
            const newCDs = new Set();
            
            const existingDriversMap = new Map();
            driversData.forEach(driver => {
                if (driver.ticket) {
                    existingDriversMap.set(driver.ticket.toString().trim(), driver);
                }
            });
            
            let preservedCount = 0;
            let newCount = 0;
            
            rows.forEach((row) => {
                const driver = {};
                
                headers.forEach((header, colIndex) => {
                    if (header && columnMapping[header]) {
                        let value = row[colIndex];
                        
                        // Converter valores undefined/null para string vazia
                        if (value === null || value === undefined) {
                            value = '';
                        }
                        
                        // ✅ APLICAR CONVERSÃO APENAS NAS COLUNAS DE DATA/HORA
                        const colunasParaConverter = [
                            'DATA/HORA AGENDA',    // Coluna B
                            'DATA/HORA CHEG',      // Coluna G  
                            'ACIONADO',            // Coluna I
                            'FIM CONF',            // Coluna P
                            'INICIO CRIT',         // Coluna Q
                            'FIM CRIT'             // Coluna R
                        ];
                        
                        if (colunasParaConverter.includes(header) && value !== '') {
                            value = convertToDisplayFormat(value);
                        }
                        
                        driver[columnMapping[header]] = value;
                    }
                });
                
                if (driver.ticket) {
                    const ticketKey = driver.ticket.toString().trim();
                    
                    if (existingDriversMap.has(ticketKey)) {
                        const existingDriver = existingDriversMap.get(ticketKey);
                        
                        driver.contatoFeito = existingDriver.contatoFeito || '-';
                        driver.liberacaoEntregue = existingDriver.liberacaoEntregue || '-';
                        driver.encostouDoca = existingDriver.encostouDoca || '-';
                        
                        preservedCount++;
                    } else {
                        if (!driver.hasOwnProperty('contatoFeito')) driver.contatoFeito = '-';
                        if (!driver.hasOwnProperty('liberacaoEntregue')) driver.liberacaoEntregue = '-';
                        if (!driver.hasOwnProperty('encostouDoca')) driver.encostouDoca = '-';
                        
                        newCount++;
                    }
                    
                    newDrivers.push(driver);
                    
                    if (driver.supplier) newSuppliers.add(driver.supplier);
                    if (driver.cd) newCDs.add(driver.cd);
                }
            });
            
            driversData = newDrivers;
            suppliersList = Array.from(newSuppliers);
            cdList = Array.from(newCDs);
            
            const restoredCount = restoreProcessBackup();
            
            saveToLocalStorage();
            
            updateDatabaseStats();
            renderDriversTable();
            
            document.getElementById('file-input').value = '';
            
            showNotification(`✅ Base atualizada! ${newCount} novos registros, ${preservedCount} processos preservados`, 'success');
        }

        // ========== FUNÇÕES DE CÁLCULO DE TEMPO ========== //
        function calculateWaitTime(arrivalDateTime) {
            if (!arrivalDateTime || arrivalDateTime === '-') return '00:00:00';
            
            try {
                let arrival;
                
                if (typeof arrivalDateTime === 'number') {
                    // Converter serial date do Excel
                    const excelEpoch = new Date(1899, 11, 30);
                    arrival = new Date(excelEpoch.getTime() + arrivalDateTime * 86400 * 1000);
                } else {
                    // Usar a função de conversão existente
                    const converted = convertToDisplayFormat(arrivalDateTime);
                    if (converted && converted !== '-') {
                        const parts = converted.split(' ');
                        if (parts.length === 2) {
                            const datePart = parts[0].split('/');
                            const timePart = parts[1].split(':');
                            if (datePart.length === 3 && timePart.length >= 2) {
                                arrival = new Date(
                                    parseInt(datePart[2]),
                                    parseInt(datePart[1]) - 1,
                                    parseInt(datePart[0]),
                                    parseInt(timePart[0]),
                                    parseInt(timePart[1]),
                                    timePart[2] ? parseInt(timePart[2]) : 0
                                );
                            }
                        }
                    }
                }
                
                const now = new Date();
                if (!arrival || isNaN(arrival.getTime())) return '00:00:00';
                
                const diffMs = now - arrival;
                if (diffMs < 0) return '00:00:00';
                
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const diffSeconds = Math.floor((diffMs % (1000 * 60)) / 1000);
                
                return `${diffHours.toString().padStart(2, '0')}:${diffMinutes.toString().padStart(2, '0')}:${diffSeconds.toString().padStart(2, '0')}`;
                
            } catch (e) {
                return '00:00:00';
            }
        }

        function calculateWaitTimeValue(arrivalDateTime) {
            if (!arrivalDateTime || arrivalDateTime === '-') return 0;
            
            try {
                let arrival;
                
                if (typeof arrivalDateTime === 'number') {
                    const excelEpoch = new Date(1899, 11, 30);
                    arrival = new Date(excelEpoch.getTime() + arrivalDateTime * 86400 * 1000);
                } else {
                    const converted = convertToDisplayFormat(arrivalDateTime);
                    if (converted && converted !== '-') {
                        const parts = converted.split(' ');
                        if (parts.length === 2) {
                            const datePart = parts[0].split('/');
                            const timePart = parts[1].split(':');
                            if (datePart.length === 3 && timePart.length >= 2) {
                                arrival = new Date(
                                    parseInt(datePart[2]),
                                    parseInt(datePart[1]) - 1,
                                    parseInt(datePart[0]),
                                    parseInt(timePart[0]),
                                    parseInt(timePart[1]),
                                    timePart[2] ? parseInt(timePart[2]) : 0
                                );
                            }
                        }
                    }
                }
                
                const now = new Date();
                if (!arrival || isNaN(arrival.getTime())) return 0;
                
                return now - arrival;
                
            } catch (e) {
                return 0;
            }
        }

        // ========== FUNÇÕES SUPABASE ========== //
        async function loadFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('drivers')
                    .select('*')
                    .order('updated_at', { ascending: false });

                if (error) {
                    console.error('❌ Erro ao carregar do Supabase:', error);
                    updateSyncStatus(false);
                    return false;
                }

                if (data && data.length > 0) {
                    // ✅ CORREÇÃO: Preservar dados existentes e apenas atualizar processos
                    const existingTickets = new Set(driversData.map(d => d.ticket?.toString().trim()));
                    
                    data.forEach(item => {
                        const existingIndex = driversData.findIndex(d => 
                            d.ticket && d.ticket.toString().trim() === item.ticket?.toString().trim()
                        );
                        
                        if (existingIndex !== -1) {
                            // Atualizar apenas os campos de processo do registro existente
                            driversData[existingIndex].contatoFeito = item.contato_feito || '-';
                            driversData[existingIndex].liberacaoEntregue = item.liberacao_entregue || '-';
                            driversData[existingIndex].encostouDoca = item.encostou_doca || '-';
                        } else {
                            // Adicionar novo registro apenas se não existir
                            driversData.push({
                                ticket: item.ticket,
                                driverName: item.driver_name,
                                supplier: item.supplier,
                                cd: item.cd,
                                status: item.status,
                                arrivalDateTime: item.arrival_date_time || '-',
                                scheduleDateTime: item.schedule_date_time || '-',
                                truckPlate: item.truck_plate,
                                trailerPlate: item.trailer_plate,
                                contatoFeito: item.contato_feito || '-',
                                liberacaoEntregue: item.liberacao_entregue || '-',
                                encostouDoca: item.encostou_doca || '-',
                                load: item.load,
                                nfNumber: item.nf_number,
                                nfEmission: item.nf_emission || '-',
                                nfValue: item.nf_value,
                                equipmentType: item.equipment_type,
                                equipmentQty: item.equipment_qty,
                                confStart: item.conf_start || '-',
                                confEnd: item.conf_end || '-',
                                critStart: item.crit_start || '-',
                                critEnd: item.crit_end || '-',
                                critTime: item.crit_time,
                                releaseTime: item.release_time || '-',
                                warehouse: item.warehouse,
                                called: item.called || '-'
                            });
                        }
                    });
                    
                    lastUpdateTime = new Date().toISOString();
                    console.log(`✅ ${data.length} registros carregados do Supabase. Total na base: ${driversData.length}`);
                    return true;
                }
                console.log('ℹ️ Nenhum dado encontrado no Supabase');
                return false;
            } catch (error) {
                console.error('❌ Erro fatal ao carregar do Supabase:', error);
                updateSyncStatus(false);
                return false;
            }
        }

        function updateSyncStatus(online) {
            isOnline = online;
        }

        // ========== SISTEMA DE CARGA ========== //
        async function saveCargaData() {
            try {
                // Salvar no Supabase para sincronização em tempo real
                const cargaArray = Array.from(cargaData);
                
                const { data, error } = await supabase
                    .from('carga_data')
                    .upsert({
                        id: 1,
                        carga_list: cargaArray,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'id'
                    });

                if (error) throw error;

                // Também salvar localmente como fallback
                localStorage.setItem('cargaData', JSON.stringify(cargaArray));
                return true;
            } catch (error) {
                console.error('Erro ao salvar carga no Supabase:', error);
                // Fallback para localStorage
                const cargaArray = Array.from(cargaData);
                localStorage.setItem('cargaData', JSON.stringify(cargaArray));
                return false;
            }
        }

        async function loadCargaFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('carga_data')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (error) throw error;

                if (data && data.carga_list) {
                    cargaData = new Set(data.carga_list);
                    return true;
                }
            } catch (error) {
                console.log('Carregando carga do localStorage...');
            }
            
            // Fallback para localStorage
            return loadCargaData();
        }

        function loadCargaData() {
            const savedCargaData = localStorage.getItem('cargaData');
            if (savedCargaData) {
                try {
                    const cargaArray = JSON.parse(savedCargaData);
                    cargaData = new Set(cargaArray);
                    return true;
                } catch (e) {
                    cargaData = new Set();
                    return false;
                }
            }
            return false;
        }

        function checkCargaStatus(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (!driver || !driver.load) return false;
            return cargaData.has(driver.load.toString().trim());
        }

        function getCargaStatus(ticket) {
            const hasCarga = checkCargaStatus(ticket);
            return {
                status: hasCarga ? 'Gerado' : 'Pendente',
                class: hasCarga ? 'status-gerada' : 'status-pendente'
            };
        }

        async function handleCargaFileUpload(file) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const content = e.target.result;
                await processCargaFile(content, file.name);
            };
            
            reader.readAsText(file);
        }

        async function processCargaFile(content, fileName) {
            try {
                cargaData = new Set();
                const lines = content.split('\n');
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    const parts = line.split(';');
                    if (parts.length >= 4) {
                        const carga = parts[3].trim();
                        if (carga && carga !== '') {
                            cargaData.add(carga);
                        }
                    }
                }
                
                await saveCargaData();
                
                document.getElementById('carga-file-info').textContent = 
                    `Arquivo: ${fileName} | ${cargaData.size} cargas geradas identificadas`;
                
                renderEncostaList();
                
                // Mostrar mensagem de sucesso
                showNotification(`✅ Arquivo de carga processado com sucesso! ${cargaData.size} cargas identificadas.`, 'success');
                
            } catch (error) {
                console.error('Erro ao processar arquivo de carga:', error);
                showNotification('❌ Erro ao processar arquivo de carga. Verifique o formato do arquivo.', 'error');
            }
        }

        function debugCargaStatus(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (!driver) {
                alert(`❌ Senha ${ticket} não encontrada na base de dados`);
                return;
            }
            
            const hasCarga = checkCargaStatus(ticket);
            alert(`🔍 Debug Carga:\nSenha: ${ticket}\nCarga: ${driver.load || 'N/A'}\nStatus: ${hasCarga ? 'Gerado' : 'Pendente'}\n\nCargas no sistema: ${cargaData.size}`);
        }

        // ========== FUNÇÃO DE NOTIFICAÇÃO MINIMALISTA ========== //
        function showNotification(message, type = 'info', duration = 800) {
            const notification = document.createElement('div');
            notification.className = `notification-minimal ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, duration);
        }

        // ========== FUNÇÕES PRINCIPAIS DE DADOS ========== //
        async function loadData() {
            try {
                const success = await loadFromSupabase();
                if (success) {
                    updateSyncStatus(true);
                    return true;
                } else {
                    return loadFromLocalStorage();
                }
            } catch (error) {
                updateSyncStatus(false);
                return loadFromLocalStorage();
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('driversData', JSON.stringify(driversData));
            localStorage.setItem('suppliersList', JSON.stringify(suppliersList));
            localStorage.setItem('cdList', JSON.stringify(cdList));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('driversData');
            if (savedData) {
                driversData = JSON.parse(savedData);
                return true;
            }
            return false;
        }

        // ========== ATUALIZAÇÃO DA INTERFACE ========== //
        function updateInterface() {
            updateDatabaseStats();
            renderDriversTable();
            
            // Atualizar seções específicas se estiverem ativas
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const sectionId = activeSection.id;
                
                switch(sectionId) {
                    case 'encosta-section':
                        renderEncostaList();
                        break;
                    case 'report-section':
                        generateReport();
                        break;
                    case 'process-section':
                        if (currentDriver) renderProcessTimeline();
                        break;
                    case 'search-section':
                        if (currentDriver) displayDriverInfo(currentDriver);
                        break;
                }
            }
        }

        function setupAutoRefresh() {
            // Atualizar a interface a cada 2 segundos
            setInterval(() => {
                updateInterface();
            }, 2000);
        }

        // ========== INICIALIZAÇÃO ========== //
        async function initializeData() {
            // ✅ CORREÇÃO: Primeiro carregar dados base do localStorage
            console.log('📁 Carregando dados base do localStorage...');
            const hasLocalData = loadFromLocalStorage();
            
            if (hasLocalData && driversData.length > 0) {
                console.log(`✅ ${driversData.length} registros carregados do localStorage`);
            } else {
                console.log('📋 Nenhum dado no localStorage, criando dados de exemplo...');
                createSampleData();
            }

            // Testar conexão Supabase
            const supabaseConnected = await testSupabaseConnection();
            
            if (supabaseConnected) {
                console.log('🔄 Sincronizando processos do Supabase...');
                // Carregar backup de processos primeiro
                loadProcessBackup();
                
                // Sincronizar apenas processos do Supabase (sem substituir dados base)
                await loadFromSupabase();
            } else {
                console.log('📁 Supabase offline, usando dados locais...');
                // Apenas carregar backup local
                loadProcessBackup();
            }

            // Restaurar processos do backup automaticamente
            restoreProcessBackup();

            // Carregar dados de carga do Supabase
            await loadCargaFromSupabase();

            // Iniciar sistema de persistência automática
            initializePersistenceSystem();
            
            // Configurar atualização automática
            setupAutoRefresh();
            
            // Atualizar interface
            updateInterface();
            setupEventListeners();
            
            console.log('✅ Sistema inicializado com dados preservados');

            // Debug temporário para verificar conexão
            setTimeout(async () => {
                const testResult = await testSupabaseConnection();
                if (testResult) {
                    showNotification('✅ Conectado ao Supabase! Dados base preservados.', 'success', 3000);
                } else {
                    showNotification('❌ Supabase offline. Usando dados locais.', 'warning', 5000);
                }
            }, 2000);
        }

        // ========== CONFIGURAÇÃO DE EVENT LISTENERS - ATUALIZADA ========== //
        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    showSection(target);
                });
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const ticket = document.getElementById('ticket-input').value.trim();
                if (ticket) searchDriver(ticket);
            });
            
            document.getElementById('go-to-process').addEventListener('click', function() {
                showSection('process-section');
                renderProcessTimeline();
            });
            
            document.getElementById('report-generate').addEventListener('click', generateReport);
            document.getElementById('report-export-excel').addEventListener('click', exportReportToExcel);
            document.getElementById('report-clear-filters').addEventListener('click', clearReportFilters);
            
            document.getElementById('upload-btn').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            
            document.getElementById('upload-carga-btn').addEventListener('click', function() {
                document.getElementById('carga-file-input').click();
            });
            
            document.getElementById('carga-file-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    currentCargaFile = file;
                    handleCargaFileUpload(file);
                }
            });
            
            document.getElementById('refresh-carga-btn').addEventListener('click', function() {
                if (currentCargaFile) {
                    handleCargaFileUpload(currentCargaFile);
                } else {
                    alert('ℹ️ Nenhum arquivo de carga carregado. Por favor, carregue um arquivo TXT primeiro.');
                }
            });
            
            document.getElementById('debug-carga-btn').addEventListener('click', function() {
                const ticket = prompt("Digite a senha para verificar o status da carga:");
                if (ticket) {
                    debugCargaStatus(ticket);
                }
            });
            
            const uploadArea = document.getElementById('upload-area');
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) processFileImmediately(files[0]);
            });
            
            document.getElementById('reset-drivers-btn').addEventListener('click', function() {
                document.querySelectorAll('.filtro-input').forEach(input => input.value = '');
                activeFilters = {
                    ticket: '', driver: '', supplier: '', status: '', plate: '', arrival: ''
                };
                renderDriversTable();
            });
            
            document.getElementById('clear-database-btn').addEventListener('click', clearDatabase);
            setupColumnFilters();
            setupFilterListeners();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
        });

        // Limpar intervalos ao sair da página
        window.addEventListener('beforeunload', () => {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            if (supabaseSubscription) {
                supabaseSubscription.unsubscribe();
            }
        });
    </script>
</body>
</html>
