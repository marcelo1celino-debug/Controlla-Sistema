<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlla - Sistema de Controle de Comparecimento</title>
    
    <meta name="theme-color" content="#013A63">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #013A63;
            --secondary-color: #2ECC71;
            --warning-color: #F1C40F;
            --danger-color: #E74C3C;
            --light-bg: #F4F4F4;
            --dark-text: #333333;
            --light-text: #FFFFFF;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --info-color: #3498DB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--light-text);
            font-family: 'Inter', sans-serif;
            text-transform: lowercase;
        }
        .logo-text::first-letter {
            text-transform: uppercase;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }
        
        nav a {
            color: var(--light-text);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }
        
        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        main {
            padding: 30px 0;
            min-height: calc(100vh - 140px);
        }
        
        .section {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .section.active {
            display: block;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="text"], input[type="file"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text);
        }
        
        .btn-primary:hover {
            background-color: #012a4a;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: var(--light-text);
        }
        
        .btn-success:hover {
            background-color: #25a25a;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-text);
        }
        
        .btn-warning:hover {
            background-color: #d4ac0d;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--light-text);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: var(--light-text);
        }
        
        .btn-info:hover {
            background-color: #2980b9;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-outline {
            background-color: white;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .driver-info {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 400;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #ddd;
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: white;
        }
        
        .step-icon.completed {
            background-color: var(--secondary-color);
        }
        
        .step-icon.current {
            background-color: var(--warning-color);
        }
        
        .step-label {
            text-align: center;
            font-size: 0.9rem;
        }
        
        .step-actions {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 15px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        
        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .data-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: rgba(46, 204, 113, 0.2);
            border-left: 4px solid var(--secondary-color);
        }
        
        .alert-warning {
            background-color: rgba(241, 196, 15, 0.2);
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-danger {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid var(--danger-color);
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(1, 58, 99, 0.05);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .database-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        footer {
            background-color: var(--primary-color);
            color: var(--light-text);
            text-align: center;
            padding: 15px 0;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .column-filter {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .column-filter:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(1, 58, 99, 0.2);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-controls {
                flex-direction: column;
            }
            
            .control-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline {
                flex-direction: column;
                gap: 20px;
            }
            
            .timeline::before {
                display: none;
            }
            
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th, .data-table td {
                padding: 6px 8px;
            }
        }

        /* ========== FILTROS MODERNOS ========== */
        .filtros-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(1, 58, 99, 0.08);
            border: 1px solid #e2e8f0;
            margin: 20px 0;
            flex-wrap: nowrap;
            overflow-x: auto;
            min-height: 90px;
        }

        .filtro-grupo {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-width: 0;
        }

        .filtro-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filtro-input {
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #334155;
            font-family: 'Inter', sans-serif;
        }

        .filtro-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(1, 58, 99, 0.1);
            background: #fafbfc;
        }

        .filtro-input::placeholder {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .filtro-input:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        /* LARGURAS INDIVIDUAIS */
        .filtro-senha { width: 140px; }
        .filtro-motorista { width: 160px; }
        .filtro-fornecedor { width: 170px; }
        .filtro-status { width: 150px; }
        .filtro-placa { width: 140px; }
        .filtro-chegada { width: 160px; }

        /* RESPONSIVIDADE */
        @media (max-width: 1400px) {
            .filtros-container { gap: 10px; padding: 16px; }
            .filtro-senha { width: 130px; }
            .filtro-motorista { width: 150px; }
            .filtro-fornecedor { width: 160px; }
            .filtro-status { width: 140px; }
            .filtro-placa { width: 130px; }
            .filtro-chegada { width: 150px; }
        }

        @media (max-width: 1200px) {
            .filtros-container { flex-wrap: wrap; gap: 12px; }
            .filtro-grupo { flex: 1; min-width: 180px; }
            .filtro-senha, .filtro-motorista, .filtro-fornecedor,
            .filtro-status, .filtro-placa, .filtro-chegada { width: auto !important; }
        }

        .filtros-container::-webkit-scrollbar {
            height: 6px;
        }

        .filtros-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .filtros-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .filtros-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ========== SE√á√ÉO RELAT√ìRIO ========== */
        .report-section {
            padding: 20px;
        }

        .report-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .report-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #d4edda 100%);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        .report-info h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .report-stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }

        .report-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .report-table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .report-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .report-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .report-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }

        .report-table tr.completed {
            background-color: rgba(46, 204, 113, 0.1);
        }

        .report-table tr.in-progress {
            background-color: rgba(241, 196, 15, 0.1);
        }

        .report-table tr.pending {
            background-color: rgba(231, 76, 60, 0.05);
        }

        .status-online {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 10px;
        }

        /* ========== NOVOS ESTILOS PARA STATUS DE CARGA ========== */
        .status-gerada {
            background-color: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .status-pendente {
            background-color: var(--warning-color);
            color: var(--dark-text);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .carga-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .carga-info {
            background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%);
            border-left: 4px solid var(--primary-color);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* ========== ESTILOS PARA BOT√ïES DA ENCOSTA ========== */
        .processo-encosta {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .processo-encosta:hover {
            background-color: #012a4a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ========== NOVO ESTILO PARA STATUS DO PROCESSO - CORRIGIDO ========== */
        .status-processo {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            min-width: 120px;
        }

        .status-aguardando {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .status-contato {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-liberacao {
            background-color: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .status-doca {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* ========== ANIMA√á√ïES PARA ATUALIZA√á√ÉO AUTOM√ÅTICA ========== */
        @keyframes highlightUpdate {
            0% { background-color: rgba(46, 204, 113, 0.1); }
            100% { background-color: transparent; }
        }

        .updated-row {
            animation: highlightUpdate 1.5s ease-in-out;
        }

        /* ========== ESTILOS OCULTOS ========== */
        .hidden-controls {
            display: none !important;
        }

        /* ========== NOTIFICA√á√ïES DISCRETAS ========== */
        .notification-discreet {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .notification-discreet.show {
            opacity: 0.9;
        }

        /* ========== STATUS DE SINCRONIZA√á√ÉO DISCRETO ========== */
        .sync-status-discreet {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .sync-status-discreet.online {
            background-color: #2ECC71;
        }

        .sync-status-discreet.offline {
            background-color: #E74C3C;
        }

        .sync-status-discreet.syncing {
            background-color: #F1C40F;
            animation: pulse 1.5s infinite;
        }

        /* ========== REMOVER ELEMENTOS VISUAIS DESNECESS√ÅRIOS ========== */
        .auto-save-status {
            display: none !important;
        }

        /* Manter apenas notifica√ß√µes importantes por menos tempo */
        .notification-minimal {
            transition: all 0.3s ease;
        }

        .notification-minimal:not(.success):not(.error) {
            opacity: 0.7;
            font-size: 0.8rem;
            padding: 8px 12px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ========== CORRE√á√ÉO PARA BARRA DE ROLAGEM DA ENCOSTA ========== */
        .encosta-table-container {
            overflow-x: auto;
            width: 100%;
            position: relative;
        }

        /* ========== NOVO LAYOUT OTIMIZADO PARA ENCOSTA ========== */
        .encosta-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            table-layout: fixed;
        }

        .encosta-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .encosta-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .encosta-table tr:hover {
            background-color: rgba(1, 58, 99, 0.05);
        }

        /* LARGURAS OTIMIZADAS DAS COLUNAS */
        .encosta-table th:nth-child(1), .encosta-table td:nth-child(1) { width: 60px; }  /* Posi√ß√£o */
        .encosta-table th:nth-child(2), .encosta-table td:nth-child(2) { width: 80px; }  /* Senha */
        .encosta-table th:nth-child(3), .encosta-table td:nth-child(3) { width: 120px; } /* Motorista */
        .encosta-table th:nth-child(4), .encosta-table td:nth-child(4) { width: 120px; } /* Fornecedor */
        .encosta-table th:nth-child(5), .encosta-table td:nth-child(5) { width: 100px; } /* Placa */
        .encosta-table th:nth-child(6), .encosta-table td:nth-child(6) { width: 80px; }  /* Carga */
        .encosta-table th:nth-child(7), .encosta-table td:nth-child(7) { width: 120px; } /* Chegada */
        .encosta-table th:nth-child(8), .encosta-table td:nth-child(8) { width: 80px; }  /* Espera */
        .encosta-table th:nth-child(9), .encosta-table td:nth-child(9) { width: 90px; }  /* Carga Status */
        .encosta-table th:nth-child(10), .encosta-table td:nth-child(10) { width: 120px; } /* Processo Status */
        .encosta-table th:nth-child(11), .encosta-table td:nth-child(11) { width: 80px; }  /* A√ß√µes */

        /* RESPONSIVIDADE PARA ENCOSTA */
        @media (max-width: 1400px) {
            .encosta-table {
                font-size: 0.75rem;
            }
            
            .encosta-table th, .encosta-table td {
                padding: 6px 4px;
            }
            
            .encosta-table th:nth-child(3), .encosta-table td:nth-child(3) { width: 100px; } /* Motorista */
            .encosta-table th:nth-child(4), .encosta-table td:nth-child(4) { width: 100px; } /* Fornecedor */
            .encosta-table th:nth-child(7), .encosta-table td:nth-child(7) { width: 100px; } /* Chegada */
            .encosta-table th:nth-child(10), .encosta-table td:nth-child(10) { width: 100px; } /* Processo Status */
        }

        @media (max-width: 1200px) {
            .encosta-table {
                min-width: 1000px;
            }
        }

        /* ========== MODAL DE SENHA ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .modal-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background-color: var(--danger-color);
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #c0392b;
        }

        .modal-btn.cancel {
            background-color: #6c757d;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #5a6268;
        }

        /* ========== NOVO ESTILO PARA CARDS COMPACTOS ========== */
        .encosta-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .encosta-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }

        .encosta-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .encosta-card-position {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .encosta-card-ticket {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .encosta-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8rem;
        }

        .encosta-card-info {
            display: flex;
            flex-direction: column;
        }

        .encosta-card-label {
            font-size: 0.7rem;
            color: #666;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .encosta-card-value {
            font-size: 0.8rem;
            font-weight: 400;
        }

        .encosta-card-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }

        /* Alternar entre tabela e cards */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-end;
        }

        .view-toggle-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .view-toggle-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* ========== SISTEMA DE TEMAS DE CORES ========== */
        .theme-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .theme-toggle-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .theme-panel {
            position: absolute;
            bottom: 60px;
            right: 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .theme-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .theme-panel h4 {
            margin: 0 0 15px 0;
            color: var(--dark-text);
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .theme-option:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .theme-option.active {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .theme-option.active::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Cores dos temas */
        .theme-blue { background: linear-gradient(135deg, #013A63, #2ECC71); }
        .theme-green { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .theme-purple { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
        .theme-orange { background: linear-gradient(135deg, #e67e22, #f39c12); }
        .theme-red { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .theme-dark { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .theme-teal { background: linear-gradient(135deg, #16a085, #1abc9c); }
        .theme-pink { background: linear-gradient(135deg, #e84393, #fd79a8); }
        .theme-indigo { background: linear-gradient(135deg, #3742fa, #5352ed); }

        /* Responsividade para temas */
        @media (max-width: 768px) {
            .theme-selector {
                bottom: 15px;
                right: 15px;
            }
            
            .theme-toggle-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .theme-panel {
                min-width: 180px;
                padding: 15px;
            }
            
            .theme-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            .theme-option {
                width: 35px;
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="https://i.ibb.co/Y4H1km0F/Imagem-Controlla-Sistema-removebg-preview.png" alt="Controlla Logo" onerror="this.onerror=null;this.style.display='none';this.parentElement.innerHTML='üöõ';this.parentElement.style.fontSize='24px';this.parentElement.style.color='white';">
                    </div>
                    <div class="logo-text">CÔΩèÔΩéÔΩîÔΩíÔΩèÔΩåÔΩåÔΩÅ</div>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-target="search-section">üîç Buscar</a></li>
                        <li><a href="#" class="nav-link" data-target="process-section">üìã Processo</a></li>
                        <li><a href="#" class="nav-link" data-target="encosta-section">üöõ Encosta</a></li>
                        <li><a href="#" class="nav-link" data-target="report-section">üìä Relat√≥rio</a></li>
                        <li><a href="#" class="nav-link" data-target="database-section">üíæ Base de Dados</a></li>
                    </ul>
                </nav>
                <div id="sync-status-discreet" class="sync-status-discreet online" title="Sincronizado"></div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <section id="search-section" class="section active">
                <h1>Buscar Senha do Motorista</h1>
                <form class="search-form" id="search-form">
                    <input type="text" id="ticket-input" placeholder="Digite a senha do motorista (ex: 038685599)" required>
                    <button type="submit" class="btn btn-primary">Buscar Senha</button>
                </form>
                
                <div id="driver-result" style="display: none;">
                    <div class="alert alert-success">Senha localizada com sucesso!</div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="basic-info">Informa√ß√µes B√°sicas</div>
                        <div class="tab" data-tab="vehicle-info">Ve√≠culo e Carga</div>
                        <div class="tab" data-tab="process-info">Processo e Tempos</div>
                    </div>
                    
                    <div class="tab-content active" id="basic-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Senha</span>
                                    <span class="info-value" id="driver-ticket">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Motorista</span>
                                    <span class="info-value" id="driver-name">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fornecedor</span>
                                    <span class="info-value" id="driver-supplier">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">CD</span>
                                    <span class="info-value" id="driver-cd">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data/Hora Agenda</span>
                                    <span class="info-value" id="driver-schedule">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Data/Hora Chegada</span>
                                    <span class="info-value" id="driver-arrival">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status</span>
                                    <span class="info-value" id="driver-status">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Acionado</span>
                                    <span class="info-value" id="driver-called"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="vehicle-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Placa Cavalo</span>
                                    <span class="info-value" id="driver-truck-plate">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Placa Carreta</span>
                                    <span class="info-value" id="driver-trailer-plate">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tipo Equipamento</span>
                                    <span class="info-value" id="driver-equipment-type">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Quantidade Equipamentos</span>
                                    <span class="info-value" id="driver-equipment-qty">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">N√∫mero NF</span>
                                    <span class="info-value" id="driver-nf">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Emiss√£o NF</span>
                                    <span class="info-value" id="driver-nf-emission">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Valor NF</span>
                                    <span class="info-value" id="driver-nf-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Carga</span>
                                    <span class="info-value" id="driver-load">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="process-info">
                        <div class="driver-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">In√≠cio Confer√™ncia</span>
                                    <span class="info-value" id="driver-conf-start">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fim Confer√™ncia</span>
                                    <span class="info-value" id="driver-conf-end">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">In√≠cio Cr√≠tica</span>
                                    <span class="info-value" id="driver-crit-start">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fim Cr√≠tica</span>
                                    <span class="info-value" id="driver-crit-end">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tempo Cr√≠tica</span>
                                    <span class="info-value" id="driver-crit-time">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Hora Libera√ß√£o</span>
                                    <span class="info-value" id="driver-release">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Galp√£o CD</span>
                                    <span class="info-value" id="driver-warehouse">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status Processo</span>
                                    <span class="info-value" id="driver-process-status">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="go-to-process">Acompanhar Etapas</button>
                </div>
                
                <div id="driver-not-found" style="display: none;">
                    <div class="alert alert-danger">Senha n√£o encontrada. Verifique o n√∫mero e tente novamente.</div>
                </div>
            </section>
            
            <section id="process-section" class="section">
                <h1>Etapas do Processo</h1>
                <div id="process-content">
                    <div class="alert alert-warning">Selecione uma senha na se√ß√£o de busca para visualizar as etapas.</div>
                </div>
            </section>
            
            <section id="encosta-section" class="section">
                <h1>Encosta - Ranking por Hor√°rio de Chegada</h1>
                
                <div class="carga-info">
                    <strong>üìã Status de Carga:</strong> O sistema verifica automaticamente se a carga est√° gerada no arquivo TXT.
                    <br><strong>üîÑ Atualiza√ß√£o:</strong> Carregue um novo arquivo TXT para atualizar os status.
                    <br><strong>üîç Filtro:</strong> Agora exibindo apenas ve√≠culos AGENDADOS do arquivo atual com placa e carga preenchidos.
                </div>
                
                <div class="carga-controls">
                    <input type="file" id="carga-file-input" class="file-input" accept=".txt" style="display: none;">
                    <button class="btn btn-primary" id="upload-carga-btn">üìÅ Carregar Arquivo de Carga (TXT)</button>
                    <button class="btn btn-success" id="refresh-carga-btn">üîÑ Atualizar Status</button>
                    <button class="btn btn-warning" id="debug-carga-btn">üêõ Debug Carga</button>
                    <span id="carga-file-info" style="font-size: 0.9rem; color: #666; margin-left: 10px;">
                        Nenhum arquivo carregado
                    </span>
                </div>
                
                <div class="alert alert-info">
                    <strong>Ranking baseado no hor√°rio de chegada:</strong> Ve√≠culos s√£o ordenados pelos que chegaram mais cedo.
                    <br><strong>Filtro aplicado:</strong> Apenas ve√≠culos AGENDADOS do arquivo atual com placa e carga preenchidos.
                </div>
                
                <!-- Bot√µes de alternar visualiza√ß√£o -->
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="view-table-btn">üìä Visualiza√ß√£o em Tabela</button>
                    <button class="view-toggle-btn" id="view-cards-btn">üÉè Visualiza√ß√£o em Cards</button>
                </div>
                
                <div id="encosta-content">
                    <div class="empty-state">
                        <div>üöõ</div>
                        <p>Carregando lista de ve√≠culos para encosta...</p>
                    </div>
                </div>
            </section>
            
            <section id="report-section" class="section">
                <h1>üìä Relat√≥rio de Processos</h1>
                
                <div class="report-info">
                    <h3>üìä Relat√≥rio Completo das Etapas do Processo</h3>
                    <p>Exporte para Excel todos os registros das etapas: Contato Feito, Libera√ß√£o Entregue e Encostou em Doca.</p>
                </div>
                
                <div class="report-controls">
                    <div class="control-group">
                        <label for="report-start-date">Data Inicial:</label>
                        <input type="date" id="report-start-date" class="filtro-input">
                    </div>
                    <div class="control-group">
                        <label for="report-end-date">Data Final:</label>
                        <input type="date" id="report-end-date" class="filtro-input">
                    </div>
                    <button class="btn btn-primary" id="report-generate">Gerar Relat√≥rio</button>
                    <button class="btn btn-success" id="report-export-excel">üì• Exportar para Excel</button>
                    <button class="btn btn-warning" id="report-clear-filters">üîÑ Limpar Filtros</button>
                    <button class="btn btn-success" id="force-sync-btn">üîÑ Sincronizar Agora</button>
                    <button class="btn btn-danger" id="clear-all-processes">üóëÔ∏è Limpar Todos os Registros</button>
                    <button class="btn btn-info" id="clear-incomplete-processes">üóëÔ∏è Limpar Processos Incompletos</button>
                </div>
                
                <div class="report-stats" id="report-stats">
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="total-processes">0</div>
                        <div class="report-stat-label">Total de Processos</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="completed-processes">0</div>
                        <div class="report-stat-label">Processos Conclu√≠dos</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="in-progress-processes">0</div>
                        <div class="report-stat-label">Em Andamento</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="pending-processes">0</div>
                        <div class="report-stat-label">Pendentes</div>
                    </div>
                </div>
                
                <div class="report-table-container">
                    <table class="report-table" id="report-table">
                        <thead>
                            <tr>
                                <th>Senha</th>
                                <th>Motorista</th>
                                <th>Fornecedor</th>
                                <th>Contato Feito</th>
                                <th>Libera√ß√£o Entregue</th>
                                <th>Encostou em Doca</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="empty-state">
                                        <div>üìã</div>
                                        <p>Clique em "Gerar Relat√≥rio" para visualizar os dados</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="database-section" class="section">
                <h1>Gerenciamento da Base de Dados</h1>
                
                <div class="database-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-drivers">0</div>
                        <div class="stat-label">Motoristas Cadastrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-suppliers">0</div>
                        <div class="stat-label">Fornecedores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-processes">0</div>
                        <div class="stat-label">Processos Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completed-today">0</div>
                        <div class="stat-label">Finalizados Hoje</div>
                    </div>
                </div>
                
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">üì§</div>
                    <h3>Upload da Base de Dados</h3>
                    <p>Arraste um arquivo Excel ou CSV aqui ou clique para selecionar</p>
                    <p class="file-info">Formatos suportados: .xlsx, .xls, .csv</p>
                    <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="btn btn-primary" id="upload-btn">Selecionar Arquivo</button>
                </div>
                
                <div class="alert alert-warning" id="upload-instructions">
                    <strong>Estrutura esperada do arquivo:</strong><br>
                    - Coluna A: SENHA | B: DATA/HORA AGENDA | C: CD | D: FORNECEDOR | E: CARGA<br>
                    - Coluna F: STATUS | G: DATA/HORA CHEG | H: MOTORISTA | I: ACIONADO | J: NF<br>
                    - Coluna K: EMISS√ÉO | L: VALOR NF | M: PLACA CARRETA | N: PLACA CAVALO<br>
                    - Coluna O: INICIO CONF | P: FIM CONF | Q: INICIO CRIT | R: FIM CRIT<br>
                    - Coluna S: TEMPO CRIT | T: INI DIV COM | U: FIM DIV COM | V: TEMPO DIV COM<br>
                    - Coluna W: INI DIV TRIB | X: FIM DIV TRIB | Y: TEMPO DIV TRIB | Z: QTD EQUIP<br>
                    - Coluna AA: TIPO EQUIP | AB: HORA LIBERA√á√ÉO | AC: GALP√ÉO - CD 915<br>
                    - Coluna AD: TIPO RECUSA | AE: SETOR RECUSA | AF: MOTIVO RECUSA<br>
                    - Coluna AG: DETALHE RECUSA | AH: NF PALETES | AI: PEDIDOS NF<br>
                    - Coluna AJ: PEDIDOS C5 | AK: DIVERG√äNCIA DOS PEDIDOS
                </div>
                
                <div style="margin-top: 30px;">
                    <h2>Motoristas no Sistema</h2>
                    
                    <div class="dashboard-controls">
                        <button class="btn btn-success" id="force-sync-btn-2">üîÑ Sincronizar Agora</button>
                        <button class="btn btn-warning" id="reset-drivers-btn">Limpar Todos os Filtros</button>
                        <button class="btn btn-danger" id="clear-database-btn">Limpar Base de Dados</button>
                    </div>
                    
                    <div class="filtros-container">
                        <div class="filtro-grupo filtro-senha">
                            <label class="filtro-label" for="filter-ticket">Filtrar Senha</label>
                            <input type="text" id="filter-ticket" class="filtro-input" placeholder="Digite a senha...">
                        </div>
                        
                        <div class="filtro-grupo filtro-motorista">
                            <label class="filtro-label" for="filter-driver">Filtrar Motorista</label>
                            <input type="text" id="filter-driver" class="filtro-input" placeholder="Digite o nome...">
                        </div>
                        
                        <div class="filtro-grupo filtro-fornecedor">
                            <label class="filtro-label" for="filter-supplier">Filtrar Fornecedor</label>
                            <input type="text" id="filter-supplier" class="filtro-input" placeholder="Digite o fornecedor...">
                        </div>
                        
                        <div class="filtro-grupo filtro-status">
                            <label class="filtro-label" for="filter-status">Filtrar Status</label>
                            <input type="text" id="filter-status" class="filtro-input" placeholder="Digite o status...">
                        </div>
                        
                        <div class="filtro-grupo filtro-placa">
                            <label class="filtro-label" for="filter-plate">Filtrar Placa</label>
                            <input type="text" id="filter-plate" class="filtro-input" placeholder="Digite a placa...">
                        </div>
                        
                        <div class="filtro-grupo filtro-chegada">
                            <label class="filtro-label" for="filter-arrival">Filtrar Chegada</label>
                            <input type="text" id="filter-arrival" class="filtro-input" placeholder="Digite a data/hora...">
                        </div>
                    </div>
                    
                    <div class="results-info" id="results-info" style="
                        margin: 15px 0;
                        padding: 10px 15px;
                        background-color: #e8f4fd;
                        border-radius: var(--border-radius);
                        font-size: 0.9rem;
                        color: var(--primary-color);
                    ">
                        Mostrando todos os registros
                    </div>
                    
                    <div id="drivers-table-container" style="overflow-x: scroll; overflow-y: auto; max-height: 600px; white-space: nowrap;">
                        <table class="data-table" id="drivers-table" style="min-width: 100%;">
                            <thead>
                                <tr>
                                    <th>Senha</th>
                                    <th>Motorista</th>
                                    <th>Fornecedor</th>
                                    <th>CD</th>
                                    <th>Placa</th>
                                    <th>Status</th>
                                    <th>Chegada</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="drivers-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>CÔΩèÔΩéÔΩîÔΩíÔΩèÔΩåÔΩåÔΩÅ - Sistema de Controle de Comparecimento | De &copy; 2025</p>
        </div>
    </footer>

    <!-- ========== SISTEMA DE TEMAS ========== -->
    <div class="theme-selector">
        <button class="theme-toggle-btn" id="theme-toggle">
            üé®
        </button>
        <div class="theme-panel" id="theme-panel">
            <h4>Escolha um Tema</h4>
            <div class="theme-options">
                <div class="theme-option theme-blue active" data-theme="blue" title="Azul Original"></div>
                <div class="theme-option theme-green" data-theme="green" title="Verde Natureza"></div>
                <div class="theme-option theme-purple" data-theme="purple" title="Roxo Elegante"></div>
                <div class="theme-option theme-orange" data-theme="orange" title="Laranja Energ√©tico"></div>
                <div class="theme-option theme-red" data-theme="red" title="Vermelho Intenso"></div>
                <div class="theme-option theme-dark" data-theme="dark" title="Escuro Profissional"></div>
                <div class="theme-option theme-teal" data-theme="teal" title="Verde √Ågua"></div>
                <div class="theme-option theme-pink" data-theme="pink" title="Rosa Moderno"></div>
                <div class="theme-option theme-indigo" data-theme="indigo" title="√çndigo Corporativo"></div>
            </div>
        </div>
    </div>

    <div id="notification-discreet" class="notification-discreet"></div>

    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">üîí Confirma√ß√£o de Seguran√ßa</h3>
            <p style="margin-bottom: 20px; color: #666;">Digite a senha para confirmar esta a√ß√£o:</p>
            <input type="password" id="password-input" class="modal-input" placeholder="Digite a senha...">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancel-password">Cancelar</button>
                <button class="modal-btn confirm" id="confirm-password">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CORRE√á√ÉO DOS ERROS CR√çTICOS ========== //
        // Solu√ß√£o para "Tracking Prevention" e "supabase already declared"
        
        // ========== SISTEMA DE STORAGE SEGURO ========== //
        // Wrapper seguro para localStorage que evita erros de Tracking Prevention
        const safeStorage = {
            setItem: function(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (error) {
                    console.warn('Storage bloqueado pelo navegador, usando fallback:', error);
                    // Fallback para sessionStorage
                    try {
                        sessionStorage.setItem(key, value);
                    } catch (e) {
                        console.warn('SessionStorage tamb√©m bloqueado:', e);
                        // Fallback final: objeto em mem√≥ria
                        if (!window.memoryStorage) window.memoryStorage = {};
                        window.memoryStorage[key] = value;
                    }
                }
            },
            
            getItem: function(key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('Storage bloqueado pelo navegador, usando fallback:', error);
                    // Tentar sessionStorage
                    try {
                        return sessionStorage.getItem(key);
                    } catch (e) {
                        console.warn('SessionStorage tamb√©m bloqueado:', e);
                        // Fallback final: objeto em mem√≥ria
                        if (window.memoryStorage && window.memoryStorage[key]) {
                            return window.memoryStorage[key];
                        }
                        return null;
                    }
                }
            },
            
            removeItem: function(key) {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.warn('Storage bloqueado pelo navegador:', error);
                    // Tentar sessionStorage
                    try {
                        sessionStorage.removeItem(key);
                    } catch (e) {
                        console.warn('SessionStorage tamb√©m bloqueado:', e);
                        // Fallback final: objeto em mem√≥ria
                        if (window.memoryStorage) {
                            delete window.memoryStorage[key];
                        }
                    }
                }
            }
        };

        // ========== CONFIGURA√á√ÉO SUPABASE ========== //
        const SUPABASE_URL = 'https://nuebpjbozdcawkkgnqfe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZWJwamJvemRjYXdra2ducWZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODczOTYsImV4cCI6MjA3NzE2MzM5Nn0.2hpn6WyYJovBeoY50EeRcx3_qcgCgI6QKGKkkNi3AlI';

        // ‚úÖ CORRE√á√ÉO: Declara√ß√£o √∫nica da vari√°vel supabase
        let supabaseClient;
        
        // Fun√ß√£o para inicializar o Supabase de forma segura
        function initializeSupabase() {
            try {
                if (window.supabase && window.supabase.createClient) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase inicializado com sucesso');
                    return supabaseClient;
                } else {
                    console.warn('Supabase n√£o carregado, usando modo offline');
                    return createMockSupabase();
                }
            } catch (error) {
                console.error('Erro ao inicializar Supabase:', error);
                return createMockSupabase();
            }
        }

        // Fun√ß√£o para criar um mock do Supabase quando n√£o estiver dispon√≠vel
        function createMockSupabase() {
            return {
                from: () => ({ 
                    select: () => Promise.resolve({ data: [], error: null }),
                    upsert: () => Promise.resolve({ error: null }),
                    delete: () => Promise.resolve({ error: null }),
                    on: () => ({ subscribe: () => ({ unsubscribe: () => {} }) })
                }),
                channel: () => ({ 
                    on: () => ({ subscribe: () => ({ unsubscribe: () => {} }) }) 
                })
            };
        }

        // Inicializar o Supabase
        supabaseClient = initializeSupabase();

        // Estado da aplica√ß√£o
        let currentDriver = null;
        let driversData = [];
        let suppliersList = [];
        let cdList = [];
        let isOnline = true;
        let lastUpdateTime = null;
        
        // ========== DADOS DO ARQUIVO ATUAL COM PERSIST√äNCIA ========== //
        let currentFileData = [];
        let currentFileName = '';
        
        // ========== SISTEMA DE SINCRONIZA√á√ÉO EM TEMPO REAL ========== //
        let realtimeSubscription = null;

        // ========== SISTEMA DE PERSIST√äNCIA AUTOM√ÅTICA OTIMIZADA ========== //
        let autoSaveInterval;
        let dataChangeDetected = false;

        // ========== SISTEMA DE BACKUP AUTOM√ÅTICO DE PROCESSOS ========== //
        let processBackupData = {};
        
        // ========== SISTEMA DE CARGA ========== //
        let cargaData = new Set();
        let currentCargaFile = null;

        // ========== SISTEMA DE SENHA DE SEGURAN√áA ========== //
        const SECURITY_PASSWORD = "Assai";
        let pendingAction = null;

        // ========== SISTEMA DE VISUALIZA√á√ÉO DA ENCOSTA ========== //
        let encostaViewMode = 'table'; // 'table' ou 'cards'

        // ========== SISTEMA DE TEMAS ========== //
        let currentTheme = 'blue';

        // ========== CACHE PARA PERFORMANCE ========== //
        let renderCache = {
            encosta: { data: null, timestamp: 0, ttl: 30000 }, // 30 segundos
            drivers: { data: null, timestamp: 0, ttl: 30000 }
        };

        // ========== CACHE OTIMIZADO PARA ENCOSTA ========== //
        let processStatusCache = new Map(); // Cache de status de processo por ticket
        let encostaSortedCache = null; // Cache da lista ordenada da encosta
        let encostaCacheTimestamp = 0; // Timestamp do cache
        let encostaCacheTTL = 10000; // 10 segundos de cache

        // Mapeamento de colunas
        const columnMapping = {
            'SENHA': 'ticket',
            'DATA/HORA AGENDA': 'scheduleDateTime',
            'CD': 'cd',
            'FORNECEDOR': 'supplier',
            'CARGA': 'load',
            'STATUS': 'status',
            'DATA/HORA CHEG': 'arrivalDateTime',
            'MOTORISTA': 'driverName',
            'ACIONADO': 'called',
            'NF': 'nfNumber',
            'EMISS√ÉO': 'nfEmission',
            'VALOR NF': 'nfValue',
            'PLACA CARRETA': 'trailerPlate',
            'PLACA CAVALO': 'truckPlate',
            'INICIO CONF': 'confStart',
            'FIM CONF': 'confEnd',
            'INICIO CRIT': 'critStart',
            'FIM CRIT': 'critEnd',
            'TEMPO CRIT': 'critTime',
            'INI DIV COM': 'divComStart',
            'FIM DIV COM': 'divComEnd',
            'TEMPO DIV COM': 'divComTime',
            'INI DIV TRIB': 'divTribStart',
            'FIM DIV TRIB': 'divTribEnd',
            'TEMPO DIV TRIB': 'divTribTime',
            'QTD EQUIP': 'equipmentQty',
            'TIPO EQUIP': 'equipmentType',
            'HORA LIBERA√á√ÉO': 'releaseTime',
            'GALP√ÉO - CD 915': 'warehouse',
            'TIPO RECUSA': 'refusalType',
            'SETOR RECUSA': 'refusalSector',
            'MOTIVO RECUSA': 'refusalReason',
            'DETALHE RECUSA': 'refusalDetail',
            'NF PALETES': 'nfPallets',
            'PEDIDOS NF': 'nfOrders',
            'PEDIDOS C5': 'c5Orders',
            'DIVERG√äNCIA DOS PEDIDOS': 'orderDivergence'
        };

        // ========== SISTEMA DE TEMAS ========== //
        const themes = {
            blue: {
                primary: '#013A63',
                secondary: '#2ECC71',
                warning: '#F1C40F',
                danger: '#E74C3C',
                info: '#3498DB'
            },
            green: {
                primary: '#27ae60',
                secondary: '#2ecc71',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            purple: {
                primary: '#8e44ad',
                secondary: '#9b59b6',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            orange: {
                primary: '#e67e22',
                secondary: '#f39c12',
                warning: '#f1c40f',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            red: {
                primary: '#c0392b',
                secondary: '#e74c3c',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            dark: {
                primary: '#2c3e50',
                secondary: '#34495e',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            teal: {
                primary: '#16a085',
                secondary: '#1abc9c',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            pink: {
                primary: '#e84393',
                secondary: '#fd79a8',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            },
            indigo: {
                primary: '#3742fa',
                secondary: '#5352ed',
                warning: '#f39c12',
                danger: '#e74c3c',
                info: '#3498DB'
            }
        };

        // ========== FUN√á√ïES PRINCIPAIS - ORGANIZADAS PARA EVITAR ERROS ========== //

        // ========== FUN√á√ïES DE UTILIDADE ========== //
        function showDiscreetNotification(message, duration = 2000) {
            const notification = document.getElementById('notification-discreet');
            if (!notification) return;
            
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function getStepName(stepField) {
            const stepNames = {
                'contatoFeito': 'Contato Feito',
                'liberacaoEntregue': 'Libera√ß√£o Entregue', 
                'encostouDoca': 'Encostou em Doca'
            };
            return stepNames[stepField] || stepField;
        }

        // ========== FUN√á√ÉO OTIMIZADA PARA GET PROCESS STATUS ========== //
        function getProcessStatusOptimized(driver) {
            if (!driver) return 'N√£o definido';
            
            const ticket = driver.ticket?.toString().trim();
            if (!ticket) return 'N√£o definido';
            
            // Verificar cache primeiro
            if (processStatusCache.has(ticket)) {
                return processStatusCache.get(ticket);
            }
            
            // Garantir que temos os campos
            const contatoFeito = driver.contatoFeito || '-';
            const liberacaoEntregue = driver.liberacaoEntregue || '-';
            const encostouDoca = driver.encostouDoca || '-';
            
            let status;
            
            if (encostouDoca && encostouDoca !== '-') {
                status = 'Encostou em Doca';
            } else if (liberacaoEntregue && liberacaoEntregue !== '-') {
                status = 'Libera√ß√£o Entregue';
            } else if (contatoFeito && contatoFeito !== '-') {
                status = 'Contato Feito';
            } else {
                status = 'Aguardando Contato';
            }
            
            // Armazenar no cache
            processStatusCache.set(ticket, status);
            return status;
        }

        function getProcessStatus(driver) {
            return getProcessStatusOptimized(driver);
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // ========== FUN√á√ÉO OTIMIZADA PARA CALCULAR ESPERA ========== //
        function calculateWaitTimeOptimized(arrivalDateTime) {
            if (!arrivalDateTime || arrivalDateTime === '-') return '00:00:00';
            
            try {
                let arrival;
                
                if (typeof arrivalDateTime === 'number') {
                    const excelEpoch = new Date(1899, 11, 30);
                    arrival = new Date(excelEpoch.getTime() + arrivalDateTime * 86400 * 1000);
                } else {
                    const parts = arrivalDateTime.toString().split(' ');
                    if (parts.length === 2) {
                        const datePart = parts[0].split('/');
                        const timePart = parts[1].split(':');
                        if (datePart.length === 3 && timePart.length >= 2) {
                            arrival = new Date(
                                parseInt(datePart[2]),
                                parseInt(datePart[1]) - 1,
                                parseInt(datePart[0]),
                                parseInt(timePart[0]),
                                parseInt(timePart[1]),
                                timePart[2] ? parseInt(timePart[2]) : 0
                            );
                        }
                    }
                }
                
                if (!arrival || isNaN(arrival.getTime())) return '00:00:00';
                
                const now = new Date();
                const diffMs = now - arrival;
                if (diffMs < 0) return '00:00:00';
                
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const diffSeconds = Math.floor((diffMs % (1000 * 60)) / 1000);
                
                return `${diffHours.toString().padStart(2, '0')}:${diffMinutes.toString().padStart(2, '0')}:${diffSeconds.toString().padStart(2, '0')}`;
                
            } catch (e) {
                return '00:00:00';
            }
        }

        function calculateWaitTime(arrivalDateTime) {
            return calculateWaitTimeOptimized(arrivalDateTime);
        }

        function calculateWaitTimeValue(arrivalDateTime) {
            if (!arrivalDateTime || arrivalDateTime === '-') return 0;
            
            try {
                let arrival;
                
                if (typeof arrivalDateTime === 'number') {
                    const excelEpoch = new Date(1899, 11, 30);
                    arrival = new Date(excelEpoch.getTime() + arrivalDateTime * 86400 * 1000);
                } else {
                    const parts = arrivalDateTime.toString().split(' ');
                    if (parts.length === 2) {
                        const datePart = parts[0].split('/');
                        const timePart = parts[1].split(':');
                        if (datePart.length === 3 && timePart.length >= 2) {
                            arrival = new Date(
                                parseInt(datePart[2]),
                                parseInt(datePart[1]) - 1,
                                parseInt(datePart[0]),
                                parseInt(timePart[0]),
                                parseInt(timePart[1]),
                                timePart[2] ? parseInt(timePart[2]) : 0
                            );
                        }
                    }
                }
                
                if (!arrival || isNaN(arrival.getTime())) return 0;
                
                const now = new Date();
                return now - arrival;
                
            } catch (e) {
                return 0;
            }
        }

        function convertToDisplayFormat(dateTimeValue, columnHeader = '') {
            if (!dateTimeValue || dateTimeValue === '-' || dateTimeValue === '' || dateTimeValue === ' ') return '-';
            
            try {
                if (typeof dateTimeValue === 'string' && dateTimeValue.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/)) {
                    return dateTimeValue;
                }
                
                let date;
                
                if (typeof dateTimeValue === 'number') {
                    const excelEpoch = new Date(1899, 11, 30);
                    date = new Date(excelEpoch.getTime() + dateTimeValue * 86400 * 1000);
                    
                    date = new Date(date.getTime() - (6 * 60 * 1000));
                    
                    if (columnHeader === 'DATA/HORA AGENDA') {
                        date = new Date(date.getTime() + 50);
                    }
                } else if (dateTimeValue instanceof Date) {
                    date = dateTimeValue;
                    
                    if (columnHeader === 'DATA/HORA AGENDA') {
                        date = new Date(date.getTime() + 50);
                    }
                } else {
                    const parts = dateTimeValue.toString().split(' ');
                    const datePart = parts[0];
                    const timePart = parts[1] || '00:00';
                    
                    if (datePart && datePart.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        const [day, month, year] = datePart.split('/');
                        const [hours, minutes] = timePart.split(':');
                        
                        date = new Date(
                            parseInt(year),
                            parseInt(month) - 1,
                            parseInt(day),
                            parseInt(hours) || 0,
                            parseInt(minutes) || 0
                        );
                    } else {
                        date = new Date(dateTimeValue);
                    }
                }
                
                if (date && !isNaN(date.getTime())) {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }
            } catch (error) {
                console.log('Erro na convers√£o de data:', error, dateTimeValue);
            }
            
            return dateTimeValue;
        }

        // ========== FUN√á√ÉO PARA INVALIDAR CACHE DA ENCOSTA ========== //
        function invalidateEncostaCache() {
            encostaSortedCache = null;
            processStatusCache.clear();
            renderCache.encosta.data = null;
            renderCache.encosta.timestamp = 0;
        }

        // ========== FUN√á√ÉO OTIMIZADA PARA BUSCAR DADOS DA ENCOSTA ========== //
        function getEncostaDataOptimized() {
            const now = Date.now();
            
            // Verificar cache primeiro
            if (encostaSortedCache && (now - encostaCacheTimestamp) < encostaCacheTTL) {
                console.log('üì¶ Usando cache otimizado da encosta');
                return encostaSortedCache;
            }
            
            console.time('EncostaProcessing');
            
            // 1. Criar √≠ndice r√°pido dos dados de processo
            const processIndex = new Map();
            driversData.forEach(driver => {
                if (driver.ticket) {
                    const ticket = driver.ticket.toString().trim();
                    processIndex.set(ticket, {
                        contatoFeito: driver.contatoFeito || '-',
                        liberacaoEntregue: driver.liberacaoEntregue || '-',
                        encostouDoca: driver.encostouDoca || '-',
                        processStatus: getProcessStatusOptimized(driver)
                    });
                }
            });
            
            // 2. Filtrar e processar em uma √∫nica passada
            const filtered = [];
            
            for (const driver of currentFileData) {
                if (!driver.status || driver.status.toString().trim().toUpperCase() !== 'AGENDADO') {
                    continue;
                }
                
                const hasPlaca = driver.truckPlate && 
                                driver.truckPlate.toString().trim() !== '' && 
                                driver.truckPlate.toString().trim() !== '-';
                
                const hasCarga = driver.load && 
                                driver.load.toString().trim() !== '' && 
                                driver.load.toString().trim() !== '-';
                
                if (!hasPlaca || !hasCarga) {
                    continue;
                }
                
                // Buscar status do processo do √≠ndice (O(1))
                const processData = processIndex.get(driver.ticket?.toString().trim()) || {
                    contatoFeito: '-',
                    liberacaoEntregue: '-',
                    encostouDoca: '-',
                    processStatus: 'Aguardando Contato'
                };
                
                // Calcular tempo de espera otimizado
                const waitTime = calculateWaitTimeOptimized(driver.arrivalDateTime);
                
                // Verificar carga (acesso O(1) ao Set)
                const hasCargaGerada = cargaData.has(driver.load?.toString().trim());
                const cargaStatus = hasCargaGerada ? {
                    status: 'Gerado',
                    class: 'status-gerada'
                } : {
                    status: 'Pendente',
                    class: 'status-pendente'
                };
                
                filtered.push({
                    ...driver,
                    processData,
                    waitTime,
                    cargaStatus
                });
            }
            
            // 3. Ordenar com algoritmo otimizado
            filtered.sort((a, b) => {
                // Converter datas apenas uma vez para compara√ß√£o
                const timeA = calculateWaitTimeOptimized(a.arrivalDateTime);
                const timeB = calculateWaitTimeOptimized(b.arrivalDateTime);
                
                // Comparar strings diretamente (formato HH:MM:SS)
                return timeB.localeCompare(timeA);
            });
            
            encostaSortedCache = filtered;
            encostaCacheTimestamp = now;
            
            console.timeEnd('EncostaProcessing');
            console.log(`‚úÖ Encosta otimizada: ${filtered.length} registros processados`);
            
            return filtered;
        }

        // ========== FUN√á√ÉO OTIMIZADA DE RENDERIZA√á√ÉO DA ENCOSTA ========== //
        function renderEncostaListOptimized() {
            const encostaContent = document.getElementById('encosta-content');
            if (!encostaContent) return;
            
            const now = Date.now();
            const cache = renderCache.encosta;
            
            if (cache.data && (now - cache.timestamp) < cache.ttl) {
                console.log('üì¶ Usando cache de renderiza√ß√£o da encosta');
                encostaContent.innerHTML = cache.data;
                return;
            }
            
            // Obter dados otimizados
            const filteredDrivers = getEncostaDataOptimized();
            
            const cargasGeradasCount = filteredDrivers.filter(driver => 
                driver.cargaStatus.status === 'Gerado'
            ).length;
            
            if (filteredDrivers.length === 0) {
                const html = `
                    <div class="empty-state">
                        <div>üìã</div>
                        <p>Nenhum ve√≠culo com status AGENDADO encontrado no arquivo atual para exibir na encosta.</p>
                        <p><strong>Filtro aplicado:</strong> Apenas ve√≠culos do arquivo atual com placa e carga preenchidos.</p>
                        <small>Total de ve√≠culos no arquivo: ${currentFileData.length}</small>
                    </div>
                `;
                encostaContent.innerHTML = html;
                renderCache.encosta.data = html;
                renderCache.encosta.timestamp = now;
                return;
            }
            
            // Gerar HTML com dados j√° processados
            let html;
            if (encostaViewMode === 'table') {
                html = renderEncostaTableViewOptimized(filteredDrivers, cargasGeradasCount);
            } else {
                html = renderEncostaCardsViewOptimized(filteredDrivers, cargasGeradasCount);
            }
            
            encostaContent.innerHTML = html;
            renderCache.encosta.data = html;
            renderCache.encosta.timestamp = now;
        }

        // ========== RENDERIZA√á√ÉO OTIMIZADA DA TABELA ========== //
        function renderEncostaTableViewOptimized(filteredDrivers, cargasGeradasCount) {
            let html = `
                <div class="database-stats">
                    <div class="stat-card">
                        <div class="stat-value">${filteredDrivers.length}</div>
                        <div class="stat-label">Ve√≠culos na Fila</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${cargasGeradasCount}</div>
                        <div class="stat-label">Cargas Geradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${filteredDrivers.length - cargasGeradasCount}</div>
                        <div class="stat-label">Cargas Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${currentFileData.length}</div>
                        <div class="stat-label">Total no Arquivo</div>
                    </div>
                </div>
                
                <h3>Ranking de Chamada - Ordem de Espera (Mais Tempo Esperando Primeiro)</h3>
                <div class="encosta-table-container">
                    <table class="encosta-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Senha</th>
                                <th>Motorista</th>
                                <th>Fornecedor</th>
                                <th>Placa</th>
                                <th>Carga</th>
                                <th>Chegada</th>
                                <th>Espera</th>
                                <th>Carga</th>
                                <th>Processo</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredDrivers.forEach((driver, index) => {
                const processoStatus = driver.processData.processStatus;
                
                let statusClass = '';
                let statusText = processoStatus;
                
                switch(processoStatus) {
                    case 'Aguardando Contato':
                        statusClass = 'status-aguardando';
                        break;
                    case 'Contato Feito':
                        statusClass = 'status-contato';
                        break;
                    case 'Libera√ß√£o Entregue':
                        statusClass = 'status-liberacao';
                        break;
                    case 'Encostou em Doca':
                        statusClass = 'status-doca';
                        break;
                    default:
                        statusClass = 'status-aguardando';
                }
                
                html += `
                    <tr>
                        <td><strong>${index + 1}¬∫</strong></td>
                        <td>${driver.ticket || '-'}</td>
                        <td title="${driver.driverName || '-'}">${truncateText(driver.driverName || '-', 15)}</td>
                        <td title="${driver.supplier || '-'}">${truncateText(driver.supplier || '-', 15)}</td>
                        <td>${driver.truckPlate || '-'}</td>
                        <td>${driver.load || '-'}</td>
                        <td title="${driver.arrivalDateTime || '-'}">${truncateText(driver.arrivalDateTime || '-', 12)}</td>
                        <td>${driver.waitTime}</td>
                        <td><span class="${driver.cargaStatus.class}">${driver.cargaStatus.status}</span></td>
                        <td><span class="${statusClass}">${truncateText(statusText, 12)}</span></td>
                        <td>
                            <button class="btn btn-primary btn-small processo-encosta" data-ticket="${driver.ticket}" title="Abrir processo">Processo</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
            
            return html;
        }

        // ========== RENDERIZA√á√ÉO OTIMIZADA DOS CARDS ========== //
        function renderEncostaCardsViewOptimized(filteredDrivers, cargasGeradasCount) {
            let html = `
                <div class="database-stats">
                    <div class="stat-card">
                        <div class="stat-value">${filteredDrivers.length}</div>
                        <div class="stat-label">Ve√≠culos na Fila</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${cargasGeradasCount}</div>
                        <div class="stat-label">Cargas Geradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${filteredDrivers.length - cargasGeradasCount}</div>
                        <div class="stat-label">Cargas Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${currentFileData.length}</div>
                        <div class="stat-label">Total no Arquivo</div>
                    </div>
                </div>
                
                <h3>Ranking de Chamada - Ordem de Espera (Mais Tempo Esperando Primeiro)</h3>
                <div class="encosta-cards">
            `;
            
            filteredDrivers.forEach((driver, index) => {
                const processoStatus = driver.processData.processStatus;
                
                let statusClass = '';
                let statusText = processoStatus;
                
                switch(processoStatus) {
                    case 'Aguardando Contato':
                        statusClass = 'status-aguardando';
                        break;
                    case 'Contato Feito':
                        statusClass = 'status-contato';
                        break;
                    case 'Libera√ß√£o Entregue':
                        statusClass = 'status-liberacao';
                        break;
                    case 'Encostou em Doca':
                        statusClass = 'status-doca';
                        break;
                    default:
                        statusClass = 'status-aguardando';
                }
                
                html += `
                    <div class="encosta-card">
                        <div class="encosta-card-header">
                            <div class="encosta-card-position">${index + 1}¬∫</div>
                            <div class="encosta-card-ticket">${driver.ticket || '-'}</div>
                        </div>
                        <div class="encosta-card-body">
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Motorista</span>
                                <span class="encosta-card-value">${driver.driverName || '-'}</span>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Fornecedor</span>
                                <span class="encosta-card-value">${driver.supplier || '-'}</span>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Placa</span>
                                <span class="encosta-card-value">${driver.truckPlate || '-'}</span>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Carga</span>
                                <span class="encosta-card-value">${driver.load || '-'}</span>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Chegada</span>
                                <span class="encosta-card-value">${driver.arrivalDateTime || '-'}</span>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Espera</span>
                                <span class="encosta-card-value">${driver.waitTime}</td>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Status Carga</span>
                                <span class="encosta-card-value"><span class="${driver.cargaStatus.class}">${driver.cargaStatus.status}</span></span>
                            </div>
                            <div class="encosta-card-info">
                                <span class="encosta-card-label">Status Processo</span>
                                <span class="encosta-card-value"><span class="${statusClass}">${statusText}</span></span>
                            </div>
                        </div>
                        <div class="encosta-card-actions">
                            <button class="btn btn-primary btn-small processo-encosta" data-ticket="${driver.ticket}">Processo</button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            return html;
        }

        // ========== SISTEMA DE SINCRONIZA√á√ÉO ========== //
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabaseClient
                    .from('drivers')
                    .select('ticket, contato_feito, liberacao_entregue, encostou_doca, driver_name, supplier')
                    .limit(1);
                    
                if (error) {
                    console.error('‚ùå Erro na conex√£o Supabase:', error);
                    return false;
                }
                
                console.log('‚úÖ Conex√£o Supabase estabelecida com sucesso!');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao conectar com Supabase:', error);
                return false;
            }
        }

        function updateSyncStatus(online, message = '') {
            isOnline = online;
            const syncElement = document.getElementById('sync-status-discreet');
            
            if (syncElement) {
                syncElement.className = 'sync-status-discreet ' + (online ? 'online' : 'offline');
                syncElement.title = message || (online ? 'Sincronizado' : 'Offline');
            }
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO MODIFICADA PARA CARREGAR APENAS PROCESSOS DO SUPABASE
        async function loadProcessesFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('drivers')
                    .select('ticket, contato_feito, liberacao_entregue, encostou_doca, driver_name, supplier, updated_at')
                    .order('updated_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Erro ao carregar processos do Supabase:', error);
                    updateSyncStatus(false);
                    return false;
                }

                if (data && data.length > 0) {
                    let updatedCount = 0;

                    // Criar mapa de processos do Supabase
                    const supabaseProcesses = new Map();
                    data.forEach(item => {
                        if (item.ticket) {
                            supabaseProcesses.set(item.ticket.toString().trim(), {
                                contatoFeito: item.contato_feito || '-',
                                liberacaoEntregue: item.liberacao_entregue || '-',
                                encostouDoca: item.encostou_doca || '-',
                                driverName: item.driver_name || '-',
                                supplier: item.supplier || '-'
                            });
                        }
                    });

                    // Atualizar driversData com os processos do Supabase
                    driversData.forEach(driver => {
                        if (driver.ticket) {
                            const ticketKey = driver.ticket.toString().trim();
                            const processData = supabaseProcesses.get(ticketKey);
                            
                            if (processData) {
                                // Atualizar apenas dados de processo, n√£o dados dos motoristas
                                driver.contatoFeito = processData.contatoFeito;
                                driver.liberacaoEntregue = processData.liberacaoEntregue;
                                driver.encostouDoca = processData.encostouDoca;
                                driver.driverName = processData.driverName;
                                driver.supplier = processData.supplier;
                                updatedCount++;
                                
                                // Invalidar cache
                                processStatusCache.delete(ticketKey);
                                
                                // Atualizar tamb√©m no currentFileData
                                const fileDataIndex = currentFileData.findIndex(d => 
                                    d.ticket && d.ticket.toString().trim() === ticketKey
                                );
                                if (fileDataIndex !== -1) {
                                    currentFileData[fileDataIndex].contatoFeito = processData.contatoFeito;
                                    currentFileData[fileDataIndex].liberacaoEntregue = processData.liberacaoEntregue;
                                    currentFileData[fileDataIndex].encostouDoca = processData.encostouDoca;
                                    currentFileData[fileDataIndex].driverName = processData.driverName;
                                    currentFileData[fileDataIndex].supplier = processData.supplier;
                                }
                            }
                        }
                    });

                    // Salvar altera√ß√µes no currentFileData
                    if (updatedCount > 0) {
                        saveCurrentFileData();
                    }

                    lastUpdateTime = new Date().toISOString();
                    console.log(`‚úÖ Supabase: ${updatedCount} processos atualizados.`);
                    return true;
                }
                
                console.log('‚ÑπÔ∏è Nenhum processo novo no Supabase');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro fatal ao carregar processos do Supabase:', error);
                updateSyncStatus(false);
                return false;
            }
        }

        async function startRealtimeSync() {
            try {
                if (realtimeSubscription) {
                    realtimeSubscription.unsubscribe();
                }

                // ‚úÖ CORRE√á√ÉO: Sincronizar apenas processos
                realtimeSubscription = supabaseClient
                    .channel('processes-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'drivers'
                        },
                        (payload) => {
                            console.log('üîÑ Mudan√ßa de processo recebida em tempo real:', payload);
                            handleRealtimeProcessUpdate(payload);
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Sincroniza√ß√£o de processos em tempo real ativada');
                            updateSyncStatus(true, 'Sincronizado');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('‚ùå Erro na sincroniza√ß√£o em tempo real');
                            updateSyncStatus(false, 'Erro na sincroniza√ß√£o');
                        } else if (status === 'TIMED_OUT') {
                            console.error('‚ùå Timeout na sincroniza√ß√£o em tempo real');
                            updateSyncStatus(false, 'Timeout na sincroniza√ß√£o');
                        }
                    });

            } catch (error) {
                console.error('‚ùå Erro ao iniciar sincroniza√ß√£o em tempo real:', error);
                updateSyncStatus(false, 'Erro na sincroniza√ß√£o');
            }
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO PARA LIDAR APENAS COM ATUALIZA√á√ïES DE PROCESSO
        function handleRealtimeProcessUpdate(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;

            if (!newRecord || !newRecord.ticket) return;

            switch (eventType) {
                case 'INSERT':
                case 'UPDATE':
                    updateProcessData(newRecord);
                    break;
                case 'DELETE':
                    deleteProcessData(oldRecord);
                    break;
            }

            updateInterface();
            console.log('üîÑ Processos atualizados em tempo real');
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO PARA ATUALIZAR APENAS DADOS DE PROCESSO
        function updateProcessData(updatedProcess) {
            if (!updatedProcess || !updatedProcess.ticket) return;

            const ticketKey = updatedProcess.ticket.toString().trim();
            
            // Invalidar cache
            processStatusCache.delete(ticketKey);
            invalidateEncostaCache();
            
            // Encontrar driver local
            const localDriver = driversData.find(d => 
                d.ticket && d.ticket.toString().trim() === ticketKey
            );

            if (localDriver) {
                // Atualizar apenas dados de processo
                if (updatedProcess.contato_feito !== undefined) {
                    localDriver.contatoFeito = updatedProcess.contato_feito !== null ? updatedProcess.contato_feito : '-';
                }
                if (updatedProcess.liberacao_entregue !== undefined) {
                    localDriver.liberacaoEntregue = updatedProcess.liberacao_entregue !== null ? updatedProcess.liberacao_entregue : '-';
                }
                if (updatedProcess.encostou_doca !== undefined) {
                    localDriver.encostouDoca = updatedProcess.encostou_doca !== null ? updatedProcess.encostou_doca : '-';
                }
                if (updatedProcess.driver_name !== undefined) {
                    localDriver.driverName = updatedProcess.driver_name !== null ? updatedProcess.driver_name : '-';
                }
                if (updatedProcess.supplier !== undefined) {
                    localDriver.supplier = updatedProcess.supplier !== null ? updatedProcess.supplier : '-';
                }
                
                // Atualizar tamb√©m no currentFileData
                const fileDataIndex = currentFileData.findIndex(d => 
                    d.ticket && d.ticket.toString().trim() === ticketKey
                );
                if (fileDataIndex !== -1) {
                    if (updatedProcess.contato_feito !== undefined) {
                        currentFileData[fileDataIndex].contatoFeito = updatedProcess.contato_feito !== null ? updatedProcess.contato_feito : '-';
                    }
                    if (updatedProcess.liberacao_entregue !== undefined) {
                        currentFileData[fileDataIndex].liberacaoEntregue = updatedProcess.liberacao_entregue !== null ? updatedProcess.liberacao_entregue : '-';
                    }
                    if (updatedProcess.encostou_doca !== undefined) {
                        currentFileData[fileDataIndex].encostouDoca = updatedProcess.encostou_doca !== null ? updatedProcess.encostou_doca : '-';
                    }
                    if (updatedProcess.driver_name !== undefined) {
                        currentFileData[fileDataIndex].driverName = updatedProcess.driver_name !== null ? updatedProcess.driver_name : '-';
                    }
                    if (updatedProcess.supplier !== undefined) {
                        currentFileData[fileDataIndex].supplier = updatedProcess.supplier !== null ? updatedProcess.supplier : '-';
                    }
                    
                    saveCurrentFileData();
                }

                console.log(`‚úÖ Processo ${ticketKey} atualizado via sincroniza√ß√£o`);
                
                // Se √© o driver atual, atualizar
                if (currentDriver && currentDriver.ticket === ticketKey) {
                    currentDriver = localDriver;
                }
            } else {
                // Se n√£o existe localmente, criar apenas o processo
                // N√£o criamos driver completo porque isso √© responsabilidade da se√ß√£o Base de Dados
                console.log(`‚ÑπÔ∏è Processo ${ticketKey} recebido, mas driver n√£o existe localmente`);
            }

            highlightUpdatedRow(ticketKey);
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO PARA EXCLUIR APENAS DADOS DE PROCESSO
        function deleteProcessData(deletedProcess) {
            if (!deletedProcess || !deletedProcess.ticket) return;

            const ticketKey = deletedProcess.ticket.toString().trim();
            
            // Invalidar cache
            processStatusCache.delete(ticketKey);
            invalidateEncostaCache();
            
            const localDriver = driversData.find(d => 
                d.ticket && d.ticket.toString().trim() === ticketKey
            );
            
            if (localDriver) {
                // Limpar apenas dados de processo
                localDriver.contatoFeito = '-';
                localDriver.liberacaoEntregue = '-';
                localDriver.encostouDoca = '-';
                
                // Atualizar tamb√©m no currentFileData
                const fileDataIndex = currentFileData.findIndex(d => 
                    d.ticket && d.ticket.toString().trim() === ticketKey
                );
                if (fileDataIndex !== -1) {
                    currentFileData[fileDataIndex].contatoFeito = '-';
                    currentFileData[fileDataIndex].liberacaoEntregue = '-';
                    currentFileData[fileDataIndex].encostouDoca = '-';
                    saveCurrentFileData();
                }
                
                console.log(`üóëÔ∏è Processo do motorista ${ticketKey} removido via sincroniza√ß√£o`);
                
                if (currentDriver && currentDriver.ticket === ticketKey) {
                    currentDriver = localDriver;
                }
            }
        }

        function highlightUpdatedRow(ticket) {
            const rows = document.querySelectorAll('tr');
            rows.forEach(row => {
                const ticketCell = row.querySelector('td:first-child');
                if (ticketCell && ticketCell.textContent.trim() === ticket.toString().trim()) {
                    row.classList.add('updated-row');
                    setTimeout(() => {
                        row.classList.remove('updated-row');
                    }, 3000);
                }
            });
        }

        async function forceSync() {
            updateSyncStatus(true, 'Sincronizando...');
            showDiscreetNotification('Sincronizando processos...', 1000);
            
            try {
                const success = await loadProcessesFromSupabase();
                if (success) {
                    updateInterface();
                    updateSyncStatus(true, 'Sincronizado');
                    showDiscreetNotification('‚úì Processos sincronizados', 1000);
                } else {
                    updateSyncStatus(false, 'Sincroniza√ß√£o parcial');
                    showDiscreetNotification('‚ö† Sincroniza√ß√£o parcial', 1500);
                }
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o for√ßada:', error);
                updateSyncStatus(false, 'Erro na sincroniza√ß√£o');
                showDiscreetNotification('‚úó Erro na sincroniza√ß√£o', 2000);
            }
        }

        // ========== SISTEMA DE PERSIST√äNCIA ========== //
        function saveToLocalStorage() {
            try {
                safeStorage.setItem('driversData', JSON.stringify(driversData));
                safeStorage.setItem('suppliersList', JSON.stringify(suppliersList));
                safeStorage.setItem('cdList', JSON.stringify(cdList));
                return true;
            } catch (e) {
                console.warn('N√£o foi poss√≠vel salvar no storage:', e);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = safeStorage.getItem('driversData');
                if (savedData) {
                    driversData = JSON.parse(savedData);
                    return true;
                }
            } catch (e) {
                console.warn('N√£o foi poss√≠vel carregar do storage:', e);
                driversData = [];
                return false;
            }
            return false;
        }

        function saveCurrentFileData() {
            try {
                const dataToSave = {
                    data: currentFileData,
                    fileName: currentFileName,
                    lastUpdated: new Date().toISOString()
                };
                safeStorage.setItem('currentFileData', JSON.stringify(dataToSave));
                console.log('‚úÖ Dados da encosta salvos');
                return true;
            } catch (error) {
                console.warn('‚ùå N√£o foi poss√≠vel salvar dados da encosta:', error);
                return false;
            }
        }

        function loadCurrentFileData() {
            try {
                const savedData = safeStorage.getItem('currentFileData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    currentFileData = parsedData.data || [];
                    currentFileName = parsedData.fileName || '';
                    
                    // Atualizar info do arquivo
                    const cargaFileInfo = document.getElementById('carga-file-info');
                    if (cargaFileInfo && currentFileName) {
                        cargaFileInfo.textContent = `Arquivo: ${currentFileName} | ${currentFileData.length} registros`;
                    }
                    
                    console.log(`‚úÖ Dados da encosta carregados: ${currentFileData.length} registros`);
                    return true;
                }
            } catch (error) {
                console.warn('‚ùå N√£o foi poss√≠vel carregar dados da encosta:', error);
                currentFileData = [];
                currentFileName = '';
            }
            return false;
        }

        function loadProcessBackup() {
            try {
                const savedBackup = safeStorage.getItem('processBackupData');
                if (savedBackup) {
                    processBackupData = JSON.parse(savedBackup);
                    console.log('‚úÖ Backup de processos carregado:', Object.keys(processBackupData).length, 'processos');
                    return true;
                }
            } catch (error) {
                console.warn('‚ùå N√£o foi poss√≠vel carregar backup de processos:', error);
            }
            return false;
        }

        function saveProcessBackup() {
            try {
                const newBackup = {};
                
                driversData.forEach(driver => {
                    if (driver.ticket) {
                        const ticketKey = driver.ticket.toString().trim();
                        const hasProcessData = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                             (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                             (driver.encostouDoca && driver.encostouDoca !== '-');
                        
                        if (hasProcessData) {
                            newBackup[ticketKey] = {
                                contatoFeito: driver.contatoFeito || '-',
                                liberacaoEntregue: driver.liberacaoEntregue || '-',
                                encostouDoca: driver.encostouDoca || '-',
                                driverName: driver.driverName || '-',
                                supplier: driver.supplier || '-',
                                ticket: driver.ticket,
                                cd: driver.cd || '-',
                                status: driver.status || '-',
                                arrivalDateTime: driver.arrivalDateTime || '-',
                                scheduleDateTime: driver.scheduleDateTime || '-',
                                truckPlate: driver.truckPlate || '-',
                                load: driver.load || '-',
                                lastUpdated: new Date().toISOString()
                            };
                        }
                    }
                });
                
                processBackupData = newBackup;
                safeStorage.setItem('processBackupData', JSON.stringify(processBackupData));
                console.log('‚úÖ Backup inteligente salvo:', Object.keys(processBackupData).length, 'processos');
                return true;
            } catch (error) {
                console.warn('‚ùå N√£o foi poss√≠vel salvar backup de processos:', error);
                return false;
            }
        }

        function restoreProcessBackup() {
            try {
                let restoredCount = 0;
                
                Object.keys(processBackupData).forEach(ticketKey => {
                    try {
                        const backup = processBackupData[ticketKey];
                        
                        if (backup && backup.ticket) {
                            const existingDriver = driversData.find(d => 
                                d.ticket && d.ticket.toString().trim() === ticketKey.toString().trim()
                            );
                            
                            if (existingDriver) {
                                existingDriver.contatoFeito = backup.contatoFeito || '-';
                                existingDriver.liberacaoEntregue = backup.liberacaoEntregue || '-';
                                existingDriver.encostouDoca = backup.encostouDoca || '-';
                                existingDriver.driverName = backup.driverName || '-';
                                existingDriver.supplier = backup.supplier || '-';
                                restoredCount++;
                            }
                        }
                    } catch (driverError) {
                        console.warn('Erro ao restaurar driver do backup:', driverError);
                    }
                });
                
                if (restoredCount > 0) {
                    console.log(`‚úÖ ${restoredCount} processos restaurados do backup`);
                }
                
                return restoredCount;
            } catch (error) {
                console.warn('‚ùå Erro ao restaurar backup de processos:', error);
                return 0;
            }
        }

        function initializePersistenceSystem() {
            console.log('üîÑ Iniciando sistema de persist√™ncia autom√°tica otimizada...');
            
            autoSaveInterval = setInterval(() => {
                if (dataChangeDetected) {
                    autoSaveData();
                }
            }, 5000);
            
            setupDataChangeMonitoring();
        }

        function setupDataChangeMonitoring() {
            let lastDataState = JSON.stringify(driversData);
            
            setInterval(() => {
                const currentDataState = JSON.stringify(driversData);
                if (currentDataState !== lastDataState) {
                    dataChangeDetected = true;
                    lastDataState = currentDataState;
                }
            }, 2000);
        }

        async function autoSaveData() {
            if (!dataChangeDetected) return;
            
            try {
                console.log('üíæ Salvando dados automaticamente (otimizado)...');
                
                // Salvar em paralelo para melhor performance
                await Promise.all([
                    saveToLocalStorage(),
                    saveProcessBackup(),
                    saveCurrentFileData()
                ]);
                
                if (isOnline) {
                    // Salvar apenas processos no Supabase em background
                    saveProcessesToSupabase().then(success => {
                        if (success) {
                            console.log('‚úÖ Processos salvos no Supabase (background)');
                        }
                    }).catch(error => {
                        console.warn('‚ùå Erro background no Supabase:', error);
                    });
                }
                
                dataChangeDetected = false;
                console.log('‚úÖ Dados salvos automaticamente');
                
            } catch (error) {
                console.warn('‚ùå Erro no salvamento autom√°tico:', error);
                // Fallback: salvar apenas localmente
                saveToLocalStorage();
                saveProcessBackup();
                saveCurrentFileData();
            }
        }

        // ========== FUN√á√ïES DE PROCESSO ========== //
        async function registerProcessStep(ticket, stepField) {
            console.log(`Registrando etapa ${stepField} para senha ${ticket}`);
            
            let driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            
            if (!driver) {
                // Tentar buscar no currentFileData
                driver = currentFileData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
                
                if (!driver) {
                    showDiscreetNotification(`‚ùå Senha ${ticket} n√£o encontrada na base de dados`, 2000);
                    return;
                }
                
                // Adicionar aos driversData se n√£o existir
                driversData.push(driver);
            }
            
            // Garantir propriedades
            if (!driver.hasOwnProperty('contatoFeito')) driver.contatoFeito = '-';
            if (!driver.hasOwnProperty('liberacaoEntregue')) driver.liberacaoEntregue = '-';
            if (!driver.hasOwnProperty('encostouDoca')) driver.encostouDoca = '-';
            if (!driver.hasOwnProperty('driverName')) driver.driverName = '-';
            if (!driver.hasOwnProperty('supplier')) driver.supplier = '-';
            
            const now = new Date();
            const formattedDateTime = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            driver[stepField] = formattedDateTime;
            
            // ‚úÖ ATUALIZAR currentFileData TAMB√âM
            const currentFileDriverIndex = currentFileData.findIndex(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (currentFileDriverIndex !== -1) {
                currentFileData[currentFileDriverIndex][stepField] = formattedDateTime;
                // Garantir que motorista e fornecedor tamb√©m sejam copiados
                if (driver.driverName && driver.driverName !== '-') {
                    currentFileData[currentFileDriverIndex].driverName = driver.driverName;
                }
                if (driver.supplier && driver.supplier !== '-') {
                    currentFileData[currentFileDriverIndex].supplier = driver.supplier;
                }
            }
            
            // ‚úÖ INVALIDAR CACHE
            processStatusCache.delete(ticket);
            invalidateEncostaCache();
            
            // Salvar altera√ß√µes
            dataChangeDetected = true;
            
            // Atualizar interface imediatamente
            if (currentDriver && currentDriver.ticket === ticket) {
                currentDriver = driver;
            }
            
            // Salvar APENAS o processo no Supabase
            saveProcessToSupabase(driver).then(success => {
                if (success) {
                    console.log(`‚úÖ Processo ${stepField} salvo no Supabase para senha ${ticket}`);
                }
            });
            
            // Atualizar interface
            updateInterfacePartial();
            
            const stepName = getStepName(stepField);
            showDiscreetNotification(`‚úì ${stepName} registrado`, 1500);
            
            console.log('Etapa registrada com sucesso:', driver);
        }

        async function undoProcessStep(ticket, stepField) {
            console.log(`Desfazendo etapa ${stepField} para senha ${ticket}`);
            
            let driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            
            if (!driver) {
                // Tentar buscar no currentFileData
                driver = currentFileData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
                
                if (!driver) {
                    showDiscreetNotification('‚ùå Motorista n√£o encontrado', 2000);
                    return;
                }
                
                // Adicionar aos driversData se n√£o existir
                driversData.push(driver);
            }
            
            const stepName = getStepName(stepField);
            const currentValue = driver[stepField];
            
            if (!currentValue || currentValue === '-') {
                showDiscreetNotification(`‚ÑπÔ∏è A etapa "${stepName}" j√° est√° vazia`, 1500);
                return;
            }
            
            if (confirm(`Tem certeza que deseja desfazer a etapa "${stepName}" para a senha ${ticket}?\n\nHor√°rio registrado: ${currentValue}`)) {
                driver[stepField] = '-';
                
                // ‚úÖ ATUALIZAR currentFileData TAMB√âM
                const currentFileDriverIndex = currentFileData.findIndex(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
                if (currentFileDriverIndex !== -1) {
                    currentFileData[currentFileDriverIndex][stepField] = '-';
                }
                
                // ‚úÖ INVALIDAR CACHE
                processStatusCache.delete(ticket);
                invalidateEncostaCache();
                
                // Marcar altera√ß√£o
                dataChangeDetected = true;
                
                // Salvar apenas o processo no Supabase
                const success = await saveProcessToSupabase(driver);
                
                if (success) {
                    if (currentDriver && currentDriver.ticket === ticket) {
                        currentDriver = driver;
                    }
                    
                    // Atualizar interface
                    updateInterfacePartial();
                    
                    if (document.getElementById('report-section')?.classList.contains('active')) {
                        generateReport();
                    }
                    
                    showDiscreetNotification(`‚Ü©Ô∏è ${stepName} desfeito`, 1500);
                    
                    console.log('Etapa desfeita com sucesso:', driver);
                } else {
                    showDiscreetNotification('‚ùå Erro ao sincronizar com outros usu√°rios', 2000);
                }
            }
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO PARA SALVAR APENAS PROCESSOS NO SUPABASE
        async function saveProcessToSupabase(driver) {
            try {
                // Criar objeto com apenas dados de processo
                const processToSave = {
                    ticket: driver.ticket,
                    contato_feito: driver.contatoFeito !== '-' ? driver.contatoFeito : null,
                    liberacao_entregue: driver.liberacaoEntregue !== '-' ? driver.liberacaoEntregue : null,
                    encostou_doca: driver.encostouDoca !== '-' ? driver.encostouDoca : null,
                    driver_name: driver.driverName && driver.driverName !== '-' ? driver.driverName : null,
                    supplier: driver.supplier && driver.supplier !== '-' ? driver.supplier : null,
                    updated_at: new Date().toISOString()
                };
                
                // ‚úÖ N√ÉO salvar dados completos do motorista, apenas processo
                const { error } = await supabaseClient
                    .from('drivers')
                    .upsert([processToSave], {
                        onConflict: 'ticket'
                    });

                if (error) throw error;
                
                console.log(`‚úÖ Processo salvo no Supabase para senha ${driver.ticket}`);
                return true;
            } catch (error) {
                console.warn('‚ùå Erro ao salvar processo no Supabase:', error);
                return false;
            }
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO PARA SALVAR APENAS PROCESSOS NO SUPABASE
        async function saveProcessesToSupabase() {
            const driversWithProcesses = driversData.filter(driver => {
                const hasProcess = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                  (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                  (driver.encostouDoca && driver.encostouDoca !== '-');
                return hasProcess;
            });

            if (driversWithProcesses.length === 0) {
                return true;
            }

            // Processar em lotes menores para melhor performance
            const batchSize = 30;
            const batches = [];
            
            for (let i = 0; i < driversWithProcesses.length; i += batchSize) {
                batches.push(driversWithProcesses.slice(i, i + batchSize));
            }

            try {
                for (const batch of batches) {
                    // Criar array apenas com dados de processo
                    const processesToSave = batch.map(driver => ({
                        ticket: driver.ticket,
                        contato_feito: driver.contatoFeito !== '-' ? driver.contatoFeito : null,
                        liberacao_entregue: driver.liberacaoEntregue !== '-' ? driver.liberacaoEntregue : null,
                        encostou_doca: driver.encostouDoca !== '-' ? driver.encostouDoca : null,
                        driver_name: driver.driverName && driver.driverName !== '-' ? driver.driverName : null,
                        supplier: driver.supplier && driver.supplier !== '-' ? driver.supplier : null,
                        updated_at: new Date().toISOString()
                    }));
                    
                    const { error } = await supabaseClient
                        .from('drivers')
                        .upsert(processesToSave, {
                            onConflict: 'ticket',
                            ignoreDuplicates: false
                        });
                    
                    if (error) throw error;
                    
                    // Pequena pausa entre lotes para n√£o sobrecarregar
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log(`‚úÖ ${driversWithProcesses.length} processos salvos em ${batches.length} lotes`);
                return true;
            } catch (error) {
                console.warn('‚ùå Erro ao salvar processos no Supabase:', error);
                throw error;
            }
        }

        // ========== FUN√á√ïES DE BUSCA E NAVEGA√á√ÉO ========== //
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            
            const targetSection = document.getElementById(sectionId);
            const targetLink = document.querySelector(`[data-target="${sectionId}"]`);
            
            if (targetSection) targetSection.classList.add('active');
            if (targetLink) targetLink.classList.add('active');
            
            if (sectionId === 'report-section') generateReport();
            else if (sectionId === 'encosta-section') renderEncostaListOptimized();
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const targetTab = document.querySelector(`[data-tab="${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (targetTab) targetTab.classList.add('active');
            if (targetContent) targetContent.classList.add('active');
        }

        function searchDriver(ticket) {
            // Primeiro tenta buscar nos driversData
            let driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            
            // Se n√£o encontrar, tenta no currentFileData
            if (!driver) {
                driver = currentFileData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            }
            
            if (driver) {
                currentDriver = driver;
                displayDriverInfo(driver);
                const driverResult = document.getElementById('driver-result');
                const driverNotFound = document.getElementById('driver-not-found');
                if (driverResult) driverResult.style.display = 'block';
                if (driverNotFound) driverNotFound.style.display = 'none';
                
                // Se n√£o est√° em driversData, adiciona
                if (!driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim())) {
                    driversData.push(driver);
                    dataChangeDetected = true;
                }
            } else {
                const driverResult = document.getElementById('driver-result');
                const driverNotFound = document.getElementById('driver-not-found');
                if (driverResult) driverResult.style.display = 'none';
                if (driverNotFound) driverNotFound.style.display = 'block';
            }
        }

        function displayDriverInfo(driver) {
            const elements = {
                'driver-ticket': driver.ticket || '-',
                'driver-name': driver.driverName || '-',
                'driver-supplier': driver.supplier || '-',
                'driver-cd': driver.cd || '-',
                'driver-schedule': driver.scheduleDateTime || '-',
                'driver-arrival': driver.arrivalDateTime || '-',
                'driver-status': driver.status || '-',
                'driver-called': driver.called || '-',
                'driver-truck-plate': driver.truckPlate || '-',
                'driver-trailer-plate': driver.trailerPlate || '-',
                'driver-equipment-type': driver.equipmentType || '-',
                'driver-equipment-qty': driver.equipmentQty || '-',
                'driver-nf': driver.nfNumber || '-',
                'driver-nf-emission': driver.nfEmission || '-',
                'driver-nf-value': driver.nfValue || '-',
                'driver-load': driver.load || '-',
                'driver-conf-start': driver.confStart || '-',
                'driver-conf-end': driver.confEnd || '-',
                'driver-crit-start': driver.critStart || '-',
                'driver-crit-end': driver.critEnd || '-',
                'driver-crit-time': driver.critTime || '-',
                'driver-release': driver.releaseTime || '-',
                'driver-warehouse': driver.warehouse || '-',
                'driver-process-status': getProcessStatusOptimized(driver) || '-'
            };

            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                }
            });
        }

        // ========== FUN√á√ïES DO PROCESSO ========== //
        function renderProcessTimeline() {
            const processContent = document.getElementById('process-content');
            if (!processContent) return;
            
            if (!currentDriver) {
                processContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Nenhum motorista selecionado</strong><br>
                        Volte √† se√ß√£o de busca e selecione uma senha para visualizar as etapas do processo.
                    </div>
                    <button class="btn btn-primary" onclick="showSection('search-section')">
                        üîç Voltar para Busca
                    </button>
                `;
                return;
            }
            
            // Garantir propriedades
            if (!currentDriver.hasOwnProperty('contatoFeito')) currentDriver.contatoFeito = '-';
            if (!currentDriver.hasOwnProperty('liberacaoEntregue')) currentDriver.liberacaoEntregue = '-';
            if (!currentDriver.hasOwnProperty('encostouDoca')) currentDriver.encostouDoca = '-';
            if (!currentDriver.hasOwnProperty('driverName')) currentDriver.driverName = '-';
            if (!currentDriver.hasOwnProperty('supplier')) currentDriver.supplier = '-';
            
            const steps = [
                { 
                    id: 'contato', 
                    label: 'Contato Feito', 
                    time: currentDriver.contatoFeito || '-', 
                    completed: !!currentDriver.contatoFeito && currentDriver.contatoFeito !== '-',
                    field: 'contatoFeito',
                    buttonText: '‚úÖ Registrar Contato'
                },
                { 
                    id: 'liberacao', 
                    label: 'Libera√ß√£o Entregue', 
                    time: currentDriver.liberacaoEntregue || '-', 
                    completed: !!currentDriver.liberacaoEntregue && currentDriver.liberacaoEntregue !== '-',
                    field: 'liberacaoEntregue',
                    buttonText: 'üìÑ Registrar Libera√ß√£o'
                },
                { 
                    id: 'doca', 
                    label: 'Encostou em Doca', 
                    time: currentDriver.encostouDoca || '-', 
                    completed: !!currentDriver.encostouDoca && currentDriver.encostouDoca !== '-',
                    field: 'encostouDoca',
                    buttonText: 'üöõ Registrar Doca'
                }
            ];
            
            let nextStepIndex = steps.findIndex(step => !step.completed);
            if (nextStepIndex === -1) nextStepIndex = steps.length;
            
            let timelineHTML = `
                <div class="driver-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Senha</span>
                            <span class="info-value">${currentDriver.ticket || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Motorista</span>
                            <span class="info-value">${currentDriver.driverName || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fornecedor</span>
                            <span class="info-value">${currentDriver.supplier || '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status Atual</span>
                            <span class="info-value">${getProcessStatusOptimized(currentDriver)}</span>
                        </div>
                    </div>
                </div>
                
                <h3>üìã Etapas do Processo</h3>
                <div class="timeline">
            `;
            
            steps.forEach((step, index) => {
                let stepClass = step.completed ? 'completed' : (index === nextStepIndex ? 'current' : '');
                let stepIcon = step.completed ? '‚úÖ' : (index === nextStepIndex ? 'üü°' : '‚ö™');
                
                timelineHTML += `
                    <div class="timeline-step">
                        <div class="step-icon ${stepClass}">${stepIcon}</div>
                        <div class="step-label"><strong>${step.label}</strong></div>
                        <div class="step-time">${step.time !== '-' ? step.time : 'N√£o registrado'}</div>
                        <div class="step-actions">
                `;
                
                if (index === nextStepIndex) {
                    timelineHTML += `
                            <button class="btn btn-success btn-small register-step" 
                                    data-step="${step.field}" 
                                    data-ticket="${currentDriver.ticket}">
                                ${step.buttonText}
                            </button>
                    `;
                }
                
                if (step.completed) {
                    timelineHTML += `
                            <button class="btn btn-outline btn-small undo-step" 
                                    data-step="${step.field}" 
                                    data-ticket="${currentDriver.ticket}">
                                ‚Ü©Ô∏è Desfazer
                            </button>
                    `;
                }
                
                timelineHTML += `</div></div>`;
            });
            
            timelineHTML += `</div>`;
            
            const completedSteps = steps.filter(step => step.completed).length;
            const totalSteps = steps.length;
            
            timelineHTML += `
                <div class="database-stats" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${completedSteps}/${totalSteps}</div>
                        <div class="stat-label">Etapas Conclu√≠das</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${getProcessStatusOptimized(currentDriver)}</div>
                        <div class="stat-label">Status do Processo</div>
                    </div>
                </div>
            `;
            
            if (nextStepIndex === steps.length) {
                timelineHTML += `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <strong>üéâ Processo Conclu√≠do!</strong> Todas as etapas foram registradas com sucesso.
                    </div>
                `;
            }
            
            processContent.innerHTML = timelineHTML;
            
            // Adicionar event listeners
            setTimeout(() => {
                processContent.querySelectorAll('.register-step').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const stepField = this.getAttribute('data-step');
                        const ticket = this.getAttribute('data-ticket');
                        registerProcessStep(ticket, stepField);
                    });
                });
                
                processContent.querySelectorAll('.undo-step').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const stepField = this.getAttribute('data-step');
                        const ticket = this.getAttribute('data-ticket');
                        undoProcessStep(ticket, stepField);
                    });
                });
            }, 50);
        }

        // ========== FUN√á√ïES DA ENCOSTA ========== //
        function checkCargaStatus(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (!driver || !driver.load) return false;
            return cargaData.has(driver.load.toString().trim());
        }

        function getCargaStatus(ticket) {
            const hasCarga = checkCargaStatus(ticket);
            return {
                status: hasCarga ? 'Gerado' : 'Pendente',
                class: hasCarga ? 'status-gerada' : 'status-pendente'
            };
        }

        function renderEncostaList() {
            renderEncostaListOptimized();
        }

        async function goToProcessFromEncosta(ticket) {
            // Busca ultra-r√°pida nos dados locais
            let driver = currentFileData.find(d => 
                d.ticket && d.ticket.toString().trim() === ticket.toString().trim()
            ) || driversData.find(d => 
                d.ticket && d.ticket.toString().trim() === ticket.toString().trim()
            );
            
            if (driver) {
                // Atualizar interface imediatamente
                currentDriver = driver;
                const ticketInput = document.getElementById('ticket-input');
                if (ticketInput) ticketInput.value = ticket;
                
                // Mostrar se√ß√£o de processo sem delay
                showSection('process-section');
                
                // Renderizar timeline de forma otimizada
                renderProcessTimeline();
                
                return true;
            } else {
                // Se n√£o encontrou localmente, buscar apenas processo no Supabase
                if (isOnline) {
                    try {
                        showDiscreetNotification(`Buscando processo ${ticket}...`, 1000);
                        const { data, error } = await supabaseClient
                            .from('drivers')
                            .select('ticket, contato_feito, liberacao_entregue, encostou_doca, driver_name, supplier')
                            .eq('ticket', ticket)
                            .single();

                        if (!error && data) {
                            // Criar driver b√°sico apenas com dados de processo
                            driver = {
                                ticket: data.ticket,
                                driverName: data.driver_name || '-',
                                supplier: data.supplier || '-',
                                status: '-',
                                contatoFeito: data.contato_feito || '-',
                                liberacaoEntregue: data.liberacao_entregue || '-',
                                encostouDoca: data.encostou_doca || '-',
                                cd: '-',
                                arrivalDateTime: '-',
                                scheduleDateTime: '-',
                                truckPlate: '-',
                                load: '-'
                            };
                            
                            // Adicionar aos dados locais
                            driversData.push(driver);
                            currentDriver = driver;
                            
                            // Atualizar interface
                            const ticketInput = document.getElementById('ticket-input');
                            if (ticketInput) ticketInput.value = ticket;
                            showSection('process-section');
                            renderProcessTimeline();
                            
                            return true;
                        }
                    } catch (error) {
                        console.warn('Erro ao buscar no Supabase:', error);
                    }
                }
                
                // Se chegou aqui, n√£o encontrou
                showDiscreetNotification(`‚ùå Senha ${ticket} n√£o encontrada`, 2000);
                return false;
            }
        }

        // ========== SISTEMA DE CARGA ========== //
        async function saveCargaData() {
            try {
                const cargaArray = Array.from(cargaData);
                safeStorage.setItem('cargaData', JSON.stringify(cargaArray));
                return true;
            } catch (error) {
                console.warn('Erro ao salvar carga:', error);
                return false;
            }
        }

        function loadCargaData() {
            const savedCargaData = safeStorage.getItem('cargaData');
            if (savedCargaData) {
                try {
                    const cargaArray = JSON.parse(savedCargaData);
                    cargaData = new Set(cargaArray);
                    return true;
                } catch (e) {
                    cargaData = new Set();
                    return false;
                }
            }
            return false;
        }

        async function handleCargaFileUpload(file) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const content = e.target.result;
                await processCargaFile(content, file.name);
            };
            
            reader.readAsText(file);
        }

        async function processCargaFile(content, fileName) {
            try {
                cargaData = new Set();
                const lines = content.split('\n');
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    const parts = line.split(';');
                    if (parts.length >= 4) {
                        const carga = parts[3].trim();
                        if (carga && carga !== '') {
                            cargaData.add(carga);
                        }
                    }
                }
                
                await saveCargaData();
                
                const cargaFileInfo = document.getElementById('carga-file-info');
                if (cargaFileInfo) {
                    cargaFileInfo.textContent = 
                        `Arquivo: ${fileName} | ${cargaData.size} cargas geradas identificadas`;
                }
                
                // Invalidar cache da encosta
                invalidateEncostaCache();
                renderEncostaListOptimized();
                
                showDiscreetNotification(`‚úÖ ${cargaData.size} cargas identificadas`, 1500);
                
            } catch (error) {
                console.warn('Erro ao processar arquivo de carga:', error);
                showDiscreetNotification('‚ùå Erro ao processar arquivo de carga. Verifique o formato do arquivo.', 2000);
            }
        }

        function debugCargaStatus(ticket) {
            const driver = driversData.find(d => d.ticket && d.ticket.toString().trim() === ticket.toString().trim());
            if (!driver) {
                alert(`‚ùå Senha ${ticket} n√£o encontrada na base de dados`);
                return;
            }
            
            const hasCarga = checkCargaStatus(ticket);
            alert(`üîç Debug Carga:\nSenha: ${ticket}\nCarga: ${driver.load || 'N/A'}\nStatus: ${hasCarga ? 'Gerado' : 'Pendente'}\n\nCargas no sistema: ${cargaData.size}`);
        }

        // ========== FUN√á√ïES DO RELAT√ìRIO ========== //
        function extractDateFromProcessDateTime(dateTimeStr) {
            if (!dateTimeStr || dateTimeStr === '-' || dateTimeStr === '' || dateTimeStr === ' ') return null;
            
            try {
                const parts = dateTimeStr.split(' ');
                if (parts.length < 2) return null;
                const datePart = parts[0];
                const [day, month, year] = datePart.split('/');
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            } catch (e) {
                return null;
            }
        }

        // ‚úÖ CORRE√á√ÉO: FUN√á√ÉO PARA GERAR RELAT√ìRIO APENAS COM DADOS DO SUPABASE
        async function generateReport() {
            console.log('üîÑ Gerando relat√≥rio com dados do Supabase...');
            
            try {
                // Buscar apenas processos do Supabase
                const { data, error } = await supabaseClient
                    .from('drivers')
                    .select('ticket, contato_feito, liberacao_entregue, encostou_doca, driver_name, supplier, updated_at')
                    .or('contato_feito.not.is.null,liberacao_entregue.not.is.null,encostou_doca.not.is.null')
                    .order('updated_at', { ascending: false });

                if (error) {
                    console.warn('‚ùå Erro ao buscar dados do relat√≥rio do Supabase:', error);
                    showDiscreetNotification('‚ùå Erro ao carregar relat√≥rio do Supabase', 2000);
                    return;
                }

                if (!data || data.length === 0) {
                    console.log('‚ÑπÔ∏è Nenhum dado de processo encontrado no Supabase');
                    updateReportStats([]);
                    renderReportTable([]);
                    return;
                }

                console.log(`‚úÖ ${data.length} registros carregados do Supabase para o relat√≥rio`);

                // Processar dados do Supabase
                const reportData = data.map(item => {
                    const reportItem = {
                        ticket: item.ticket,
                        contatoFeito: item.contato_feito || '-',
                        liberacaoEntregue: item.liberacao_entregue || '-',
                        encostouDoca: item.encostou_doca || '-',
                        driverName: item.driver_name || '-',
                        supplier: item.supplier || '-'
                    };
                    
                    return reportItem;
                });

                const startDate = document.getElementById('report-start-date')?.value;
                const endDate = document.getElementById('report-end-date')?.value;
                
                let filteredData = reportData;
                
                if (startDate || endDate) {
                    filteredData = reportData.filter(driver => {
                        let driverDate = null;
                        
                        if (driver.encostouDoca !== '-') {
                            driverDate = extractDateFromProcessDateTime(driver.encostouDoca);
                        } else if (driver.liberacaoEntregue !== '-') {
                            driverDate = extractDateFromProcessDateTime(driver.liberacaoEntregue);
                        } else if (driver.contatoFeito !== '-') {
                            driverDate = extractDateFromProcessDateTime(driver.contatoFeito);
                        }
                        
                        if (!driverDate) return false;
                        if (startDate && driverDate < startDate) return false;
                        if (endDate && driverDate > endDate) return false;
                        
                        return true;
                    });
                }

                updateReportStats(filteredData);
                renderReportTable(filteredData);
                
                console.log(`üìä Relat√≥rio gerado: ${filteredData.length} registros`);

            } catch (error) {
                console.warn('‚ùå Erro ao gerar relat√≥rio:', error);
                showDiscreetNotification('‚ùå Erro ao gerar relat√≥rio', 2000);
                
                // Fallback: usar dados locais
                const startDate = document.getElementById('report-start-date')?.value;
                const endDate = document.getElementById('report-end-date')?.value;
                
                let filteredData = driversData.filter(driver => {
                    const hasProcessData = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                         (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                         (driver.encostouDoca && driver.encostouDoca !== '-');
                    
                    if (!hasProcessData) return false;
                    if (!startDate && !endDate) return true;
                    
                    let driverDate = null;
                    
                    if (driver.encostouDoca !== '-') {
                        driverDate = extractDateFromProcessDateTime(driver.encostouDoca);
                    } else if (driver.liberacaoEntregue !== '-') {
                        driverDate = extractDateFromProcessDateTime(driver.liberacaoEntregue);
                    } else if (driver.contatoFeito !== '-') {
                        driverDate = extractDateFromProcessDateTime(driver.contatoFeito);
                    }
                    
                    if (!driverDate) return false;
                    if (startDate && driverDate < startDate) return false;
                    if (endDate && driverDate > endDate) return false;
                    
                    return true;
                });
                
                updateReportStats(filteredData);
                renderReportTable(filteredData);
            }
        }

        function updateReportStats(data) {
            const totalProcesses = data.length;
            const completedProcesses = data.filter(d => d.encostouDoca && d.encostouDoca !== '-').length;
            const inProgressProcesses = data.filter(d => 
                (d.contatoFeito !== '-' && d.liberacaoEntregue !== '-' && d.encostouDoca === '-') ||
                (d.contatoFeito !== '-' && d.liberacaoEntregue === '-' && d.encostouDoca === '-')
            ).length;
            const pendingProcesses = data.filter(d => 
                d.contatoFeito === '-' && d.liberacaoEntregue === '-' && d.encostouDoca === '-'
            ).length;

            const totalProcessesEl = document.getElementById('total-processes');
            const completedProcessesEl = document.getElementById('completed-processes');
            const inProgressProcessesEl = document.getElementById('in-progress-processes');
            const pendingProcessesEl = document.getElementById('pending-processes');

            if (totalProcessesEl) totalProcessesEl.textContent = totalProcesses;
            if (completedProcessesEl) completedProcessesEl.textContent = completedProcesses;
            if (inProgressProcessesEl) inProgressProcessesEl.textContent = inProgressProcesses;
            if (pendingProcessesEl) pendingProcessesEl.textContent = pendingProcesses;
        }

        function renderReportTable(data) {
            const tableBody = document.getElementById('report-table-body');
            if (!tableBody) return;
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <div class="empty-state">
                                <div>üìã</div>
                                <p>Nenhum dado de processo encontrado</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            
            data.forEach(driver => {
                const status = getProcessStatusOptimized(driver);
                let rowClass = '';
                
                if (status === 'Encostou em Doca') rowClass = 'completed';
                else if (status === 'Libera√ß√£o Entregue' || status === 'Contato Feito') rowClass = 'in-progress';
                else rowClass = 'pending';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${driver.ticket || '-'}</td>
                        <td>${driver.driverName || '-'}</td>
                        <td>${driver.supplier || '-'}</td>
                        <td>${driver.contatoFeito || '-'}</td>
                        <td>${driver.liberacaoEntregue || '-'}</td>
                        <td>${driver.encostouDoca || '-'}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        function exportReportToExcel() {
            const startDate = document.getElementById('report-start-date')?.value;
            const endDate = document.getElementById('report-end-date')?.value;
            
            let filteredData = driversData.filter(driver => {
                const hasProcessData = driver.contatoFeito !== '-' || 
                                     driver.liberacaoEntregue !== '-' || 
                                     driver.encostouDoca !== '-';
                if (!hasProcessData) return false;
                if (!startDate && !endDate) return true;
                
                let driverDate = null;
                if (driver.contatoFeito !== '-') driverDate = extractDateFromProcessDateTime(driver.contatoFeito);
                else if (driver.liberacaoEntregue !== '-') driverDate = extractDateFromProcessDateTime(driver.liberacaoEntregue);
                else if (driver.encostouDoca !== '-') driverDate = extractDateFromProcessDateTime(driver.encostouDoca);
                
                if (!driverDate) return false;
                if (startDate && driverDate < startDate) return false;
                if (endDate && driverDate > endDate) return false;
                return true;
            });
            
            if (filteredData.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }
            
            const excelData = filteredData.map(driver => ({
                'Senha': driver.ticket || '',
                'Motorista': driver.driverName || '',
                'Fornecedor': driver.supplier || '',
                'Contato Feito': driver.contatoFeito || '',
                'Libera√ß√£o Entregue': driver.liberacaoEntregue || '',
                'Encostou em Doca': driver.encostouDoca || '',
                'Status': getProcessStatusOptimized(driver) || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatorio_Processos');
            
            const today = new Date().toISOString().split('T')[0];
            const fileName = `relatorio_processos_${today}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }

        function clearReportFilters() {
            const startDateEl = document.getElementById('report-start-date');
            const endDateEl = document.getElementById('report-end-date');
            
            if (startDateEl) startDateEl.value = '';
            if (endDateEl) endDateEl.value = '';
            generateReport();
        }

        // ========== FUN√á√ïES DE BASE DE DADOS ========== //
        function updateDatabaseStats() {
            try {
                const totalDrivers = driversData.length;
                
                const suppliers = driversData
                    .map(d => d.supplier)
                    .filter(supplier => supplier && supplier !== '-' && supplier !== '');
                const totalSuppliers = [...new Set(suppliers)].length;
                
                const activeProcesses = driversData.filter(d => {
                    const status = d.status ? d.status.toString().trim().toUpperCase() : '';
                    const statusAtivos = ['AGENDADO', 'CONFERENCIA', 'PARA AGENDAR'];
                    return statusAtivos.includes(status);
                }).length;
                
                const completedToday = driversData.filter(d => {
                    try {
                        const status = d.status ? d.status.toString().trim().toUpperCase() : '';
                        if (status !== 'FINALIZADO') return false;
                        if (!d.arrivalDateTime || d.arrivalDateTime === '-' || d.arrivalDateTime === '') return false;
                        const arrivalStr = String(d.arrivalDateTime);
                        const today = new Date();
                        const todayDay = today.getDate().toString().padStart(2, '0');
                        const todayMonth = (today.getMonth() + 1).toString().padStart(2, '0');
                        const todayYear = today.getFullYear();
                        const todayFormatted = `${todayDay}/${todayMonth}/${todayYear}`;
                        return arrivalStr.includes(todayFormatted);
                    } catch (error) {
                        return false;
                    }
                }).length;
                
                const totalDriversEl = document.getElementById('total-drivers');
                const totalSuppliersEl = document.getElementById('total-suppliers');
                const activeProcessesEl = document.getElementById('active-processes');
                const completedTodayEl = document.getElementById('completed-today');
                
                if (totalDriversEl) totalDriversEl.textContent = totalDrivers;
                if (totalSuppliersEl) totalSuppliersEl.textContent = totalSuppliers;
                if (activeProcessesEl) activeProcessesEl.textContent = activeProcesses;
                if (completedTodayEl) completedTodayEl.textContent = completedToday;
                
            } catch (error) {
                console.warn('Erro ao atualizar estat√≠sticas:', error);
                const totalDriversEl = document.getElementById('total-drivers');
                const totalSuppliersEl = document.getElementById('total-suppliers');
                const activeProcessesEl = document.getElementById('active-processes');
                const completedTodayEl = document.getElementById('completed-today');
                
                if (totalDriversEl) totalDriversEl.textContent = driversData.length || '0';
                if (totalSuppliersEl) totalSuppliersEl.textContent = '0';
                if (activeProcessesEl) activeProcessesEl.textContent = '0';
                if (completedTodayEl) completedTodayEl.textContent = '0';
            }
        }

        function renderDriversTable(filteredData = null) {
            saveFilterValues();
            
            const dataToShow = filteredData || driversData;
            const tableBody = document.getElementById('drivers-table-body');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (dataToShow.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8" style="text-align: center; padding: 20px;">Nenhum motorista encontrado</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            dataToShow.forEach(driver => {
                if (!driver) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${driver.ticket || '-'}</td>
                    <td>${driver.driverName || '-'}</td>
                    <td>${driver.supplier || '-'}</td>
                    <td>${driver.cd || '-'}</td>
                    <td>${driver.truckPlate || '-'}</td>
                    <td>${driver.status || '-'}</td>
                    <td>${driver.arrivalDateTime || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small view-driver" data-ticket="${driver.ticket}">Ver</button>
                        <button class="btn btn-danger btn-small delete-driver" data-ticket="${driver.ticket}">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // ‚úÖ ADICIONAR EVENT LISTENERS AP√ìS RENDERIZAR
            setTimeout(() => {
                document.querySelectorAll('.view-driver').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const ticket = this.getAttribute('data-ticket');
                        if (ticket) {
                            searchDriver(ticket);
                            showSection('search-section');
                        }
                    });
                });
                
                document.querySelectorAll('.delete-driver').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const ticket = this.getAttribute('data-ticket');
                        if (ticket) {
                            deleteDriver(ticket);
                        }
                    });
                });
            }, 100);
        }

        function deleteDriver(ticket) {
            if (confirm(`Tem certeza que deseja excluir a senha ${ticket}?`)) {
                driversData = driversData.filter(d => d.ticket !== ticket);
                saveToLocalStorage();
                renderDriversTable();
                updateDatabaseStats();
                
                if (currentDriver && currentDriver.ticket === ticket) {
                    currentDriver = null;
                    const driverResult = document.getElementById('driver-result');
                    if (driverResult) driverResult.style.display = 'none';
                }
            }
        }

        // ‚úÖ‚úÖ‚úÖ FUN√á√ÉO ALTERADA: N√ÉO PRESERVAR PROCESSOS NA LIMPEZA DA BASE DE DADOS ‚úÖ‚úÖ‚úÖ
        function clearDatabase() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja limpar COMPLETAMENTE a base de dados local?\n\nüìã Isso ir√° remover TODOS os dados localmente:\n‚Ä¢ Todos os motoristas cadastrados\n‚Ä¢ Todos os fornecedores\n‚Ä¢ Todos os CDs\n\nüö´ NENHUM processo ser√° preservado\nüìä Os processos continuar√£o apenas no Supabase (Relat√≥rio)\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                
                // ‚úÖ‚úÖ‚úÖ LIMPEZA COMPLETA - N√ÉO PRESERVAR NADA ‚úÖ‚úÖ‚úÖ
                driversData = [];
                suppliersList = [];
                cdList = [];
                
                // ‚úÖ‚úÖ‚úÖ N√ÉO RESTAURAR PROCESSOS DO BACKUP
                // ‚úÖ‚úÖ‚úÖ MANTER currentFileData (encosta) SEPARADO
                
                saveToLocalStorage();
                renderDriversTable();
                updateDatabaseStats();
                
                if (currentDriver) {
                    currentDriver = null;
                    const driverResult = document.getElementById('driver-result');
                    if (driverResult) driverResult.style.display = 'none';
                }
                
                showDiscreetNotification(`üóëÔ∏è Base de dados local limpa completamente!`, 800);
            }
        }

        // ========== SISTEMA DE FILTROS ========== //
        let activeFilters = {
            ticket: '',
            driver: '',
            supplier: '',
            status: '',
            plate: '',
            arrival: ''
        };

        function saveFilterValues() {
            const filterValues = {
                ticket: document.getElementById('filter-ticket')?.value || '',
                driver: document.getElementById('filter-driver')?.value || '',
                supplier: document.getElementById('filter-supplier')?.value || '',
                status: document.getElementById('filter-status')?.value || '',
                plate: document.getElementById('filter-plate')?.value || '',
                arrival: document.getElementById('filter-arrival')?.value || ''
            };
            safeStorage.setItem('activeFilters', JSON.stringify(filterValues));
        }

        function loadFilterValues() {
            const savedFilters = safeStorage.getItem('activeFilters');
            if (savedFilters) {
                const filterValues = JSON.parse(savedFilters);
                
                const elements = {
                    ticket: document.getElementById('filter-ticket'),
                    driver: document.getElementById('filter-driver'),
                    supplier: document.getElementById('filter-supplier'),
                    status: document.getElementById('filter-status'),
                    plate: document.getElementById('filter-plate'),
                    arrival: document.getElementById('filter-arrival')
                };
                
                if (elements.ticket) elements.ticket.value = filterValues.ticket || '';
                if (elements.driver) elements.driver.value = filterValues.driver || '';
                if (elements.supplier) elements.supplier.value = filterValues.supplier || '';
                if (elements.status) elements.status.value = filterValues.status || '';
                if (elements.plate) elements.plate.value = filterValues.plate || '';
                if (elements.arrival) elements.arrival.value = filterValues.arrival || '';
                
                activeFilters = {
                    ticket: filterValues.ticket ? filterValues.ticket.toString().toLowerCase() : '',
                    driver: filterValues.driver ? filterValues.driver.toString().toLowerCase() : '',
                    supplier: filterValues.supplier ? filterValues.supplier.toString().toLowerCase() : '',
                    status: filterValues.status ? filterValues.status.toString().toLowerCase() : '',
                    plate: filterValues.plate ? filterValues.plate.toString().toLowerCase() : '',
                    arrival: filterValues.arrival ? filterValues.arrival.toString().toLowerCase() : ''
                };
                
                return true;
            }
            return false;
        }

        function updateResultsInfo(filteredCount) {
            const resultsInfo = document.getElementById('results-info');
            const totalCount = driversData.length;
            
            if (!resultsInfo) return;
            
            if (totalCount === 0) {
                resultsInfo.textContent = 'Nenhum registro encontrado na base de dados';
            } else if (filteredCount === 0) {
                resultsInfo.textContent = 'Nenhum registro corresponde aos filtros aplicados';
            } else if (filteredCount === totalCount) {
                resultsInfo.textContent = `Mostrando todos os ${totalCount} registros`;
            } else {
                resultsInfo.textContent = `Mostrando ${filteredCount} de ${totalCount} registros filtrados`;
            }
        }

        function applyFilters() {
            let filteredData = driversData.filter(driver => {
                if (!driver) return false;
                
                const driverTicket = driver.ticket ? driver.ticket.toString().toLowerCase() : '';
                const driverName = driver.driverName ? driver.driverName.toString().toLowerCase() : '';
                const driverSupplier = driver.supplier ? driver.supplier.toString().toLowerCase() : '';
                const driverStatus = driver.status ? driver.status.toString().toLowerCase() : '';
                const driverTruckPlate = driver.truckPlate ? driver.truckPlate.toString().toLowerCase() : '';
                const driverArrival = driver.arrivalDateTime ? driver.arrivalDateTime.toString().toLowerCase() : '';
                
                if (activeFilters.ticket && !driverTicket.includes(activeFilters.ticket)) {
                    return false;
                }
                
                if (activeFilters.driver && !driverName.includes(activeFilters.driver)) {
                    return false;
                }
                
                if (activeFilters.supplier && !driverSupplier.includes(activeFilters.supplier)) {
                    return false;
                }
                
                if (activeFilters.status && !driverStatus.includes(activeFilters.status)) {
                    return false;
                }
                
                if (activeFilters.plate && !driverTruckPlate.includes(activeFilters.plate)) {
                    return false;
                }
                
                if (activeFilters.arrival && !driverArrival.includes(activeFilters.arrival)) {
                    return false;
                }
                
                return true;
            });
            
            saveFilterValues();
            renderDriversTable(filteredData);
            updateResultsInfo(filteredData.length);
        }

        // ========== SISTEMA DE SENHA DE SEGURAN√áA ========== //
        function showPasswordModal(actionType) {
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            
            if (!modal || !passwordInput) return;
            
            passwordInput.value = '';
            pendingAction = actionType;
            modal.classList.add('active');
            
            setTimeout(() => {
                passwordInput.focus();
            }, 300);
        }

        function hidePasswordModal() {
            const modal = document.getElementById('password-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            pendingAction = null;
        }

        function verifyPassword() {
            const passwordInput = document.getElementById('password-input');
            if (!passwordInput) return false;
            
            const enteredPassword = passwordInput.value.trim();
            
            if (enteredPassword === SECURITY_PASSWORD) {
                hidePasswordModal();
                return true;
            } else {
                showDiscreetNotification('‚ùå Senha incorreta!', 2000);
                passwordInput.value = '';
                passwordInput.focus();
                return false;
            }
        }

        function executePendingAction() {
            if (!pendingAction) return;
            
            switch(pendingAction) {
                case 'clearAllProcesses':
                    clearAllProcessesConfirmed();
                    break;
                case 'clearIncompleteProcesses':
                    clearIncompleteProcessesConfirmed();
                    break;
            }
            
            pendingAction = null;
        }

        async function deleteFromSupabasePermanently(tickets) {
            if (!tickets || tickets.length === 0) return true;
            
            try {
                // Processar em lotes para evitar timeout
                const batchSize = 20;
                let deletedCount = 0;
                
                for (let i = 0; i < tickets.length; i += batchSize) {
                    const batch = tickets.slice(i, i + batchSize);
                    
                    // Para cada ticket no batch, excluir do Supabase
                    const deletePromises = batch.map(ticket => 
                        supabaseClient
                            .from('drivers')
                            .delete()
                            .eq('ticket', ticket)
                    );
                    
                    const results = await Promise.all(deletePromises);
                    
                    // Verificar erros
                    results.forEach((result, index) => {
                        if (result.error) {
                            console.warn(`‚ùå Erro ao excluir ticket ${batch[index]} do Supabase:`, result.error);
                        } else {
                            deletedCount++;
                        }
                    });
                    
                    // Pequena pausa entre lotes
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                console.log(`‚úÖ ${deletedCount} registros exclu√≠dos permanentemente do Supabase`);
                return deletedCount > 0;
            } catch (error) {
                console.warn('‚ùå Erro ao excluir permanentemente do Supabase:', error);
                return false;
            }
        }

        function clearAllProcesses() {
            showPasswordModal('clearAllProcesses');
        }

        async function clearAllProcessesConfirmed() {
            try {
                // Limpar em driversData
                driversData.forEach(driver => {
                    driver.contatoFeito = '-';
                    driver.liberacaoEntregue = '-';
                    driver.encostouDoca = '-';
                });

                // ‚úÖ LIMPAR TAMB√âM NO currentFileData
                currentFileData.forEach(driver => {
                    driver.contatoFeito = '-';
                    driver.liberacaoEntregue = '-';
                    driver.encostouDoca = '-';
                });

                // ‚úÖ INVALIDAR CACHE
                processStatusCache.clear();
                invalidateEncostaCache();

                // Salvar altera√ß√µes
                saveCurrentFileData();
                dataChangeDetected = true;

                // Enviar para Supabase em background (apenas processos)
                const updates = driversData.map(driver => ({
                    ticket: driver.ticket,
                    contato_feito: null,
                    liberacao_entregue: null,
                    encostou_doca: null,
                    driver_name: null,
                    supplier: null,
                    updated_at: new Date().toISOString()
                }));

                // Processar em lotes menores
                const batchSize = 30;
                for (let i = 0; i < updates.length; i += batchSize) {
                    const batch = updates.slice(i, i + batchSize);
                    await supabaseClient
                        .from('drivers')
                        .upsert(batch, {
                            onConflict: 'ticket'
                        });
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // ‚úÖ ATUALIZAR ENCOSTA
                if (document.getElementById('encosta-section')?.classList.contains('active')) {
                    renderEncostaListOptimized();
                }
                
                updateInterface();
                showDiscreetNotification('‚úÖ Todos os registros de processo foram limpos!', 2000);

            } catch (error) {
                console.warn('Erro ao limpar processos:', error);
                showDiscreetNotification('‚ùå Erro ao limpar registros no Supabase', 2000);
            }
        }

        function clearIncompleteProcesses() {
            showPasswordModal('clearIncompleteProcesses');
        }

        async function clearIncompleteProcessesConfirmed() {
            try {
                // Encontrar todos os processos em andamento
                let incompleteProcesses = [];
                let ticketsToDelete = [];
                
                // Identificar processos em andamento
                driversData.forEach(driver => {
                    if (!driver.ticket) return;
                    
                    const hasEncostouDoca = driver.encostouDoca && driver.encostouDoca !== '-';
                    const hasAnyProcessStep = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                            (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-');
                    
                    // Se tem alguma etapa mas n√£o tem "Encostou em Doca", √© processo em andamento
                    if (hasAnyProcessStep && !hasEncostouDoca) {
                        incompleteProcesses.push(driver.ticket);
                        ticketsToDelete.push(driver.ticket.toString().trim());
                    }
                });

                if (incompleteProcesses.length === 0) {
                    showDiscreetNotification('‚ÑπÔ∏è Nenhum processo em andamento encontrado', 1500);
                    return;
                }

                // ‚úÖ CONFIRMA√á√ÉO FINAL
                if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° prestes a excluir PERMANENTEMENTE ${incompleteProcesses.length} processo(s) em andamento.\n\nEsta a√ß√£o:\n1Ô∏è‚É£ Remover√° os dados do Supabase permanentemente\n2Ô∏è‚É£ Remover√° os dados localmente\n3Ô∏è‚É£ N√ÉO poder√° ser desfeita\n\nDeseja continuar?`)) {
                    return;
                }

                console.log(`üóëÔ∏è Excluindo ${incompleteProcesses.length} processos em andamento permanentemente...`);

                // 1Ô∏è‚É£ Excluir permanentemente do Supabase
                const supabaseDeleted = await deleteFromSupabasePermanently(ticketsToDelete);
                
                if (!supabaseDeleted) {
                    showDiscreetNotification('‚ùå Erro ao excluir processos do Supabase', 2000);
                    return;
                }

                // 2Ô∏è‚É£ Remover dos dados locais
                const newDriversData = driversData.filter(driver => {
                    if (!driver.ticket) return true;
                    return !ticketsToDelete.includes(driver.ticket.toString().trim());
                });

                // 3Ô∏è‚É£ Atualizar currentFileData tamb√©m
                const newCurrentFileData = currentFileData.filter(driver => {
                    if (!driver.ticket) return true;
                    return !ticketsToDelete.includes(driver.ticket.toString().trim());
                });

                // 4Ô∏è‚É£ Atualizar arrays principais
                driversData = newDriversData;
                currentFileData = newCurrentFileData;

                // 5Ô∏è‚É£ Remover do backup de processos
                ticketsToDelete.forEach(ticket => {
                    if (processBackupData[ticket]) {
                        delete processBackupData[ticket];
                    }
                });

                // 6Ô∏è‚É£ Salvar todas as altera√ß√µes
                saveToLocalStorage();
                saveCurrentFileData();
                safeStorage.setItem('processBackupData', JSON.stringify(processBackupData));
                
                dataChangeDetected = true;

                // 7Ô∏è‚É£ Atualizar interface
                if (document.getElementById('encosta-section')?.classList.contains('active')) {
                    invalidateEncostaCache();
                    renderEncostaListOptimized();
                }
                updateInterface();
                
                // 8Ô∏è‚É£ Notificar sucesso
                const message = `‚úÖ ${incompleteProcesses.length} processo(s) em andamento exclu√≠do(s) permanentemente!`;
                showDiscreetNotification(message, 3000);
                
                console.log(`‚úÖ Processos em andamento exclu√≠dos: ${incompleteProcesses.join(', ')}`);

            } catch (error) {
                console.warn('‚ùå Erro fatal ao limpar processos em andamento:', error);
                showDiscreetNotification('‚ùå Erro cr√≠tico ao excluir processos', 2000);
            }
        }

        // ========== FUN√á√ïES DE UPLOAD ========== //
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) processFileImmediately(file);
        }

        function processFileImmediately(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length > 0) processAndSaveData(jsonData, file.name);
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processAndSaveData(data, fileName) {
            if (!data || data.length === 0) {
                showDiscreetNotification('‚ùå Arquivo vazio ou inv√°lido', 2000);
                return;
            }

            const headers = data[0];
            const rows = data.slice(1);
            
            const newDrivers = [];
            const newSuppliers = new Set();
            const newCDs = new Set();
            
            // ‚úÖ CORRE√á√ÉO: CRIAR MAPA DE PROCESSOS EXISTENTES
            const existingProcessesMap = new Map();
            driversData.forEach(driver => {
                if (driver.ticket) {
                    const hasProcessData = (driver.contatoFeito && driver.contatoFeito !== '-') || 
                                         (driver.liberacaoEntregue && driver.liberacaoEntregue !== '-') || 
                                         (driver.encostouDoca && driver.encostouDoca !== '-');
                    
                    if (hasProcessData) {
                        existingProcessesMap.set(driver.ticket.toString().trim(), driver);
                    }
                }
            });
            
            let preservedCount = 0;
            let newCount = 0;
            
            // ‚úÖ NOVO: ATUALIZAR currentFileData COM NOVOS DADOS
            currentFileData = [];
            currentFileName = fileName;
            
            rows.forEach((row) => {
                const driver = {};
                
                headers.forEach((header, colIndex) => {
                    if (header && columnMapping[header]) {
                        let value = row[colIndex];
                        
                        if (value === null || value === undefined) {
                            value = '';
                        }
                        
                        const colunasParaConverter = [
                            'DATA/HORA AGENDA',
                            'DATA/HORA CHEG',  
                            'ACIONADO',
                            'FIM CONF',
                            'INICIO CRIT',
                            'FIM CRIT'
                        ];
                        
                        if (colunasParaConverter.includes(header) && value !== '') {
                            value = convertToDisplayFormat(value);
                        }
                        
                        driver[columnMapping[header]] = value;
                    }
                });
                
                if (driver.ticket) {
                    const ticketKey = driver.ticket.toString().trim();
                    
                    // ‚úÖ ADICIONAR AO currentFileData (PARA ENCOSTA)
                    currentFileData.push({...driver});
                    
                    // ‚úÖ VERIFICAR SE EXISTE PROCESSO PARA ESTA SENHA
                    if (existingProcessesMap.has(ticketKey)) {
                        const existingProcess = existingProcessesMap.get(ticketKey);
                        
                        // ‚úÖ PRESERVAR DADOS DE PROCESSO DO EXISTENTE
                        driver.contatoFeito = existingProcess.contatoFeito || '-';
                        driver.liberacaoEntregue = existingProcess.liberacaoEntregue || '-';
                        driver.encostouDoca = existingProcess.encostouDoca || '-';
                        driver.driverName = existingProcess.driverName || driver.driverName || '-';
                        driver.supplier = existingProcess.supplier || driver.supplier || '-';
                        
                        preservedCount++;
                    } else {
                        // ‚úÖ NOVOS REGISTROS COME√áAM SEM DADOS DE PROCESSO
                        if (!driver.hasOwnProperty('contatoFeito')) driver.contatoFeito = '-';
                        if (!driver.hasOwnProperty('liberacaoEntregue')) driver.liberacaoEntregue = '-';
                        if (!driver.hasOwnProperty('encostouDoca')) driver.encostouDoca = '-';
                        if (!driver.hasOwnProperty('driverName')) driver.driverName = driver.driverName || '-';
                        if (!driver.hasOwnProperty('supplier')) driver.supplier = driver.supplier || '-';
                        
                        newCount++;
                    }
                    
                    newDrivers.push(driver);
                    
                    if (driver.supplier) newSuppliers.add(driver.supplier);
                    if (driver.cd) newCDs.add(driver.cd);
                }
            });
            
            // ‚úÖ ADICIONAR PROCESSOS PRESERVADOS QUE N√ÉO EST√ÉO NO NOVO ARQUIVO
            existingProcessesMap.forEach((existingProcess, ticketKey) => {
                const existsInNewData = newDrivers.some(driver => 
                    driver.ticket && driver.ticket.toString().trim() === ticketKey.toString().trim()
                );
                
                if (!existsInNewData) {
                    // ‚úÖ ADICIONAR PROCESSO COMPLETO
                    newDrivers.push(existingProcess);
                    preservedCount++;
                    console.log(`‚úÖ Processo ${ticketKey} preservado`);
                }
            });
            
            driversData = newDrivers;
            suppliersList = Array.from(newSuppliers);
            cdList = Array.from(newCDs);
            
            // ‚úÖ SALVAR DADOS DA ENCOSTA (currentFileData)
            saveCurrentFileData();
            
            // ‚úÖ SALVAR BACKUP E DADOS GERAIS
            saveProcessBackup();
            saveToLocalStorage();
            
            updateDatabaseStats();
            renderDriversTable();
            
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.value = '';
            
            // ‚úÖ ATUALIZAR INFO DO ARQUIVO
            const cargaFileInfo = document.getElementById('carga-file-info');
            if (cargaFileInfo) {
                cargaFileInfo.textContent = `Arquivo: ${fileName} | ${currentFileData.length} registros`;
            }
            
            showDiscreetNotification(`‚úÖ Base atualizada! ${newCount} novos registros, ${preservedCount} processos preservados`, 1500);
            
            // ‚úÖ ATUALIZAR A ENCOSTA COM OS DADOS DO ARQUIVO ATUAL
            if (document.getElementById('encosta-section')?.classList.contains('active')) {
                invalidateEncostaCache();
                renderEncostaListOptimized();
            }
        }

        // ========== SISTEMA DE TEMAS ========== //
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            currentTheme = themeName;
            
            // Aplicar cores CSS
            document.documentElement.style.setProperty('--primary-color', theme.primary);
            document.documentElement.style.setProperty('--secondary-color', theme.secondary);
            document.documentElement.style.setProperty('--warning-color', theme.warning);
            document.documentElement.style.setProperty('--danger-color', theme.danger);
            document.documentElement.style.setProperty('--info-color', theme.info);
            
            // Atualizar bot√£o ativo
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            const activeOption = document.querySelector(`.theme-option[data-theme="${themeName}"]`);
            if (activeOption) activeOption.classList.add('active');
            
            // Salvar prefer√™ncia
            safeStorage.setItem('selectedTheme', themeName);
            
            showDiscreetNotification(`üé® Tema aplicado!`, 1500);
        }

        function loadTheme() {
            const savedTheme = safeStorage.getItem('selectedTheme');
            if (savedTheme && themes[savedTheme]) {
                applyTheme(savedTheme);
            }
        }

        function toggleThemePanel() {
            const panel = document.getElementById('theme-panel');
            if (panel) panel.classList.toggle('active');
        }

        // ========== ATUALIZA√á√ÉO DA INTERFACE ========== //
        function updateInterfacePartial() {
            const activeSection = document.querySelector('.section.active');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            
            switch(sectionId) {
                case 'encosta-section':
                    renderEncostaListOptimized();
                    break;
                case 'report-section':
                    generateReport();
                    break;
                case 'process-section':
                    if (currentDriver) renderProcessTimeline();
                    break;
                case 'search-section':
                    if (currentDriver) displayDriverInfo(currentDriver);
                    break;
                case 'database-section':
                    updateDatabaseStats();
                    renderDriversTable();
                    break;
            }
        }

        function updateInterface() {
            updateDatabaseStats();
            renderDriversTable();
            
            document.querySelectorAll('.section.active').forEach(section => {
                const sectionId = section.id;
                
                switch(sectionId) {
                    case 'encosta-section':
                        invalidateEncostaCache();
                        renderEncostaListOptimized();
                        break;
                    case 'report-section':
                        generateReport();
                        break;
                    case 'process-section':
                        if (currentDriver) renderProcessTimeline();
                        break;
                    case 'search-section':
                        if (currentDriver) displayDriverInfo(currentDriver);
                        break;
                }
            });
        }

        // ========== FUN√á√ïES DE DADOS INICIAIS ========== //
        function createSampleData() {
            const sampleDrivers = [
                {
                    ticket: '1001',
                    driverName: 'Jo√£o Silva',
                    supplier: 'Transportes ABC',
                    cd: 'CD001',
                    truckPlate: 'ABC1234',
                    status: 'AGENDADO',
                    scheduleDateTime: '15/10/2023 08:30:00',
                    arrivalDateTime: '15/10/2023 08:35:00',
                    load: '26568216',
                    contatoFeito: '-',
                    liberacaoEntregue: '-',
                    encostouDoca: '-'
                },
                {
                    ticket: '1002', 
                    driverName: 'Maria Santos',
                    supplier: 'Log√≠stica XYZ',
                    cd: 'CD002',
                    truckPlate: 'XYZ5678',
                    status: 'AGENDADO',
                    scheduleDateTime: '15/10/2023 09:00:00',
                    arrivalDateTime: '15/10/2023 09:05:00',
                    load: '26555322',
                    contatoFeito: '-',
                    liberacaoEntregue: '-',
                    encostouDoca: '-'
                }
            ];
            
            driversData = sampleDrivers;
            suppliersList = ['Transportes ABC', 'Log√≠stica XYZ'];
            cdList = ['CD001', 'CD002'];
        }

        // ========== INICIALIZA√á√ÉO ========== //
        async function initializeData() {
            console.log('üìÅ Inicializando sistema otimizado...');
            
            // Carregar dados locais primeiro
            const hasLocalData = loadFromLocalStorage();
            
            if (hasLocalData && driversData.length > 0) {
                console.log(`‚úÖ ${driversData.length} registros carregados do localStorage`);
            } else {
                console.log('üìã Nenhum dado no localStorage, criando dados de exemplo...');
                createSampleData();
            }
            
            // ‚úÖ CARREGAR DADOS DA ENCOSTA (PERSISTENTES)
            loadCurrentFileData();
            console.log(`‚úÖ ${currentFileData.length} registros da encosta carregados`);

            // Carregar dados de carga
            loadCargaData();
            console.log(`‚úÖ ${cargaData.size} cargas carregadas`);

            // Carregar backup de processos
            loadProcessBackup();
            console.log(`‚úÖ Backup de ${Object.keys(processBackupData).length} processos carregado`);

            // Restaurar processos do backup
            const restoredCount = restoreProcessBackup();
            if (restoredCount > 0) {
                console.log(`‚úÖ ${restoredCount} processos restaurados do backup`);
            }

            // Testar conex√£o Supabase
            const supabaseConnected = await testSupabaseConnection();
            
            if (supabaseConnected) {
                console.log('üîÑ Sincronizando processos com Supabase...');
                // ‚úÖ CORRE√á√ÉO: CARREGAR APENAS PROCESSOS DO SUPABASE
                await loadProcessesFromSupabase();
                
                // Iniciar sincroniza√ß√£o em tempo real (apenas processos)
                await startRealtimeSync();
                
            } else {
                console.log('üìÅ Supabase offline, usando dados locais...');
            }

            // Inicializar cache de performance
            processStatusCache.clear();
            encostaSortedCache = null;
            encostaCacheTimestamp = 0;

            // Iniciar sistema de persist√™ncia
            initializePersistenceSystem();
            
            // Atualizar interface
            updateInterface();
            setupEventListeners();
            
            // Carregar tema
            loadTheme();
            
            // Carregar filtros salvos
            if (loadFilterValues()) {
                applyFilters();
            }
            
            console.log('‚úÖ Sistema inicializado com sucesso!');
        }

        // ========== CONFIGURA√á√ÉO DE EVENT LISTENERS ========== //
        function setupEventListeners() {
            // ‚úÖ CORRE√á√ÉO: Usar event delegation para navega√ß√£o
            document.addEventListener('click', function(e) {
                // Navega√ß√£o entre se√ß√µes
                if (e.target.closest('.nav-link')) {
                    e.preventDefault();
                    const link = e.target.closest('.nav-link');
                    const target = link.getAttribute('data-target');
                    if (target) showSection(target);
                }
                
                // Tabs internas
                if (e.target.closest('.tab')) {
                    const tab = e.target.closest('.tab');
                    const tabId = tab.getAttribute('data-tab');
                    if (tabId) showTab(tabId);
                }
                
                // Bot√µes de processo na encosta
                if (e.target.closest('.processo-encosta')) {
                    const btn = e.target.closest('.processo-encosta');
                    const ticket = btn.getAttribute('data-ticket');
                    if (ticket) {
                        processStatusCache.delete(ticket);
                        goToProcessFromEncosta(ticket);
                    }
                }
            });
            
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const ticket = document.getElementById('ticket-input').value.trim();
                    if (ticket) searchDriver(ticket);
                });
            }
            
            const goToProcessBtn = document.getElementById('go-to-process');
            if (goToProcessBtn) {
                goToProcessBtn.addEventListener('click', function() {
                    showSection('process-section');
                    renderProcessTimeline();
                });
            }
            
            const reportGenerateBtn = document.getElementById('report-generate');
            if (reportGenerateBtn) reportGenerateBtn.addEventListener('click', generateReport);
            
            const reportExportBtn = document.getElementById('report-export-excel');
            if (reportExportBtn) reportExportBtn.addEventListener('click', exportReportToExcel);
            
            const reportClearBtn = document.getElementById('report-clear-filters');
            if (reportClearBtn) reportClearBtn.addEventListener('click', clearReportFilters);
            
            const forceSyncBtn1 = document.getElementById('force-sync-btn');
            const forceSyncBtn2 = document.getElementById('force-sync-btn-2');
            
            if (forceSyncBtn1) forceSyncBtn1.addEventListener('click', forceSync);
            if (forceSyncBtn2) forceSyncBtn2.addEventListener('click', forceSync);
            
            const clearAllProcessesBtn = document.getElementById('clear-all-processes');
            if (clearAllProcessesBtn) clearAllProcessesBtn.addEventListener('click', clearAllProcesses);
            
            const clearIncompleteProcessesBtn = document.getElementById('clear-incomplete-processes');
            if (clearIncompleteProcessesBtn) clearIncompleteProcessesBtn.addEventListener('click', clearIncompleteProcesses);
            
            const confirmPasswordBtn = document.getElementById('confirm-password');
            const cancelPasswordBtn = document.getElementById('cancel-password');
            const passwordInput = document.getElementById('password-input');
            
            if (confirmPasswordBtn) {
                confirmPasswordBtn.addEventListener('click', function() {
                    if (verifyPassword()) {
                        executePendingAction();
                    }
                });
            }
            
            if (cancelPasswordBtn) {
                cancelPasswordBtn.addEventListener('click', hidePasswordModal);
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        if (verifyPassword()) {
                            executePendingAction();
                        }
                    }
                });
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', function() {
                    fileInput.click();
                });
                fileInput.addEventListener('change', handleFileUpload);
            }
            
            const uploadCargaBtn = document.getElementById('upload-carga-btn');
            const cargaFileInput = document.getElementById('carga-file-input');
            if (uploadCargaBtn && cargaFileInput) {
                uploadCargaBtn.addEventListener('click', function() {
                    cargaFileInput.click();
                });
                
                cargaFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        currentCargaFile = file;
                        handleCargaFileUpload(file);
                    }
                });
            }
            
            const refreshCargaBtn = document.getElementById('refresh-carga-btn');
            if (refreshCargaBtn) {
                refreshCargaBtn.addEventListener('click', function() {
                    if (currentCargaFile) {
                        handleCargaFileUpload(currentCargaFile);
                    } else {
                        alert('‚ÑπÔ∏è Nenhum arquivo de carga carregado. Por favor, carregue um arquivo TXT primeiro.');
                    }
                });
            }
            
            const debugCargaBtn = document.getElementById('debug-carga-btn');
            if (debugCargaBtn) {
                debugCargaBtn.addEventListener('click', function() {
                    const ticket = prompt("Digite a senha para verificar o status da carga:");
                    if (ticket) {
                        debugCargaStatus(ticket);
                    }
                });
            }
            
            const uploadArea = document.getElementById('upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', function() {
                    this.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) processFileImmediately(files[0]);
                });
            }
            
            const resetDriversBtn = document.getElementById('reset-drivers-btn');
            if (resetDriversBtn) {
                resetDriversBtn.addEventListener('click', function() {
                    document.querySelectorAll('.filtro-input').forEach(input => input.value = '');
                    
                    activeFilters = {
                        ticket: '', driver: '', supplier: '', status: '', plate: '', arrival: ''
                    };
                    
                    safeStorage.removeItem('activeFilters');
                    
                    renderDriversTable();
                    
                    updateResultsInfo(driversData.length);
                });
            }
            
            const clearDatabaseBtn = document.getElementById('clear-database-btn');
            if (clearDatabaseBtn) clearDatabaseBtn.addEventListener('click', clearDatabase);
            
            // ========== EVENT LISTENERS PARA VISUALIZA√á√ÉO DA ENCOSTA ========== //
            const viewTableBtn = document.getElementById('view-table-btn');
            const viewCardsBtn = document.getElementById('view-cards-btn');
            
            if (viewTableBtn) {
                viewTableBtn.addEventListener('click', function() {
                    encostaViewMode = 'table';
                    viewTableBtn.classList.add('active');
                    if (viewCardsBtn) viewCardsBtn.classList.remove('active');
                    invalidateEncostaCache();
                    renderEncostaListOptimized();
                });
            }
            
            if (viewCardsBtn) {
                viewCardsBtn.addEventListener('click', function() {
                    encostaViewMode = 'cards';
                    viewCardsBtn.classList.add('active');
                    if (viewTableBtn) viewTableBtn.classList.remove('active');
                    invalidateEncostaCache();
                    renderEncostaListOptimized();
                });
            }
            
            // ========== EVENT LISTENERS PARA SISTEMA DE TEMAS ========== //
            const themeToggle = document.getElementById('theme-toggle');
            const themePanel = document.getElementById('theme-panel');
            
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleThemePanel);
            }
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const themeName = this.getAttribute('data-theme');
                    applyTheme(themeName);
                    toggleThemePanel();
                });
            });
            
            // Fechar painel de temas ao clicar fora
            document.addEventListener('click', function(e) {
                if (themeToggle && !themeToggle.contains(e.target) && themePanel && !themePanel.contains(e.target)) {
                    themePanel.classList.remove('active');
                }
            });
            
            // Configurar delega√ß√£o de eventos para bot√µes na tabela de motoristas
            document.addEventListener('click', function(e) {
                if (e.target.closest('.view-driver')) {
                    const btn = e.target.closest('.view-driver');
                    const ticket = btn.getAttribute('data-ticket');
                    if (ticket) {
                        searchDriver(ticket);
                        showSection('search-section');
                    }
                }
                
                if (e.target.closest('.delete-driver')) {
                    const btn = e.target.closest('.delete-driver');
                    const ticket = btn.getAttribute('data-ticket');
                    if (ticket) {
                        deleteDriver(ticket);
                    }
                }
            });
            
            // Configurar filtros
            let filterTimeout;
            
            function debouncedApplyFilters() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            }
            
            const filterTicket = document.getElementById('filter-ticket');
            const filterDriver = document.getElementById('filter-driver');
            const filterSupplier = document.getElementById('filter-supplier');
            const filterStatus = document.getElementById('filter-status');
            const filterPlate = document.getElementById('filter-plate');
            const filterArrival = document.getElementById('filter-arrival');
            
            if (filterTicket) {
                filterTicket.addEventListener('input', function() {
                    activeFilters.ticket = this.value.trim().toLowerCase();
                    debouncedApplyFilters();
                });
            }
            
            if (filterDriver) {
                filterDriver.addEventListener('input', function() {
                    activeFilters.driver = this.value.trim().toLowerCase();
                    debouncedApplyFilters();
                });
            }
            
            if (filterSupplier) {
                filterSupplier.addEventListener('input', function() {
                    activeFilters.supplier = this.value.trim().toLowerCase();
                    debouncedApplyFilters();
                });
            }
            
            if (filterStatus) {
                filterStatus.addEventListener('input', function() {
                    activeFilters.status = this.value.trim().toLowerCase();
                    debouncedApplyFilters();
                });
            }
            
            if (filterPlate) {
                filterPlate.addEventListener('input', function() {
                    activeFilters.plate = this.value.trim().toLowerCase();
                    debouncedApplyFilters();
                });
            }
            
            if (filterArrival) {
                filterArrival.addEventListener('input', function() {
                    activeFilters.arrival = this.value.trim().toLowerCase();
                    debouncedApplyFilters();
                });
            }
        }

        // ========== INICIALIZA√á√ÉO DO SISTEMA ========== //
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema Controlla carregando...');
            initializeData().catch(error => {
                console.error('‚ùå Erro fatal na inicializa√ß√£o:', error);
                showDiscreetNotification('‚ùå Erro cr√≠tico ao carregar o sistema', 2000);
            });
        });

        window.addEventListener('beforeunload', () => {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
            }
            // Salvar dados finais
            if (dataChangeDetected) {
                saveToLocalStorage();
                saveProcessBackup();
                saveCurrentFileData();
            }
        });
    </script>
</body>
</html>
